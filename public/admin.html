<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container-fluid">
            <span class="navbar-brand">üë®‚Äçüíº Admin Dashboard</span>
            <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted">Total Students</h6>
                        <h2 id="totalStudents">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted">Active Students</h6>
                        <h2 id="activeStudents">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <button class="nav-link active" onclick="showTab('students')">Students</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" onclick="showTab('users')">Users</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" onclick="showTab('attendance')">Attendance Report</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" onclick="showTab('dailywork')">Daily Work</button>
            </li>
        </ul>

        <div id="studentsTab">
            <button class="btn btn-primary mb-3" onclick="showAddStudentModal()">Add Student</button>
            
            <!-- Region and Batch Filters -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label>Region</label>
                            <select class="form-select" id="filterRegion" onchange="loadFilterBatches()">
                                <option value="">Select Region</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label>Batch</label>
                            <select class="form-select" id="filterBatch" onchange="loadStudents()">
                                <option value="">Select Batch</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label>&nbsp;</label>
                            <button class="btn btn-secondary w-100" onclick="resetStudentFilters()">Reset Filters</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="studentsList"></div>
        </div>

        <div id="usersTab" style="display: none;">
            <button class="btn btn-primary mb-3" onclick="showAddUserModal()">Add User</button>
            <div id="usersList"></div>
        </div>

        <div id="attendanceTab" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">üìä Attendance Report (Summary)</h5>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-2">
                            <label>Region</label>
                            <select class="form-select" id="attRegion" onchange="loadAttBatches()">
                                <option value="">Select Region</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label>Batch</label>
                            <select class="form-select" id="attBatch">
                                <option value="">Select Batch</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label>Filter Type</label>
                            <select class="form-select" id="attFilterType" onchange="updateAttFilterUI()">
                                <option value="date-range">Date Range</option>
                                <option value="month">Month</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label id="attDateLabel">Start Date</label>
                            <input type="date" class="form-control" id="attStartDate">
                        </div>
                        <div class="col-md-2">
                            <label id="attEndLabel">End Date</label>
                            <input type="date" class="form-control" id="attEndDate">
                        </div>
                        <div class="col-md-2">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="loadAttendanceReport()">Generate Report</button>
                        </div>
                    </div>

                    <div id="attendanceResults"></div>
                </div>
            </div>
        </div>

        <div id="dailyWorkTab" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">üìù Daily Work (All Teachers)</h5>

                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label>Teacher</label>
                            <select class="form-select" id="adminWorkTeacher">
                                <option value="">All Teachers</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Filter Type</label>
                            <select class="form-select" id="adminWorkFilterType" onchange="updateAdminWorkFilterUI()">
                                <option value="date">Date</option>
                                <option value="month">Month</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label id="adminWorkDateLabel">Date</label>
                            <input type="date" class="form-control" id="adminWorkDate">
                        </div>
                        <div class="col-md-2">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="loadAdminWorkReports()">View Reports</button>
                        </div>
                    </div>

                    <div id="adminWorkResults"></div>
                </div>
            </div>
        </div>

    <!-- Add Student Modal -->
    <div class="modal" id="studentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Add Student</h5>
                    <button type="button" class="btn-close" onclick="closeModal('studentModal')"></button>
                </div>
                <div class="modal-body">
                    <form id="studentForm">
                        <input type="text" class="form-control mb-2" placeholder="Name" id="sName" required>
                        <input type="text" class="form-control mb-2" placeholder="Region" id="sRegion" required>
                        <input type="text" class="form-control mb-2" placeholder="School Name" id="sSchool" required>
                        <input type="number" class="form-control mb-2" placeholder="Age" id="sAge">
                        <input type="text" class="form-control mb-2" placeholder="Mobile" id="sMobile" required>
                        <input type="text" class="form-control mb-2" placeholder="Standard/Class" id="sStandard">
                        <input type="text" class="form-control mb-2" placeholder="Batch Number" id="sBatch" required>
                        <button type="submit" class="btn btn-success">Add Student</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal" id="editStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Edit Student</h5>
                    <button type="button" class="btn-close" onclick="closeModal('editStudentModal')"></button>
                </div>
                <div class="modal-body">
                    <form id="editStudentForm">
                        <input type="hidden" id="editStudentId">
                        <input type="text" class="form-control mb-2" placeholder="Name" id="editSName" required>
                        <input type="text" class="form-control mb-2" placeholder="Region" id="editSRegion" required>
                        <input type="text" class="form-control mb-2" placeholder="School Name" id="editSSchool" required>
                        <input type="number" class="form-control mb-2" placeholder="Age" id="editSAge">
                        <input type="text" class="form-control mb-2" placeholder="Mobile" id="editSMobile" required>
                        <input type="text" class="form-control mb-2" placeholder="Standard/Class" id="editSStandard">
                        <input type="text" class="form-control mb-2" placeholder="Batch Number" id="editSBatch" required>
                        <button type="submit" class="btn btn-primary">Update Student</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Add Teacher/Admin</h5>
                    <button type="button" class="btn-close" onclick="closeModal('userModal')"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="text" class="form-control mb-2" placeholder="Name" id="uName" required>
                        <input type="email" class="form-control mb-2" placeholder="Email" id="uEmail" required>
                        <input type="password" class="form-control mb-2" placeholder="Password" id="uPass" required>
                        <select class="form-select mb-2" id="uRole" required>
                            <option value="teacher">Teacher</option>
                            <option value="admin">Admin</option>
                        </select>
                        <button type="submit" class="btn btn-success">Add User</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (!token || !user.role) {
            localStorage.clear();
            window.location.href = '/';
        }
        if (user.role !== 'admin') {
            alert('Admin access required. Please login with an admin account.');
            localStorage.clear();
            window.location.href = '/';
        }

        function showTab(tab) {
            if (tab === 'students') {
                document.getElementById('studentsTab').style.display = 'block';
                document.getElementById('usersTab').style.display = 'none';
                document.getElementById('attendanceTab').style.display = 'none';
                document.getElementById('dailyWorkTab').style.display = 'none';
                loadFilterRegions();
            } else if (tab === 'users') {
                document.getElementById('studentsTab').style.display = 'none';
                document.getElementById('usersTab').style.display = 'block';
                document.getElementById('attendanceTab').style.display = 'none';
                document.getElementById('dailyWorkTab').style.display = 'none';
            } else if (tab === 'attendance') {
                document.getElementById('studentsTab').style.display = 'none';
                document.getElementById('usersTab').style.display = 'none';
                document.getElementById('attendanceTab').style.display = 'block';
                document.getElementById('dailyWorkTab').style.display = 'none';
                loadAttRegions();
            } else if (tab === 'dailywork') {
                document.getElementById('studentsTab').style.display = 'none';
                document.getElementById('usersTab').style.display = 'none';
                document.getElementById('attendanceTab').style.display = 'none';
                document.getElementById('dailyWorkTab').style.display = 'block';
            }
        }

        function showAddStudentModal() {
            new bootstrap.Modal(document.getElementById('studentModal')).show();
        }

        function showAddUserModal() {
            new bootstrap.Modal(document.getElementById('userModal')).show();
        }

        function closeModal(id) {
            bootstrap.Modal.getInstance(document.getElementById(id)).hide();
        }

        async function loadStats() {
            const res = await fetch('/api/students/stats/dashboard', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            document.getElementById('totalStudents').textContent = data.total;
            document.getElementById('activeStudents').textContent = data.active;
        }

        async function loadStudents() {
            const region = document.getElementById('filterRegion').value;
            const batch = document.getElementById('filterBatch').value;
            
            let url = '/api/students';
            const params = new URLSearchParams();
            if (region) params.append('region', region);
            if (batch) params.append('batchNumber', batch);
            if (params.toString()) url += '?' + params.toString();
            
            const res = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const students = await res.json();
            
            let html = '<table class="table"><thead><tr><th>Name</th><th>Region</th><th>School</th><th>Batch</th><th>Mobile</th><th>Actions</th></tr></thead><tbody>';
            students.forEach(s => {
                html += `<tr>
                    <td>${s.name}</td>
                    <td>${s.region}</td>
                    <td>${s.schoolName || '-'}</td>
                    <td>${s.batchNumber}</td>
                    <td>${s.mobile || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editStudent('${s._id}', '${s.name}', '${s.region}', '${s.schoolName || ''}', '${s.mobile || ''}', '${s.age || ''}', '${s.standard || ''}', '${s.batchNumber}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStudent('${s._id}')">Delete</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('studentsList').innerHTML = html;
        }

        async function loadUsers() {
            const res = await fetch('/api/users', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const users = await res.json();
            
            let html = '<table class="table"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr></thead><tbody>';
            users.forEach(u => {
                html += `<tr>
                    <td>${u.name}</td>
                    <td>${u.email}</td>
                    <td>${u.role}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="deleteUser('${u._id}')">Delete</button></td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('usersList').innerHTML = html;
        }

        document.getElementById('studentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('sName').value,
                region: document.getElementById('sRegion').value,
                schoolName: document.getElementById('sSchool').value,
                age: document.getElementById('sAge').value,
                mobile: document.getElementById('sMobile').value,
                standard: document.getElementById('sStandard').value,
                batchNumber: document.getElementById('sBatch').value
            };
            
            const res = await fetch('/api/students', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                alert('Student added successfully!');
                closeModal('studentModal');
                e.target.reset();
                loadStudents();
                loadStats();
            } else {
                let errorMessage = 'Unknown error';
                try {
                    const error = await res.json();
                    errorMessage = error.message || errorMessage;
                } catch (e2) {
                    // ignore JSON parse error
                }
                if (res.status === 403) {
                    errorMessage = `Admin only. You are logged in as: ${user.role || 'unknown'}`;
                }
                alert('Error adding student: ' + errorMessage);
            }
        });

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('uName').value,
                email: document.getElementById('uEmail').value,
                password: document.getElementById('uPass').value,
                role: document.getElementById('uRole').value
            };
            
            const res = await fetch('/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                alert('User added successfully!');
                closeModal('userModal');
                e.target.reset();
                loadUsers();
            } else {
                alert('Error adding user');
            }
        });

        // Edit Student Functions
        function editStudent(id, name, region, school, mobile, age, standard, batch) {
            document.getElementById('editStudentId').value = id;
            document.getElementById('editSName').value = name;
            document.getElementById('editSRegion').value = region;
            document.getElementById('editSSchool').value = school;
            document.getElementById('editSMobile').value = mobile;
            document.getElementById('editSAge').value = age;
            document.getElementById('editSStandard').value = standard;
            document.getElementById('editSBatch').value = batch;
            new bootstrap.Modal(document.getElementById('editStudentModal')).show();
        }

        document.getElementById('editStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editStudentId').value;
            const data = {
                name: document.getElementById('editSName').value,
                region: document.getElementById('editSRegion').value,
                schoolName: document.getElementById('editSSchool').value,
                age: document.getElementById('editSAge').value,
                mobile: document.getElementById('editSMobile').value,
                standard: document.getElementById('editSStandard').value,
                batchNumber: document.getElementById('editSBatch').value
            };
            
            const res = await fetch(`/api/students/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                alert('Student updated successfully!');
                closeModal('editStudentModal');
                e.target.reset();
                loadStudents();
                loadStats();
            } else {
                const error = await res.json();
                alert('Error updating student: ' + (error.message || 'Unknown error'));
            }
        });

        async function deleteStudent(id) {
            if (!confirm('Delete this student?')) return;
            await fetch(`/api/students/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            loadStudents();
            loadStats();
        }

        async function deleteUser(id) {
            if (!confirm('Delete this user?')) return;
            await fetch(`/api/users/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            loadUsers();
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }

        // ===== STUDENT FILTER FUNCTIONS =====
        async function loadFilterRegions() {
            const res = await fetch('/api/students/regions/all', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const regions = await res.json();
            const select = document.getElementById('filterRegion');
            select.innerHTML = '<option value="">Select Region</option>';
            regions.forEach(r => {
                select.innerHTML += `<option value="${r}">${r}</option>`;
            });
        }

        async function loadFilterBatches() {
            const region = document.getElementById('filterRegion').value;
            if (!region) {
                document.getElementById('filterBatch').innerHTML = '<option value="">Select Batch</option>';
                loadStudents();
                return;
            }
            
            const res = await fetch(`/api/students/batches/${region}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const batches = await res.json();
            const select = document.getElementById('filterBatch');
            select.innerHTML = '<option value="">Select Batch</option>';
            batches.forEach(b => {
                select.innerHTML += `<option value="${b}">${b}</option>`;
            });
            loadStudents();
        }

        function resetStudentFilters() {
            document.getElementById('filterRegion').value = '';
            document.getElementById('filterBatch').value = '';
            loadStudents();
        }

        // ===== ATTENDANCE FUNCTIONS =====
        async function loadAttRegions() {
            const res = await fetch('/api/students/regions/all', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const regions = await res.json();
            const select = document.getElementById('attRegion');
            select.innerHTML = '<option value="">Select Region</option>';
            regions.forEach(r => {
                select.innerHTML += `<option value="${r}">${r}</option>`;
            });
        }

        async function loadAdminWorkTeachers() {
            const res = await fetch('/api/users', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const users = await res.json();
            const select = document.getElementById('adminWorkTeacher');
            if (!select) return;
            select.innerHTML = '<option value="">All Teachers</option>';
            users
                .filter(u => u.role === 'teacher')
                .forEach(u => {
                    select.innerHTML += `<option value="${u._id}">${u.name}</option>`;
                });
        }

        async function loadAdminWorkReports() {
            const filterType = document.getElementById('adminWorkFilterType').value;
            const dateInput = document.getElementById('adminWorkDate').value;
            const teacherId = document.getElementById('adminWorkTeacher').value;

            if (!dateInput) {
                alert('Please select date/month');
                return;
            }

            const params = new URLSearchParams();
            if (teacherId) {
                params.append('teacherId', teacherId);
            }
            if (filterType === 'month') {
                const [year, month] = dateInput.split('-');
                const startDate = `${year}-${month}-01`;
                const lastDay = new Date(year, month, 0).getDate();
                const endDate = `${year}-${month}-${lastDay}`;
                params.append('startDate', startDate);
                params.append('endDate', endDate);
            } else {
                params.append('date', dateInput);
            }

            const res = await fetch(`/api/workReport?${params.toString()}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!res.ok) {
                alert('Failed to load reports');
                return;
            }

            const reports = await res.json();
            if (!reports || reports.length === 0) {
                document.getElementById('adminWorkResults').innerHTML =
                    '<div class="alert alert-warning">No reports found for the selected filters</div>';
                return;
            }

            let html = `
                <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Date</th>
                            <th>Teacher</th>
                            <th>Topics Taught</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            reports.forEach((report, index) => {
                const reportDate = new Date(report.date).toISOString().split('T')[0];
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${reportDate}</td>
                        <td>${report.teacherName || '-'}</td>
                        <td>${report.topicsCovered}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
                </div>
            `;

            document.getElementById('adminWorkResults').innerHTML = html;
        }

        updateAdminWorkFilterUI();
        loadAdminWorkTeachers();

        function updateAdminWorkFilterUI() {
            const filterType = document.getElementById('adminWorkFilterType').value;
            const dateLabel = document.getElementById('adminWorkDateLabel');
            const dateInput = document.getElementById('adminWorkDate');

            if (filterType === 'month') {
                dateLabel.textContent = 'Month';
                dateInput.type = 'month';
                dateInput.value = new Date().toISOString().slice(0, 7);
            } else {
                dateLabel.textContent = 'Date';
                dateInput.type = 'date';
                dateInput.value = new Date().toISOString().split('T')[0];
            }
        }

        async function loadAttSchools() {
            const res = await fetch('/api/students/schools', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const schools = await res.json();
            const select = document.getElementById('attSchool');
            select.innerHTML = '<option value="">Select School</option>';
            schools.forEach(s => {
                select.innerHTML += `<option value="${s}">${s}</option>`;
            });
        }

        async function loadAttBatches() {
            const region = document.getElementById('attRegion').value;
            if (!region) {
                document.getElementById('attBatch').innerHTML = '<option value="">Select Batch</option>';
                return;
            }
            
            const res = await fetch(`/api/students/batches/${region}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const batches = await res.json();
            const select = document.getElementById('attBatch');
            select.innerHTML = '<option value="">Select Batch</option>';
            batches.forEach(b => {
                select.innerHTML += `<option value="${b}">${b}</option>`;
            });
        }

        function updateAttFilterUI() {
            const filterType = document.getElementById('attFilterType').value;
            const dateLabel = document.getElementById('attDateLabel');
            const endLabel = document.getElementById('attEndLabel');
            const startInput = document.getElementById('attStartDate');
            const endInput = document.getElementById('attEndDate');

            if (filterType === 'month') {
                dateLabel.textContent = 'Year-Month';
                endLabel.textContent = '';
                startInput.type = 'month';
                startInput.value = new Date().toISOString().slice(0, 7);
                endInput.style.display = 'none';
            } else {
                dateLabel.textContent = 'Start Date';
                endLabel.textContent = 'End Date';
                startInput.type = 'date';
                startInput.value = new Date().toISOString().split('T')[0];
                endInput.style.display = 'block';
                endInput.type = 'date';
                endInput.value = new Date().toISOString().split('T')[0];
            }
        }

        async function loadAttendanceReport() {
            const region = document.getElementById('attRegion').value;
            const batch = document.getElementById('attBatch').value;
            const filterType = document.getElementById('attFilterType').value;
            let startDate = document.getElementById('attStartDate').value;
            let endDate = document.getElementById('attEndDate').value;

            if (!region || !batch || !startDate) {
                alert('Please select region, batch, and date(s)');
                return;
            }

            // Convert month format to date range if needed
            if (filterType === 'month') {
                const [year, month] = startDate.split('-');
                startDate = `${year}-${month}-01`;
                // Get last day of month
                const lastDay = new Date(year, month, 0).getDate();
                endDate = `${year}-${month}-${lastDay}`;
            } else {
                if (!endDate) {
                    alert('Please select end date');
                    return;
                }
            }

            try {
                const res = await fetch(
                    `/api/attendance/summary?region=${encodeURIComponent(region)}&batchNumber=${encodeURIComponent(batch)}&startDate=${startDate}&endDate=${endDate}&filterType=${filterType}`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );

                const data = await res.json();

                if (!data.summary || data.summary.length === 0) {
                    document.getElementById('attendanceResults').innerHTML = 
                        '<div class="alert alert-warning">No attendance records found for the selected period</div>';
                    return;
                }

                const stats = data.stats;
                let html = `
                    <div class="alert alert-info">
                        <h6>üìä Summary Statistics</h6>
                        <div class="row">
                            <div class="col-md-3"><strong>Total Classes:</strong> ${stats.totalClasses}</div>
                            <div class="col-md-3"><strong>Total Students:</strong> ${stats.totalStudents}</div>
                            <div class="col-md-3"><strong>Total Present:</strong> <span class="badge bg-success">${stats.totalPresent}</span></div>
                            <div class="col-md-3"><strong>Total Absent:</strong> <span class="badge bg-danger">${stats.totalAbsent}</span></div>
                        </div>
                        <p class="mt-2 mb-0"><strong>Period:</strong> ${stats.dateRange.start} to ${stats.dateRange.end}</p>
                    </div>

                    <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Student Name</th>
                                <th class="text-center">Total Classes</th>
                                <th class="text-center">Marked</th>
                                <th class="text-center">Present</th>
                                <th class="text-center">Absent</th>
                                <th class="text-center">Attendance %</th>
                                <th>Marked By</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.summary.forEach(student => {
                    const percentage = parseFloat(student.percentage);
                    let percentBadge = 'bg-danger';
                    if (percentage >= 75) {
                        percentBadge = 'bg-success';
                    } else if (percentage >= 50) {
                        percentBadge = 'bg-warning';
                    }

                    const markedBy = student.markedBy || '-';

                    html += `
                        <tr>
                            <td>${student.name}</td>
                            <td class="text-center"><strong>${student.totalClasses}</strong></td>
                            <td class="text-center">${student.totalMarked}/${student.totalClasses}</td>
                            <td class="text-center"><span class="badge bg-success">${student.present}</span></td>
                            <td class="text-center"><span class="badge bg-danger">${student.absent}</span></td>
                            <td class="text-center"><span class="badge ${percentBadge}">${student.percentage}%</span></td>
                            <td>${markedBy}</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                    </div>
                    <button class="btn btn-secondary mt-3" onclick="printAttReport()">üñ®Ô∏è Print Report</button>
                `;

                document.getElementById('attendanceResults').innerHTML = html;

            } catch (error) {
                console.error('Error loading report:', error);
                alert('Failed to load report');
            }
        }

        function printAttReport() {
            window.print();
        }

        loadStats();
        loadUsers();
        updateAttFilterUI();
    </script>
</body>
</html>
