<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(180deg, #f7f9fc 0%, #eef3f8 100%);
        }

        .card {
            background-color: #ffffff;
            border-color: #e6eef5;
            box-shadow: 0 10px 24px rgba(22, 42, 60, 0.08);
        }

        .nav-tabs {
            border-bottom: 0;
            gap: 10px;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 6px;
        }

        .nav-tabs::-webkit-scrollbar {
            height: 6px;
        }

        .nav-tabs::-webkit-scrollbar-thumb {
            background: rgba(15, 127, 126, 0.2);
            border-radius: 999px;
        }

        .nav-tabs .nav-link {
            border: 0;
            border-radius: 999px;
            background: #f2f6fb;
            color: #42526b;
            font-weight: 600;
            padding: 10px 16px;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .nav-tabs .nav-link:hover {
            background: rgba(14, 165, 164, 0.12);
            color: #0b7f7e;
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #0ea5a4 0%, #12c2b9 100%);
            color: #ffffff;
            box-shadow: 0 10px 20px rgba(14, 165, 164, 0.25);
        }

        @media (max-width: 768px) {
            .nav-tabs {
                gap: 8px;
                flex-wrap: wrap;
                overflow-x: visible;
            }

            .nav-tabs .nav-link {
                font-size: 13px;
                padding: 8px 12px;
            }

            .tabs-hint {
                display: block;
            }
        }

        .tabs-hint {
            display: none;
            font-size: 12px;
            color: #6b7b91;
            margin: -6px 0 14px;
            text-align: center;
        }

        .dashboard-footer {
            margin-top: auto;
            padding: 16px 0 22px;
            text-align: center;
            color: #4b5a70;
            font-size: 13px;
        }

        .dashboard-footer span {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 999px;
            background: rgba(14, 165, 164, 0.1);
            color: #0b7f7e;
            font-weight: 600;
            letter-spacing: 0.4px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container-fluid">
            <span class="navbar-brand">üë®‚Äçüíº Admin Dashboard</span>
            <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted">Total Students</h6>
                        <h2 id="totalStudents">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted">Active Students</h6>
                        <h2 id="activeStudents">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted">Inactive Students</h6>
                        <h2 id="inactiveStudents">0</h2>
                    </div>
                </div>
            </div>
        </div>
        

        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <button class="nav-link active" onclick="showTab('students')">Students</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" onclick="showTab('users')">Users</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" onclick="showTab('markattendance')">Mark Attendance</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" onclick="showTab('viewdaily')">View Daily</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" onclick="showTab('whatsapp')">Send WhatsApp Invite</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" onclick="showTab('attendance')">Attendance Report</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" onclick="showTab('dailywork')">Daily Work</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" onclick="showTab('backup')">Backup/Restore</button>
            </li>
        </ul>
        <div class="tabs-hint">All tabs are visible on mobile ‚Äî tap any section below.</div>

        <div id="studentsTab">
            <button class="btn btn-primary mb-3" onclick="showAddStudentModal()">Add Student</button>
            
            <!-- Region and Batch Filters -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label>Region</label>
                            <select class="form-select" id="filterRegion" onchange="loadFilterBatches()">
                                <option value="">Select Region</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Batch</label>
                            <select class="form-select" id="filterBatch" onchange="loadStudents()">
                                <option value="">Select Batch</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Quick Search</label>
                            <input type="text" class="form-control" id="filterSearch" placeholder="Name, Mobile, ID" oninput="loadStudents()">
                        </div>
                        <div class="col-md-3">
                            <label>&nbsp;</label>
                            <button class="btn btn-secondary w-100" onclick="resetStudentFilters()">Reset Filters</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bulk Import/Export -->
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="mb-3">Bulk Import / Export (CSV)</h6>
                    <div class="row g-3 align-items-end">
                        <div class="col-md-5">
                            <label>Import Students CSV</label>
                            <input type="file" class="form-control" id="studentsCsvFile" accept=".csv">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-success w-100" onclick="importStudentsCsv()">Import CSV</button>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-primary w-100" onclick="exportStudentsCsv()">Export CSV</button>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100" onclick="exportStudentsJson()">Export JSON</button>
                        </div>
                    </div>
                    <div id="importResult" class="mt-3"></div>
                    <p class="text-muted mt-2 mb-0" style="font-size: 12px;">
                        CSV headers supported: name, region, schoolName, standard, batchNumber, mobile, age.
                    </p>
                </div>
            </div>

            <div id="studentsList"></div>
        </div>

        <div id="usersTab" style="display: none;">
            <button class="btn btn-primary mb-3" onclick="showAddUserModal()">Add User</button>
            <div id="usersList"></div>
        </div>

        <div id="markAttendanceTab" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Mark Attendance (Admin)</h5>

                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label>Region</label>
                            <select class="form-select" id="adminMarkRegion" onchange="loadAdminMarkBatches()">
                                <option value="">Select Region</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Batch</label>
                            <select class="form-select" id="adminMarkBatch" onchange="loadAdminMarkStudents()">
                                <option value="">Select Batch</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Date</label>
                            <input type="date" class="form-control" id="adminMarkDate" required onchange="loadAdminMarkStudents()">
                        </div>
                    </div>

                    <div id="adminSavingBanner" class="alert alert-info d-none">Saving attendance...</div>
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-outline-success btn-sm" onclick="markAllAdminAttendance('present')">Mark All Present</button>
                        <button class="btn btn-outline-danger btn-sm" onclick="markAllAdminAttendance('absent')">Mark All Absent</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearAllAdminAttendance()">Clear All</button>
                    </div>
                    <div id="adminStudentsTable"></div>
                </div>
            </div>
        </div>

        <div id="viewDailyTab" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">View Daily Attendance (Admin)</h5>

                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label>Region</label>
                            <select class="form-select" id="adminViewRegion" onchange="loadAdminViewBatches()">
                                <option value="">Select Region</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Batch</label>
                            <select class="form-select" id="adminViewBatch">
                                <option value="">Select Batch</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Date</label>
                            <input type="date" class="form-control" id="adminViewDate" required>
                        </div>
                        <div class="col-md-3">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="viewAdminDailyAttendance()">View</button>
                        </div>
                    </div>

                    <div id="adminViewResults"></div>
                </div>
            </div>
        </div>

        <div id="whatsappInviteTab" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Send WhatsApp Group Invite</h5>

                    <div class="row g-3 mb-4 align-items-end">
                        <div class="col-md-3">
                            <label>Region</label>
                            <select class="form-select" id="waRegion" onchange="loadWaBatches()">
                                <option value="">Select Region</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Batch</label>
                            <select class="form-select" id="waBatch">
                                <option value="">Select Batch</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label>WhatsApp Group Invite Link</label>
                            <input type="text" class="form-control" id="waInviteLink" placeholder="Paste invite link here">
                        </div>
                        <div class="col-md-3">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="buildWaInviteList()">Generate Links</button>
                        </div>
                    </div>

                    <div id="waInviteResults"></div>
                </div>
            </div>
        </div>

        <div id="attendanceTab" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">üìä Attendance Report (Summary)</h5>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-2">
                            <label>Region</label>
                            <select class="form-select" id="attRegion" onchange="loadAttBatches()">
                                <option value="">Select Region</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label>Batch</label>
                            <select class="form-select" id="attBatch">
                                <option value="">Select Batch</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label>Filter Type</label>
                            <select class="form-select" id="attFilterType" onchange="updateAttFilterUI()">
                                <option value="date-range">Date Range</option>
                                <option value="month">Month</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label id="attDateLabel">Start Date</label>
                            <input type="date" class="form-control" id="attStartDate">
                        </div>
                        <div class="col-md-2">
                            <label id="attEndLabel">End Date</label>
                            <input type="date" class="form-control" id="attEndDate">
                        </div>
                        <div class="col-md-2">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="loadAttendanceReport()">Generate Report</button>
                        </div>
                    </div>

                    <div id="attendanceResults"></div>
                </div>
            </div>
        </div>

        <div id="dailyWorkTab" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">üìù Daily Work (All Teachers)</h5>

                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label>Teacher</label>
                            <select class="form-select" id="adminWorkTeacher">
                                <option value="">All Teachers</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Filter Type</label>
                            <select class="form-select" id="adminWorkFilterType" onchange="updateAdminWorkFilterUI()">
                                <option value="date">Date</option>
                                <option value="month">Month</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label id="adminWorkDateLabel">Date</label>
                            <input type="date" class="form-control" id="adminWorkDate">
                        </div>
                        <div class="col-md-2">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="loadAdminWorkReports()">View Reports</button>
                        </div>
                    </div>

                    <div id="adminWorkResults"></div>
                </div>
            </div>
        </div>

    <!-- Add Student Modal -->
    <div class="modal" id="studentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Add Student</h5>
                    <button type="button" class="btn-close" onclick="closeModal('studentModal')"></button>
                </div>
                <div class="modal-body">
                    <form id="studentForm">
                        <input type="text" class="form-control mb-2" placeholder="Name" id="sName" required>
                        <input type="text" class="form-control mb-2" placeholder="Region" id="sRegion" required>
                        <input type="text" class="form-control mb-2" placeholder="School Name" id="sSchool" required>
                        <input type="number" class="form-control mb-2" placeholder="Age" id="sAge">
                        <input type="text" class="form-control mb-2" placeholder="Mobile" id="sMobile" required>
                        <input type="text" class="form-control mb-2" placeholder="Standard/Class" id="sStandard">
                        <input type="text" class="form-control mb-2" placeholder="Batch Number" id="sBatch" required>
                        <button type="submit" class="btn btn-success">Add Student</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal" id="editStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Edit Student</h5>
                    <button type="button" class="btn-close" onclick="closeModal('editStudentModal')"></button>
                </div>
                <div class="modal-body">
                    <form id="editStudentForm">
                        <input type="hidden" id="editStudentId">
                        <input type="text" class="form-control mb-2" placeholder="Name" id="editSName" required>
                        <input type="text" class="form-control mb-2" placeholder="Region" id="editSRegion" required>
                        <input type="text" class="form-control mb-2" placeholder="School Name" id="editSSchool" required>
                        <input type="number" class="form-control mb-2" placeholder="Age" id="editSAge">
                        <input type="text" class="form-control mb-2" placeholder="Mobile" id="editSMobile" required>
                        <input type="text" class="form-control mb-2" placeholder="Standard/Class" id="editSStandard">
                        <input type="text" class="form-control mb-2" placeholder="Batch Number" id="editSBatch" required>
                        <button type="submit" class="btn btn-primary">Update Student</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Add Teacher/Admin</h5>
                    <button type="button" class="btn-close" onclick="closeModal('userModal')"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="text" class="form-control mb-2" placeholder="Name" id="uName" required>
                        <input type="email" class="form-control mb-2" placeholder="Email" id="uEmail" required>
                        <input type="password" class="form-control mb-2" placeholder="Password" id="uPass" required>
                        <select class="form-select mb-2" id="uRole" required>
                            <option value="teacher">Teacher</option>
                            <option value="admin">Admin</option>
                        </select>
                        <button type="submit" class="btn btn-success">Add User</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Edit User</h5>
                    <button type="button" class="btn-close" onclick="closeModal('editUserModal')"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <input type="text" class="form-control mb-2" placeholder="Name" id="editUName" required>
                        <input type="email" class="form-control mb-2" placeholder="Email" id="editUEmail" required>
                        <input type="password" class="form-control mb-2" placeholder="New Password (leave blank to keep)" id="editUPass">
                        <select class="form-select mb-2" id="editURole" required>
                            <option value="teacher">Teacher</option>
                            <option value="admin">Admin</option>
                        </select>
                        <button type="submit" class="btn btn-primary">Update User</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="backupTab" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Backup / Restore</h5>
                    <div class="row g-3 mb-3 align-items-end">
                        <div class="col-md-3">
                            <label>Download Backup</label>
                            <select class="form-select" id="backupCollection">
                                <option value="students">Students</option>
                                <option value="users">Users (includes password hash)</option>
                                <option value="attendance">Attendance</option>
                                <option value="marks">Marks</option>
                                <option value="workReports">Work Reports</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-primary w-100" onclick="downloadBackup()">Download JSON</button>
                        </div>
                    </div>

                    <div class="row g-3 align-items-end">
                        <div class="col-md-5">
                            <label>Restore (JSON Backup)</label>
                            <input type="file" class="form-control" id="restoreFile" accept=".json">
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-warning w-100" onclick="restoreBackup()">Restore</button>
                        </div>
                    </div>
                    <div id="backupResult" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    </div>

    <!-- Student Profile Modal -->
    <div class="modal" id="studentProfileModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Student Profile</h5>
                    <button type="button" class="btn-close" onclick="closeModal('studentProfileModal')"></button>
                </div>
                <div class="modal-body" id="studentProfileContent">
                    Loading...
                </div>
            </div>
        </div>
    </div>
    <footer class="dashboard-footer">
        <span>¬© 2026 Digital Literacy for Every Child ‚Äî All Rights Reserved</span>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (!token || !user.role) {
            localStorage.clear();
            window.location.href = '/';
        }
        if (user.role !== 'admin') {
            alert('Admin access required. Please login with an admin account.');
            localStorage.clear();
            window.location.href = '/';
        }

        function showTab(tab) {
            if (tab === 'students') {
                document.getElementById('studentsTab').style.display = 'block';
                document.getElementById('usersTab').style.display = 'none';
                document.getElementById('markAttendanceTab').style.display = 'none';
                document.getElementById('viewDailyTab').style.display = 'none';
                document.getElementById('whatsappInviteTab').style.display = 'none';
                document.getElementById('attendanceTab').style.display = 'none';
                document.getElementById('dailyWorkTab').style.display = 'none';
                document.getElementById('backupTab').style.display = 'none';
                loadFilterRegions();
            } else if (tab === 'users') {
                document.getElementById('studentsTab').style.display = 'none';
                document.getElementById('usersTab').style.display = 'block';
                document.getElementById('markAttendanceTab').style.display = 'none';
                document.getElementById('viewDailyTab').style.display = 'none';
                document.getElementById('whatsappInviteTab').style.display = 'none';
                document.getElementById('attendanceTab').style.display = 'none';
                document.getElementById('dailyWorkTab').style.display = 'none';
                document.getElementById('backupTab').style.display = 'none';
            } else if (tab === 'markattendance') {
                document.getElementById('studentsTab').style.display = 'none';
                document.getElementById('usersTab').style.display = 'none';
                document.getElementById('markAttendanceTab').style.display = 'block';
                document.getElementById('viewDailyTab').style.display = 'none';
                document.getElementById('whatsappInviteTab').style.display = 'none';
                document.getElementById('attendanceTab').style.display = 'none';
                document.getElementById('dailyWorkTab').style.display = 'none';
                document.getElementById('backupTab').style.display = 'none';
                loadAdminMarkRegions();
            } else if (tab === 'viewdaily') {
                document.getElementById('studentsTab').style.display = 'none';
                document.getElementById('usersTab').style.display = 'none';
                document.getElementById('markAttendanceTab').style.display = 'none';
                document.getElementById('viewDailyTab').style.display = 'block';
                document.getElementById('whatsappInviteTab').style.display = 'none';
                document.getElementById('attendanceTab').style.display = 'none';
                document.getElementById('dailyWorkTab').style.display = 'none';
                document.getElementById('backupTab').style.display = 'none';
                loadAdminViewRegions();
            } else if (tab === 'whatsapp') {
                document.getElementById('studentsTab').style.display = 'none';
                document.getElementById('usersTab').style.display = 'none';
                document.getElementById('markAttendanceTab').style.display = 'none';
                document.getElementById('viewDailyTab').style.display = 'none';
                document.getElementById('whatsappInviteTab').style.display = 'block';
                document.getElementById('attendanceTab').style.display = 'none';
                document.getElementById('dailyWorkTab').style.display = 'none';
                document.getElementById('backupTab').style.display = 'none';
                loadWaRegions();
            } else if (tab === 'attendance') {
                document.getElementById('studentsTab').style.display = 'none';
                document.getElementById('usersTab').style.display = 'none';
                document.getElementById('markAttendanceTab').style.display = 'none';
                document.getElementById('viewDailyTab').style.display = 'none';
                document.getElementById('whatsappInviteTab').style.display = 'none';
                document.getElementById('attendanceTab').style.display = 'block';
                document.getElementById('dailyWorkTab').style.display = 'none';
                document.getElementById('backupTab').style.display = 'none';
                loadAttRegions();
            } else if (tab === 'dailywork') {
                document.getElementById('studentsTab').style.display = 'none';
                document.getElementById('usersTab').style.display = 'none';
                document.getElementById('markAttendanceTab').style.display = 'none';
                document.getElementById('viewDailyTab').style.display = 'none';
                document.getElementById('whatsappInviteTab').style.display = 'none';
                document.getElementById('attendanceTab').style.display = 'none';
                document.getElementById('dailyWorkTab').style.display = 'block';
                document.getElementById('backupTab').style.display = 'none';
            } else if (tab === 'backup') {
                document.getElementById('studentsTab').style.display = 'none';
                document.getElementById('usersTab').style.display = 'none';
                document.getElementById('markAttendanceTab').style.display = 'none';
                document.getElementById('viewDailyTab').style.display = 'none';
                document.getElementById('whatsappInviteTab').style.display = 'none';
                document.getElementById('attendanceTab').style.display = 'none';
                document.getElementById('dailyWorkTab').style.display = 'none';
                document.getElementById('backupTab').style.display = 'block';
            }
        }

        function showAddStudentModal() {
            new bootstrap.Modal(document.getElementById('studentModal')).show();
        }

        function showAddUserModal() {
            new bootstrap.Modal(document.getElementById('userModal')).show();
        }

        function closeModal(id) {
            bootstrap.Modal.getInstance(document.getElementById(id)).hide();
        }

        async function loadStats() {
            const res = await fetch('/api/students/stats/dashboard', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            document.getElementById('totalStudents').textContent = data.total;
            document.getElementById('activeStudents').textContent = data.active;
            const inactiveEl = document.getElementById('inactiveStudents');
            if (inactiveEl) inactiveEl.textContent = data.inactive || 0;
        }

        async function loadStudents() {
            const region = document.getElementById('filterRegion').value;
            const batch = document.getElementById('filterBatch').value;
            const q = document.getElementById('filterSearch').value;
            
            let url = '/api/students';
            const params = new URLSearchParams();
            if (region) params.append('region', region);
            if (batch) params.append('batchNumber', batch);
            if (q) params.append('q', q);
            if (params.toString()) url += '?' + params.toString();
            
            const res = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const students = await res.json();
            
            let html = '<table class="table"><thead><tr><th>#</th><th>Name</th><th>Region</th><th>School</th><th>Batch</th><th>Mobile</th><th>Actions</th></tr></thead><tbody>';
            students.forEach((s, index) => {
                html += `<tr>
                    <td>${index + 1}</td>
                    <td>${s.name}</td>
                    <td>${s.region}</td>
                    <td>${s.schoolName || '-'}</td>
                    <td>${s.batchNumber}</td>
                    <td>${s.mobile || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewStudentProfile('${s._id}')">View</button>
                        <button class="btn btn-sm btn-warning" onclick="editStudent('${s._id}', '${s.name}', '${s.region}', '${s.schoolName || ''}', '${s.mobile || ''}', '${s.age || ''}', '${s.standard || ''}', '${s.batchNumber}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStudent('${s._id}')">Delete</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('studentsList').innerHTML = html;
        }

        async function loadUsers() {
            const res = await fetch('/api/users', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const users = await res.json();
            
            let html = '<table class="table"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr></thead><tbody>';
            users.forEach(u => {
                html += `<tr>
                    <td>${u.name}</td>
                    <td>${u.email}</td>
                    <td>${u.role}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editUser('${u._id}', '${u.name}', '${u.email}', '${u.role}')">Edit</button>
                        <button class="btn btn-sm btn-secondary" onclick="resetUserPasswordPrompt('${u._id}', '${u.name}')">Reset Password</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${u._id}')">Delete</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('usersList').innerHTML = html;
        }

        document.getElementById('studentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('sName').value,
                region: document.getElementById('sRegion').value,
                schoolName: document.getElementById('sSchool').value,
                age: document.getElementById('sAge').value,
                mobile: document.getElementById('sMobile').value,
                standard: document.getElementById('sStandard').value,
                batchNumber: document.getElementById('sBatch').value
            };
            
            const res = await fetch('/api/students', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                alert('Student added successfully!');
                closeModal('studentModal');
                e.target.reset();
                loadStudents();
                loadStats();
            } else {
                let errorMessage = 'Unknown error';
                try {
                    const error = await res.json();
                    errorMessage = error.message || errorMessage;
                } catch (e2) {
                    // ignore JSON parse error
                }
                if (res.status === 403) {
                    errorMessage = `Admin only. You are logged in as: ${user.role || 'unknown'}`;
                }
                alert('Error adding student: ' + errorMessage);
            }
        });

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('uName').value,
                email: document.getElementById('uEmail').value,
                password: document.getElementById('uPass').value,
                role: document.getElementById('uRole').value
            };
            
            const res = await fetch('/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                alert('User added successfully!');
                closeModal('userModal');
                e.target.reset();
                loadUsers();
            } else {
                alert('Error adding user');
            }
        });

        function editUser(id, name, email, role) {
            document.getElementById('editUserId').value = id;
            document.getElementById('editUName').value = name;
            document.getElementById('editUEmail').value = email;
            document.getElementById('editURole').value = role;
            document.getElementById('editUPass').value = '';
            new bootstrap.Modal(document.getElementById('editUserModal')).show();
        }

        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editUserId').value;
            const data = {
                name: document.getElementById('editUName').value,
                email: document.getElementById('editUEmail').value,
                role: document.getElementById('editURole').value
            };
            const pass = document.getElementById('editUPass').value;
            if (pass) data.password = pass;

            const res = await fetch(`/api/users/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                alert('User updated successfully!');
                closeModal('editUserModal');
                e.target.reset();
                loadUsers();
            } else {
                const error = await res.json();
                alert('Error updating user: ' + (error.message || 'Unknown error'));
            }
        });

        async function resetUserPasswordPrompt(id, name) {
            const newPass = window.prompt(`Enter new password for ${name}`);
            if (!newPass) return;

            try {
                const res = await fetch(`/api/users/${id}/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ password: newPass })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Failed to reset password');
                alert('Password reset successfully');
            } catch (error) {
                alert('Error resetting password: ' + error.message);
            }
        }

        async function viewStudentProfile(studentId) {
            const contentEl = document.getElementById('studentProfileContent');
            if (contentEl) contentEl.innerHTML = 'Loading...';
            new bootstrap.Modal(document.getElementById('studentProfileModal')).show();

            try {
                const res = await fetch(`/api/students/profile/${studentId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    const data = await res.json().catch(() => ({}));
                    throw new Error(data.message || 'Failed to load profile');
                }
                const data = await res.json();
                const s = data.student;
                const attendance = data.attendance || {};
                const marks = data.marks || [];

                const attendanceRows = (attendance.records || []).map(r => `
                    <tr>
                        <td>${r.date}</td>
                        <td>${r.status}</td>
                        <td>${r.markedByName || '-'}</td>
                        <td>${r.markedAt ? formatDateTime(r.markedAt) : '-'}</td>
                    </tr>
                `).join('');

                const marksRows = marks.map(m => `
                    <tr>
                        <td>${m.date}</td>
                        <td>${m.totalObtained || 0}/${m.totalMarks || 0}</td>
                        <td>${m.percentage || 0}%</td>
                        <td>${m.markedByName || '-'}</td>
                    </tr>
                `).join('');

                const html = `
                    <div class="mb-3">
                        <h6>${s.name}</h6>
                        <div class="text-muted">${s.schoolName || '-'} | ${s.region || '-'} | Batch: ${s.batchNumber || '-'}</div>
                        <div>Standard: ${s.standard || '-'} | Mobile: ${s.mobile || '-'} | Age: ${s.age || '-'}</div>
                        <div>Status: ${s.isActive ? 'Active' : 'Inactive'}</div>
                    </div>
                    <div class="mb-3">
                        <strong>Attendance Summary:</strong>
                        Present: ${attendance.presentCount || 0} |
                        Absent: ${attendance.absentCount || 0} |
                        Total Marked: ${attendance.totalMarked || 0}
                    </div>
                    <div class="mb-3">
                        <h6>Recent Attendance</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Marked By</th>
                                        <th>Last Updated</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${attendanceRows || '<tr><td colspan="4">No records</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h6>Recent Marks</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Score</th>
                                        <th>%</th>
                                        <th>Marked By</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${marksRows || '<tr><td colspan="4">No records</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                if (contentEl) contentEl.innerHTML = html;
            } catch (error) {
                if (contentEl) contentEl.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        }

        // Edit Student Functions
        function editStudent(id, name, region, school, mobile, age, standard, batch) {
            document.getElementById('editStudentId').value = id;
            document.getElementById('editSName').value = name;
            document.getElementById('editSRegion').value = region;
            document.getElementById('editSSchool').value = school;
            document.getElementById('editSMobile').value = mobile;
            document.getElementById('editSAge').value = age;
            document.getElementById('editSStandard').value = standard;
            document.getElementById('editSBatch').value = batch;
            new bootstrap.Modal(document.getElementById('editStudentModal')).show();
        }

        document.getElementById('editStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editStudentId').value;
            const data = {
                name: document.getElementById('editSName').value,
                region: document.getElementById('editSRegion').value,
                schoolName: document.getElementById('editSSchool').value,
                age: document.getElementById('editSAge').value,
                mobile: document.getElementById('editSMobile').value,
                standard: document.getElementById('editSStandard').value,
                batchNumber: document.getElementById('editSBatch').value
            };
            
            const res = await fetch(`/api/students/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                alert('Student updated successfully!');
                closeModal('editStudentModal');
                e.target.reset();
                loadStudents();
                loadStats();
            } else {
                const error = await res.json();
                alert('Error updating student: ' + (error.message || 'Unknown error'));
            }
        });

        async function deleteStudent(id) {
            if (!confirm('Delete this student?')) return;
            await fetch(`/api/students/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            loadStudents();
            loadStats();
        }

        async function deleteUser(id) {
            if (!confirm('Delete this user?')) return;
            await fetch(`/api/users/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            loadUsers();
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }

        
        
        // ===== WHATSAPP INVITE =====
        async function loadWaRegions() {
            const res = await fetch('/api/students/regions/all', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const regions = await res.json();
            const select = document.getElementById('waRegion');
            if (!select) return;
            select.innerHTML = '<option value="">Select Region</option>';
            regions.forEach(region => {
                select.innerHTML += `<option value="${region}">${region}</option>`;
            });
            const batchSelect = document.getElementById('waBatch');
            if (batchSelect) batchSelect.innerHTML = '<option value="">Select Batch</option>';
            document.getElementById('waInviteResults').innerHTML = '';
        }

        async function loadWaBatches() {
            const region = document.getElementById('waRegion').value;
            const select = document.getElementById('waBatch');
            if (!select) return;

            if (!region) {
                select.innerHTML = '<option value="">Select Batch</option>';
                document.getElementById('waInviteResults').innerHTML = '';
                return;
            }

            const res = await fetch(`/api/students/batches/${encodeURIComponent(region)}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const batches = await res.json();
            select.innerHTML = '<option value="">Select Batch</option>';
            batches.forEach(batch => {
                select.innerHTML += `<option value="${batch}">${batch}</option>`;
            });
            document.getElementById('waInviteResults').innerHTML = '';
        }

        async function buildWaInviteList() {
            const region = document.getElementById('waRegion').value;
            const batch = document.getElementById('waBatch').value;
            const inviteLink = document.getElementById('waInviteLink').value.trim();

            if (!region || !batch) {
                alert('Please select region and batch');
                return;
            }
            if (!inviteLink) {
                alert('Please paste the WhatsApp group invite link');
                return;
            }

            const res = await fetch(`/api/students?region=${encodeURIComponent(region)}&batchNumber=${encodeURIComponent(batch)}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const students = await res.json();

            if (!students || students.length === 0) {
                document.getElementById('waInviteResults').innerHTML =
                    '<div class="alert alert-warning">No students found in this batch</div>';
                return;
            }

            let html = `
                <div class="alert alert-info">
                    Click each link to open WhatsApp and send the invite.
                </div>
                <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Mobile</th>
                            <th>Send Invite</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            students.forEach((student, index) => {
                const mobile = String(student.mobile || '').trim();
                const message = `Please join the WhatsApp group: ${inviteLink}`;
                const phone = mobile.replace(/\D/g, '');
                const waUrl = phone ? `https://wa.me/${phone}?text=${encodeURIComponent(message)}` : '';

                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${student.name}</td>
                        <td>${student.mobile || '-'}</td>
                        <td>
                            ${waUrl ? `<a class="btn btn-success btn-sm" target="_blank" href="${waUrl}">Send</a>` : '<span class="text-muted">No number</span>'}
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
                </div>
            `;

            document.getElementById('waInviteResults').innerHTML = html;
        }

        // ===== ADMIN VIEW DAILY =====
        async function loadAdminViewRegions() {
            const res = await fetch('/api/students/regions/all', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const regions = await res.json();
            const select = document.getElementById('adminViewRegion');
            if (!select) return;
            select.innerHTML = '<option value="">Select Region</option>';
            regions.forEach(region => {
                select.innerHTML += `<option value="${region}">${region}</option>`;
            });
            const batchSelect = document.getElementById('adminViewBatch');
            if (batchSelect) batchSelect.innerHTML = '<option value="">Select Batch</option>';
            const dateEl = document.getElementById('adminViewDate');
            if (dateEl) {
                dateEl.value = new Date().toISOString().split('T')[0];
            }
            document.getElementById('adminViewResults').innerHTML = '';
        }

        async function loadAdminViewBatches() {
            const region = document.getElementById('adminViewRegion').value;
            const select = document.getElementById('adminViewBatch');
            if (!select) return;

            if (!region) {
                select.innerHTML = '<option value="">Select Batch</option>';
                document.getElementById('adminViewResults').innerHTML = '';
                return;
            }

            const res = await fetch(`/api/students/batches/${encodeURIComponent(region)}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const batches = await res.json();
            select.innerHTML = '<option value="">Select Batch</option>';
            batches.forEach(batch => {
                select.innerHTML += `<option value="${batch}">${batch}</option>`;
            });
            document.getElementById('adminViewResults').innerHTML = '';
        }

        async function viewAdminDailyAttendance() {
            const region = document.getElementById('adminViewRegion').value;
            const batch = document.getElementById('adminViewBatch').value;
            const date = document.getElementById('adminViewDate').value;

            if (!region || !batch || !date) {
                alert('Please select region, batch, and date');
                return;
            }

            try {
                const res = await fetch(
                    `/api/attendance/by-batch?region=${encodeURIComponent(region)}&batchNumber=${encodeURIComponent(batch)}&date=${date}`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }

                const students = await res.json();
                if (!students || students.length === 0) {
                    document.getElementById('adminViewResults').innerHTML =
                        '<div class="alert alert-warning">No students found in this batch</div>';
                    return;
                }

                let present = 0, absent = 0, notMarked = 0;

                let html = `
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Status</th>
                                <th>Marked By</th>
                                <th>Last Updated</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                students.forEach((student, index) => {
                    let statusBadge, markedBy;
                    let markedAt = '-';
                    if (student.attendance) {
                        if (student.attendance.status === 'present') {
                            statusBadge = '<span class="badge bg-success">PRESENT</span>';
                            present++;
                        } else {
                            statusBadge = '<span class="badge bg-danger">ABSENT</span>';
                            absent++;
                        }
                        markedBy = student.attendance.markedBy;
                        if (student.attendance.markedAt) {
                            markedAt = formatDateTime(student.attendance.markedAt);
                        }
                    } else {
                        statusBadge = '<span class="badge bg-secondary">NOT MARKED</span>';
                        markedBy = '-';
                        notMarked++;
                    }

                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${student.name}</td>
                            <td>${statusBadge}</td>
                            <td>${markedBy}</td>
                            <td>${markedAt}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';

                const summary = `
                    <div class="alert alert-info">
                        <strong>?? Summary:</strong> 
                        Present: <span class="badge bg-success">${present}</span> | 
                        Absent: <span class="badge bg-danger">${absent}</span> | 
                        Not Marked: <span class="badge bg-secondary">${notMarked}</span>
                    </div>
                `;

                document.getElementById('adminViewResults').innerHTML = summary + html;
            } catch (error) {
                console.error('Error viewing attendance:', error);
                document.getElementById('adminViewResults').innerHTML =
                    `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }// ===== ADMIN MARK ATTENDANCE =====
        let adminCurrentStudents = [];

        async function loadAdminMarkRegions() {
            const res = await fetch('/api/students/regions/all', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const regions = await res.json();
            const select = document.getElementById('adminMarkRegion');
            if (!select) return;
            select.innerHTML = '<option value="">Select Region</option>';
            regions.forEach(region => {
                select.innerHTML += `<option value="${region}">${region}</option>`;
            });
            document.getElementById('adminMarkBatch').innerHTML = '<option value="">Select Batch</option>';
            const dateEl = document.getElementById('adminMarkDate');
            if (dateEl) {
                dateEl.value = new Date().toISOString().split('T')[0];
            }
            document.getElementById('adminStudentsTable').innerHTML = '';
        }

        async function loadAdminMarkBatches() {
            const region = document.getElementById('adminMarkRegion').value;
            const select = document.getElementById('adminMarkBatch');
            if (!select) return;

            if (!region) {
                select.innerHTML = '<option value="">Select Batch</option>';
                document.getElementById('adminStudentsTable').innerHTML = '';
                return;
            }

            const res = await fetch(`/api/students/batches/${encodeURIComponent(region)}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const batches = await res.json();
            select.innerHTML = '<option value="">Select Batch</option>';
            batches.forEach(batch => {
                select.innerHTML += `<option value="${batch}">${batch}</option>`;
            });
            document.getElementById('adminStudentsTable').innerHTML = '';
        }

        async function loadAdminMarkStudents() {
            const region = document.getElementById('adminMarkRegion').value;
            const batch = document.getElementById('adminMarkBatch').value;
            const date = document.getElementById('adminMarkDate').value;

            if (!region || !batch || !date) return;

            const res = await fetch(
                `/api/attendance/by-batch?region=${encodeURIComponent(region)}&batchNumber=${encodeURIComponent(batch)}&date=${date}`,
                { headers: { 'Authorization': `Bearer ${token}` } }
            );
            if (!res.ok) {
                alert('Failed to load students');
                return;
            }
            adminCurrentStudents = await res.json();

            if (!adminCurrentStudents || adminCurrentStudents.length === 0) {
                document.getElementById('adminStudentsTable').innerHTML =
                    '<div class="alert alert-warning">No students found in this batch</div>';
                return;
            }

            let html = `
                <table class="table table-sm table-striped">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Student Name</th>
                            <th class="text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            adminCurrentStudents.forEach((student, index) => {
                const isPresent = student.attendance && student.attendance.status === 'present';
                const isAbsent = student.attendance && student.attendance.status === 'absent';
                const prevAbsent = student.previousDay && student.previousDay.status === 'absent';
                const prevIcon = prevAbsent
                    ? '<span class="ms-2 text-warning" title="Absent yesterday"><i class="bi bi-moon-stars-fill"></i></span>'
                    : '';
                html += `
                    <tr>
                        <td class="align-middle">${index + 1}</td>
                        <td class="align-middle fw-semibold">${student.name}${prevIcon}</td>
                        <td class="align-middle">
                            <div class="d-flex justify-content-center gap-3">
                                <label class="d-flex align-items-center gap-2 px-3 py-2 rounded-pill border shadow-sm bg-light" style="cursor:pointer;">
                                    <input type="radio" class="form-check-input m-0" name="admin_status_${student._id}" value="present" ${isPresent ? 'checked' : ''}>
                                    <span class="fw-semibold text-success">present</span>
                                </label>
                                <label class="d-flex align-items-center gap-2 px-3 py-2 rounded-pill border shadow-sm bg-light" style="cursor:pointer;">
                                    <input type="radio" class="form-check-input m-0" name="admin_status_${student._id}" value="absent" ${isAbsent ? 'checked' : ''}>
                                    <span class="fw-semibold text-danger">absent</span>
                                </label>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
                <button class="btn btn-success btn-lg mt-3" onclick="submitAdminAttendance()">Submit Attendance</button>
            `;

            document.getElementById('adminStudentsTable').innerHTML = html;
        }

        async function submitAdminAttendance() {
            const region = document.getElementById('adminMarkRegion').value;
            const batch = document.getElementById('adminMarkBatch').value;
            const date = document.getElementById('adminMarkDate').value;

            if (!region || !batch || !date) {
                alert('Please select region, batch, and date');
                return;
            }

            const attendanceRecords = [];
            adminCurrentStudents.forEach(student => {
                const presentRadio = document.querySelector(`input[name="admin_status_${student._id}"][value="present"]`);
                const absentRadio = document.querySelector(`input[name="admin_status_${student._id}"][value="absent"]`);
                if (presentRadio && presentRadio.checked) {
                    attendanceRecords.push({ studentId: student._id, status: 'present' });
                } else if (absentRadio && absentRadio.checked) {
                    attendanceRecords.push({ studentId: student._id, status: 'absent' });
                }
            });

            if (attendanceRecords.length === 0) {
                alert('Please mark at least one student');
                return;
            }

            if (attendanceRecords.length < adminCurrentStudents.length) {
                const confirmSubmit = window.confirm(
                    `You have marked ${attendanceRecords.length} out of ${adminCurrentStudents.length} students. Submit anyway?`
                );
                if (!confirmSubmit) return;
            }

            const savingBanner = document.getElementById('adminSavingBanner');
            if (savingBanner) savingBanner.classList.remove('d-none');

            try {
                const res = await fetch('/api/attendance/mark', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ date, attendanceRecords })
                });
                const data = await res.json();
                if (res.ok) {
                    alert(`Attendance saved. Marked: ${data.results?.successful || 0}`);
                    loadAdminMarkStudents();
                } else {
                    alert('Error: ' + (data.message || 'Failed to submit'));
                }
            } catch (error) {
                console.error('Error submitting attendance:', error);
                alert('Failed to submit attendance');
            } finally {
                if (savingBanner) savingBanner.classList.add('d-none');
            }
        }
        function markAllAdminAttendance(status) {
            if (!adminCurrentStudents || adminCurrentStudents.length === 0) {
                alert('No students loaded');
                return;
            }
            adminCurrentStudents.forEach(student => {
                const input = document.querySelector(`input[name="admin_status_${student._id}"][value="${status}"]`);
                if (input) input.checked = true;
            });
        }

        function clearAllAdminAttendance() {
            if (!adminCurrentStudents || adminCurrentStudents.length === 0) {
                alert('No students loaded');
                return;
            }
            adminCurrentStudents.forEach(student => {
                const presentInput = document.querySelector(`input[name="admin_status_${student._id}"][value="present"]`);
                const absentInput = document.querySelector(`input[name="admin_status_${student._id}"][value="absent"]`);
                if (presentInput) presentInput.checked = false;
                if (absentInput) absentInput.checked = false;
            });
        }

        // ===== STUDENT FILTER FUNCTIONS =====
        async function loadFilterRegions() {
            const res = await fetch('/api/students/regions/all', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const regions = await res.json();
            const select = document.getElementById('filterRegion');
            select.innerHTML = '<option value="">Select Region</option>';
            regions.forEach(r => {
                select.innerHTML += `<option value="${r}">${r}</option>`;
            });
        }

        async function loadFilterBatches() {
            const region = document.getElementById('filterRegion').value;
            if (!region) {
                document.getElementById('filterBatch').innerHTML = '<option value="">Select Batch</option>';
                loadStudents();
                return;
            }
            
            const res = await fetch(`/api/students/batches/${region}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const batches = await res.json();
            const select = document.getElementById('filterBatch');
            select.innerHTML = '<option value="">Select Batch</option>';
            batches.forEach(b => {
                select.innerHTML += `<option value="${b}">${b}</option>`;
            });
            loadStudents();
        }

        async function importStudentsCsv() {
            const fileInput = document.getElementById('studentsCsvFile');
            const resultEl = document.getElementById('importResult');
            if (!fileInput?.files?.length) {
                alert('Please choose a CSV file');
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            if (resultEl) resultEl.innerHTML = '';

            try {
                const res = await fetch('/api/students/import', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Import failed');
                if (resultEl) {
                    resultEl.innerHTML = `<div class="alert alert-success">Import completed. Created: ${data.created}, Skipped: ${data.skipped}</div>`;
                }
                loadStudents();
                loadStats();
            } catch (error) {
                if (resultEl) {
                    resultEl.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
                }
            }
        }

        async function downloadFile(url, filename) {
            try {
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    const data = await res.json().catch(() => ({}));
                    throw new Error(data.message || 'Download failed');
                }
                const blob = await res.blob();
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                link.remove();
                URL.revokeObjectURL(link.href);
            } catch (error) {
                alert(error.message);
            }
        }

        // ===== BACKUP / RESTORE =====
        function downloadBackup() {
            const collection = document.getElementById('backupCollection').value;
            downloadFile(`/api/backup?collection=${encodeURIComponent(collection)}&download=1`, `${collection}-backup.json`);
        }

        async function restoreBackup() {
            const fileInput = document.getElementById('restoreFile');
            const resultEl = document.getElementById('backupResult');
            if (!fileInput?.files?.length) {
                alert('Please choose a JSON backup file');
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            if (resultEl) resultEl.innerHTML = '';

            try {
                const res = await fetch('/api/backup/restore', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Restore failed');
                if (resultEl) {
                    resultEl.innerHTML = `
                        <div class="alert alert-success">
                            Restore completed. Students created: ${data.createdStudents || 0}, Users created: ${data.createdUsers || 0}.
                        </div>
                    `;
                }
                loadStudents();
                loadUsers();
                loadStats();
            } catch (error) {
                if (resultEl) {
                    resultEl.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
                }
            }
        }

        function exportStudentsCsv() {
            const region = document.getElementById('filterRegion').value;
            const batch = document.getElementById('filterBatch').value;
            const params = new URLSearchParams({ format: 'csv' });
            if (region) params.append('region', region);
            if (batch) params.append('batchNumber', batch);
            downloadFile(`/api/students/export?${params.toString()}`, 'students.csv');
        }

        function exportStudentsJson() {
            const region = document.getElementById('filterRegion').value;
            const batch = document.getElementById('filterBatch').value;
            const params = new URLSearchParams({ format: 'json' });
            if (region) params.append('region', region);
            if (batch) params.append('batchNumber', batch);
            downloadFile(`/api/students/export?${params.toString()}`, 'students.json');
        }

        function resetStudentFilters() {
            document.getElementById('filterRegion').value = '';
            document.getElementById('filterBatch').value = '';
            const searchEl = document.getElementById('filterSearch');
            if (searchEl) searchEl.value = '';
            loadStudents();
        }

        // ===== ATTENDANCE FUNCTIONS =====
        async function loadAttRegions() {
            const res = await fetch('/api/students/regions/all', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const regions = await res.json();
            const select = document.getElementById('attRegion');
            select.innerHTML = '<option value="">Select Region</option>';
            regions.forEach(r => {
                select.innerHTML += `<option value="${r}">${r}</option>`;
            });
        }

        async function loadAdminWorkTeachers() {
            const res = await fetch('/api/users', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const users = await res.json();
            const select = document.getElementById('adminWorkTeacher');
            if (!select) return;
            select.innerHTML = '<option value="">All Teachers</option>';
            users
                .filter(u => u.role === 'teacher')
                .forEach(u => {
                    select.innerHTML += `<option value="${u._id}">${u.name}</option>`;
                });
        }

        async function loadAdminWorkReports() {
            const filterType = document.getElementById('adminWorkFilterType').value;
            const dateInput = document.getElementById('adminWorkDate').value;
            const teacherId = document.getElementById('adminWorkTeacher').value;

            if (!dateInput) {
                alert('Please select date/month');
                return;
            }

            const params = new URLSearchParams();
            if (teacherId) {
                params.append('teacherId', teacherId);
            }
            if (filterType === 'month') {
                const [year, month] = dateInput.split('-');
                const startDate = `${year}-${month}-01`;
                const lastDay = new Date(year, month, 0).getDate();
                const endDate = `${year}-${month}-${lastDay}`;
                params.append('startDate', startDate);
                params.append('endDate', endDate);
            } else {
                params.append('date', dateInput);
            }

            const res = await fetch(`/api/workReport?${params.toString()}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!res.ok) {
                alert('Failed to load reports');
                return;
            }

            const reports = await res.json();
            if (!reports || reports.length === 0) {
                document.getElementById('adminWorkResults').innerHTML =
                    '<div class="alert alert-warning">No reports found for the selected filters</div>';
                return;
            }

            let html = `
                <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Date</th>
                            <th>Teacher</th>
                            <th>Topics Taught</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            reports.forEach((report, index) => {
                const reportDate = new Date(report.date).toISOString().split('T')[0];
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${reportDate}</td>
                        <td>${report.teacherName || '-'}</td>
                        <td>${report.topicsCovered}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
                </div>
            `;

            document.getElementById('adminWorkResults').innerHTML = html;
        }

        updateAdminWorkFilterUI();
        loadAdminWorkTeachers();

        function updateAdminWorkFilterUI() {
            const filterType = document.getElementById('adminWorkFilterType').value;
            const dateLabel = document.getElementById('adminWorkDateLabel');
            const dateInput = document.getElementById('adminWorkDate');

            if (filterType === 'month') {
                dateLabel.textContent = 'Month';
                dateInput.type = 'month';
                dateInput.value = new Date().toISOString().slice(0, 7);
            } else {
                dateLabel.textContent = 'Date';
                dateInput.type = 'date';
                dateInput.value = new Date().toISOString().split('T')[0];
            }
        }

        async function loadAttSchools() {
            const res = await fetch('/api/students/schools', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const schools = await res.json();
            const select = document.getElementById('attSchool');
            select.innerHTML = '<option value="">Select School</option>';
            schools.forEach(s => {
                select.innerHTML += `<option value="${s}">${s}</option>`;
            });
        }

        async function loadAttBatches() {
            const region = document.getElementById('attRegion').value;
            if (!region) {
                document.getElementById('attBatch').innerHTML = '<option value="">Select Batch</option>';
                return;
            }
            
            const res = await fetch(`/api/students/batches/${region}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const batches = await res.json();
            const select = document.getElementById('attBatch');
            select.innerHTML = '<option value="">Select Batch</option>';
            batches.forEach(b => {
                select.innerHTML += `<option value="${b}">${b}</option>`;
            });
        }

        function updateAttFilterUI() {
            const filterType = document.getElementById('attFilterType').value;
            const dateLabel = document.getElementById('attDateLabel');
            const endLabel = document.getElementById('attEndLabel');
            const startInput = document.getElementById('attStartDate');
            const endInput = document.getElementById('attEndDate');

            if (filterType === 'month') {
                dateLabel.textContent = 'Year-Month';
                endLabel.textContent = '';
                startInput.type = 'month';
                startInput.value = new Date().toISOString().slice(0, 7);
                endInput.style.display = 'none';
            } else {
                dateLabel.textContent = 'Start Date';
                endLabel.textContent = 'End Date';
                startInput.type = 'date';
                startInput.value = new Date().toISOString().split('T')[0];
                endInput.style.display = 'block';
                endInput.type = 'date';
                endInput.value = new Date().toISOString().split('T')[0];
            }
        }

        async function loadAttendanceReport() {
            const region = document.getElementById('attRegion').value;
            const batch = document.getElementById('attBatch').value;
            const filterType = document.getElementById('attFilterType').value;
            let startDate = document.getElementById('attStartDate').value;
            let endDate = document.getElementById('attEndDate').value;

            if (!region || !batch || !startDate) {
                alert('Please select region, batch, and date(s)');
                return;
            }

            // Convert month format to date range if needed
            if (filterType === 'month') {
                const [year, month] = startDate.split('-');
                startDate = `${year}-${month}-01`;
                // Get last day of month
                const lastDay = new Date(year, month, 0).getDate();
                endDate = `${year}-${month}-${lastDay}`;
            } else {
                if (!endDate) {
                    alert('Please select end date');
                    return;
                }
            }

            try {
                const res = await fetch(
                    `/api/attendance/summary?region=${encodeURIComponent(region)}&batchNumber=${encodeURIComponent(batch)}&startDate=${startDate}&endDate=${endDate}&filterType=${filterType}`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );

                const data = await res.json();

                if (!data.summary || data.summary.length === 0) {
                    document.getElementById('attendanceResults').innerHTML = 
                        '<div class="alert alert-warning">No attendance records found for the selected period</div>';
                    return;
                }

                const stats = data.stats;
                let html = `
                    <div class="alert alert-info">
                        <h6>üìä Summary Statistics</h6>
                        <div class="row">
                            <div class="col-md-3"><strong>Total Classes:</strong> ${stats.totalClasses}</div>
                            <div class="col-md-3"><strong>Total Students:</strong> ${stats.totalStudents}</div>
                            <div class="col-md-3"><strong>Total Present:</strong> <span class="badge bg-success">${stats.totalPresent}</span></div>
                            <div class="col-md-3"><strong>Total Absent:</strong> <span class="badge bg-danger">${stats.totalAbsent}</span></div>
                        </div>
                        <p class="mt-2 mb-0"><strong>Period:</strong> ${stats.dateRange.start} to ${stats.dateRange.end}</p>
                    </div>

                    <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Student Name</th>
                                <th class="text-center">Total Classes</th>
                                <th class="text-center">Marked</th>
                                <th class="text-center">Present</th>
                                <th class="text-center">Absent</th>
                                <th class="text-center">Attendance %</th>
                                <th>Marked By</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.summary.forEach(student => {
                    const percentage = parseFloat(student.percentage);
                    let percentBadge = 'bg-danger';
                    if (percentage >= 75) {
                        percentBadge = 'bg-success';
                    } else if (percentage >= 50) {
                        percentBadge = 'bg-warning';
                    }

                    const markedBy = student.markedBy || '-';

                    html += `
                        <tr>
                            <td>${student.name}</td>
                            <td class="text-center"><strong>${student.totalClasses}</strong></td>
                            <td class="text-center">${student.totalMarked}/${student.totalClasses}</td>
                            <td class="text-center"><span class="badge bg-success">${student.present}</span></td>
                            <td class="text-center"><span class="badge bg-danger">${student.absent}</span></td>
                            <td class="text-center"><span class="badge ${percentBadge}">${student.percentage}%</span></td>
                            <td>${markedBy}</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                    </div>
                    <button class="btn btn-secondary mt-3" onclick="printAttReport()">üñ®Ô∏è Print Report</button>
                `;

                document.getElementById('attendanceResults').innerHTML = html;

            } catch (error) {
                console.error('Error loading report:', error);
                alert('Failed to load report');
            }
        }

        function printAttReport() {
            window.print();
        }

        function formatDateTime(value) {
            const dt = new Date(value);
            if (Number.isNaN(dt.getTime())) return '-';
            return dt.toISOString().replace('T', ' ').slice(0, 16);
        }

        loadStats();
        loadUsers();
                loadFilterRegions();
                loadStudents();
        updateAttFilterUI();
    </script>
</body>
</html>





