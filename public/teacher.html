<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(180deg, #f7f9fc 0%, #eef3f8 100%);
            min-height: 100vh;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        .container {
            padding-bottom: 2rem;
        }

        .card {
            background-color: #ffffff;
            border-color: #e6eef5;
            box-shadow: 0 10px 24px rgba(22, 42, 60, 0.08);
        }

        .dashboard-nav-shell {
            border: 1px solid #dce8f4;
            border-radius: 18px;
            background:
                radial-gradient(circle at top right, rgba(14, 165, 164, 0.12), transparent 42%),
                linear-gradient(180deg, #ffffff 0%, #f7fbff 100%);
            padding: 14px;
            margin-bottom: 12px;
            box-shadow: 0 12px 26px rgba(20, 53, 82, 0.08);
        }

        .dashboard-nav-title {
            font-size: 13px;
            font-weight: 700;
            color: #36506f;
            letter-spacing: 0.2px;
            margin-bottom: 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .quick-nav-wrap {
            display: none;
            margin-bottom: 8px;
        }

        .quick-nav-wrap .form-select {
            border-radius: 12px;
            border-color: #c7d8ea;
            font-weight: 600;
            color: #304966;
            background-color: #f5faff;
        }

        .nav-tabs {
            border-bottom: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(142px, 1fr));
            gap: 10px;
            margin-bottom: 0;
        }

        .nav-tabs .nav-item {
            width: 100%;
        }

        .nav-tabs .nav-link {
            width: 100%;
            border: 1px solid transparent;
            border-radius: 12px;
            background: #f2f6fb;
            color: #42526b;
            font-weight: 600;
            padding: 10px 12px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 44px;
        }

        .nav-tabs .nav-link:hover {
            background: rgba(14, 165, 164, 0.12);
            color: #0b7f7e;
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #0ea5a4 0%, #12c2b9 100%);
            color: #ffffff;
            box-shadow: 0 10px 20px rgba(14, 165, 164, 0.25);
            border-color: rgba(14, 165, 164, 0.55);
        }

        .tab-text {
            line-height: 1.15;
        }

        @media (max-width: 1024px) {
            .quick-nav-wrap {
                display: block;
            }

            .nav-tabs {
                display: none;
            }

            .tabs-hint {
                display: block;
            }
        }

        .tabs-hint {
            display: none;
            font-size: 12px;
            color: #6b7b91;
            margin: 0 0 14px;
            text-align: left;
            padding-left: 2px;
        }

        @media (max-width: 576px) {
            .dashboard-nav-shell {
                padding: 12px;
                border-radius: 14px;
            }

            .dashboard-nav-title {
                font-size: 12px;
                margin-bottom: 8px;
            }
        }

        .dashboard-footer {
            margin-top: auto;
            padding: 16px 0 22px;
            text-align: center;
            color: #4b5a70;
            font-size: 13px;
        }

        .dashboard-footer span {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 999px;
            background: rgba(14, 165, 164, 0.1);
            color: #0b7f7e;
            font-weight: 600;
            letter-spacing: 0.4px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container-fluid">
            <span class="navbar-brand">üë®‚Äçüè´ Teacher Dashboard</span>
            <span class="text-white" id="userName"></span>
            <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        <div class="row mb-3" id="statsRow">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted">Total Enrolled Students</h6>
                        <h2 id="totalStudents">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted">Active Students</h6>
                        <h2 id="activeStudents">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted">Inactive Students</h6>
                        <h2 id="inactiveStudents">0</h2>
                    </div>
                </div>
            </div>
        </div>
        <div class="d-flex align-items-center gap-2 mb-3">
            <button class="btn btn-sm btn-outline-primary" id="inactiveDetailsLink" onclick="openInactiveDetails()">
                View Inactive Details
            </button>
            <span class="text-muted small" id="inactiveStudentsMeta"></span>
        </div>
        
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label>Region (Summary)</label>
                        <select class="form-select" id="summaryRegion" onchange="updateSelectedRegionCount()">
                            <option value="">Select Region</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <div id="selectedRegionCount"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="dashboard-nav-shell">
            <div class="dashboard-nav-title">
                <i class="bi bi-grid-1x2-fill"></i>
                Dashboard Sections
            </div>
            <div class="quick-nav-wrap">
                <select id="tabQuickNav" class="form-select" onchange="jumpToTabFromSelect(this.value)">
                    <option value="mark">Mark Attendance</option>
                    <option value="view">View Daily</option>
                    <option value="students">Students Details</option>
                    <option value="report">View Report</option>
                    <option value="work">Daily Work</option>
                    <option value="bus">Bus On Wheels</option>
                    <option value="low">Low Attendance</option>
                    <option value="presentation">Presentation</option>
                    <option value="marks">Exam</option>
                    <option value="result">Result</option>
                    <option value="analysis">Data Analysis</option>
                </select>
            </div>
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <button class="nav-link active" id="markTab" onclick="showTab('mark')"><i class="bi bi-check2-square"></i><span class="tab-text">Mark Attendance</span></button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="viewTab" onclick="showTab('view')"><i class="bi bi-calendar3"></i><span class="tab-text">View Daily</span></button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="studentsTab" onclick="showTab('students')"><i class="bi bi-people"></i><span class="tab-text">Students Details</span></button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="reportTab" onclick="showTab('report')"><i class="bi bi-clipboard-data"></i><span class="tab-text">View Report</span></button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="workTab" onclick="showTab('work')"><i class="bi bi-journal-check"></i><span class="tab-text">Daily Work</span></button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="busTab" onclick="showTab('bus')"><i class="bi bi-truck"></i><span class="tab-text">Bus On Wheels</span></button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="lowTab" onclick="showTab('low')"><i class="bi bi-exclamation-triangle"></i><span class="tab-text">Low Attendance</span></button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="presentationTab" onclick="showTab('presentation')"><i class="bi bi-easel2"></i><span class="tab-text">Presentation</span></button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="marksTab" onclick="showTab('marks')"><i class="bi bi-award"></i><span class="tab-text">Exam</span></button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="resultTab" onclick="showTab('result')"><i class="bi bi-bar-chart-line"></i><span class="tab-text">Result</span></button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="analysisTab" onclick="showTab('analysis')"><i class="bi bi-graph-up-arrow"></i><span class="tab-text">Data Analysis</span></button>
                </li>
            </ul>
        </div>
        <div class="tabs-hint">Quick Navigation is enabled for mobile and tablet.</div>

        <!-- MARK ATTENDANCE -->
        <div id="markSection">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
                        <h5 class="card-title mb-0">Mark Daily Attendance</h5>
                        <div class="text-muted small d-flex flex-wrap align-items-center gap-3">
                            <span class="d-inline-flex align-items-center gap-1">
                                <i class="bi bi-calendar2-check text-primary"></i>
                                Planned absence auto-marked absent
                            </span>
                            <span class="d-inline-flex align-items-center gap-1">
                                <i class="bi bi-moon-stars-fill text-warning"></i>
                                Absent yesterday
                            </span>
                            <span class="d-inline-flex align-items-center gap-1">
                                <i class="bi bi-moon-stars-fill text-danger"></i>
                                Absent last 2 days
                            </span>
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label>Region</label>
                            <select class="form-select" id="markRegion" onchange="loadMarkBatches(); loadPlannedAbsenceStudentOptions(); loadPlannedAbsenceList();">
                                <option value="">Select Region</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Batch</label>
                            <select class="form-select" id="markBatch" onchange="loadMarkStudents(); loadPlannedAbsenceStudentOptions(); loadPlannedAbsenceList();">
                                <option value="">Select Batch</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Date</label>
                            <input type="date" class="form-control" id="markDate" required onchange="loadMarkStudents(); loadPlannedAbsenceList();">
                        </div>
                    </div>

                    <div class="border rounded p-3 mb-4 bg-light">
                        <h6 class="mb-3">Plan Student Absence</h6>
                        <div class="text-muted small mb-2">You can select past or future dates. Use this for late-reported absence reasons as well.</div>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label>Student</label>
                                <select class="form-select" id="plannedStudent">
                                    <option value="">Select Student</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label>From Date</label>
                                <input type="date" class="form-control" id="plannedFromDate">
                            </div>
                            <div class="col-md-2">
                                <label>To Date</label>
                                <input type="date" class="form-control" id="plannedToDate">
                            </div>
                            <div class="col-md-3">
                                <label>Reason (Required)</label>
                                <input type="text" class="form-control" id="plannedReason" placeholder="e.g. School Tour">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button class="btn btn-primary w-100" onclick="createPlannedAbsence()">Save Reason</button>
                            </div>
                        </div>
                        <div id="plannedAbsenceList" class="mt-3"></div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label>Search (Name/Phone)</label>
                            <input type="text" class="form-control" id="markSearch" placeholder="Type to filter..." oninput="applyMarkFilters()">
                        </div>
                        <div class="col-md-3">
                            <label>Status Filter</label>
                            <select class="form-select" id="markStatusFilter" onchange="applyMarkFilters()">
                                <option value="all">All</option>
                                <option value="not_marked">Not Marked</option>
                                <option value="present">Present</option>
                                <option value="absent">Absent</option>
                            </select>
                        </div>
                        <div class="col-md-5 d-flex align-items-end gap-2 flex-wrap">
                            <button class="btn btn-outline-success btn-sm" onclick="bulkSetStatus('present')">All Present</button>
                            <button class="btn btn-outline-danger btn-sm" onclick="bulkSetStatus('absent')">All Absent</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="bulkClearStatus()">Clear All</button>
                        </div>
                    </div>

                    <div id="markSummary" class="alert alert-light border d-none"></div>
                    <div id="savingBanner" class="alert alert-info d-none">Saving attendance...</div>
                    <div id="studentsTable"></div>
                    <div id="markPagination" class="d-flex justify-content-between align-items-center mt-3"></div>
                </div>
            </div>
        </div>

        <!-- VIEW ATTENDANCE -->
        <div id="viewSection" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">View Attendance Records (Daily)</h5>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label>Region</label>
                            <select class="form-select" id="viewRegion" onchange="loadViewBatches();">
                                <option value="">Select Region</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Batch</label>
                            <select class="form-select" id="viewBatch">
                                <option value="">Select Batch</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Date</label>
                            <input type="date" class="form-control" id="viewDate" required>
                        </div>
                        <div class="col-md-3">
                            <label>Month (for Planned)</label>
                            <input type="month" class="form-control" id="viewPlannedMonth">
                        </div>
                        <div class="col-md-3">
                            <label>Status Filter</label>
                            <select class="form-select" id="viewStatusFilter" onchange="applyViewDailyFilter()">
                                <option value="all">All</option>
                                <option value="present">Present</option>
                                <option value="absent">Absent</option>
                                <option value="not_marked">Not Marked</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>&nbsp;</label>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary w-100" onclick="viewAttendance()">View</button>
                                <button class="btn btn-outline-primary w-100" onclick="viewPlannedStudentsAttendance()">Planned Students Attendance</button>
                                <button class="btn btn-success w-100" onclick="shareDailySummaryAllBatches()">Share Daily Summary</button>
                            </div>
                        </div>
                    </div>

                    <div id="viewResults"></div>
                </div>
            </div>
        </div>

        <!-- VIEW STUDENTS -->
        <div id="studentsSection" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">üë• View All Students</h5>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label>Region</label>
                            <select class="form-select" id="studentsRegion" onchange="loadStudentsBatches();">
                                <option value="">Select Region</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label>Batch</label>
                            <select class="form-select" id="studentsBatch" onchange="loadStudentsData()">
                                <option value="">Select Batch</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-success w-100" onclick="exportStudentsDetails()">
                                Export Students Details
                            </button>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <label>Search (Name/Phone)</label>
                            <input type="text" class="form-control" id="studentsSearch" placeholder="Type to filter..." oninput="applyStudentsFilters()">
                        </div>
                        <div class="col-md-3">
                            <label>Search by Mobile (Fetch)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="studentsMobileLookup" placeholder="Enter mobile number" onkeydown="handleStudentsMobileEnter(event)">
                                <button class="btn btn-outline-primary" type="button" onclick="fetchStudentByMobile()">Search</button>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label>Status Filter</label>
                            <select class="form-select" id="studentsStatusFilter" onchange="applyStudentsFilters()">
                                <option value="all">All</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label>Age Rule</label>
                            <select class="form-select" id="studentsAgeFilter" onchange="applyStudentsFilters()">
                                <option value="all">All Ages</option>
                                <option value="above">Above</option>
                                <option value="below">Below</option>
                                <option value="equal">Equal To</option>
                                <option value="above_or_equal">15 and Above</option>
                                <option value="below_or_equal">15 and Below</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label>Age Number</label>
                            <input type="number" min="0" class="form-control" id="studentsAgeValue" placeholder="e.g. 15" oninput="applyStudentsFilters()">
                        </div>
                    </div>

                    <div id="studentsResults"></div>
                    <div id="studentsPagination" class="d-flex justify-content-between align-items-center mt-3"></div>
                </div>
            </div>
        </div>

        <!-- VIEW REPORT (SUMMARY) -->
        <div id="reportSection" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">üìä Attendance Report (Summary)</h5>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-2">
                            <label>Region</label>
                            <select class="form-select" id="reportRegion" onchange="loadReportBatches();">
                                <option value="">Select Region</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label>Batch</label>
                            <select class="form-select" id="reportBatch">
                                <option value="">Select Batch</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label>Filter Type</label>
                            <select class="form-select" id="filterType" onchange="updateFilterUI()">
                                <option value="date-range">Date Range</option>
                                <option value="month">Month</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label id="dateLabel">Start Date</label>
                            <input type="date" class="form-control" id="reportStartDate">
                        </div>
                        <div class="col-md-2">
                            <label id="endLabel">End Date</label>
                            <input type="date" class="form-control" id="reportEndDate">
                        </div>
                        <div class="col-md-2">
                            <label>&nbsp;</label>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary w-100" onclick="viewReport()">Generate Report</button>
                                <button class="btn btn-success w-100" onclick="shareReportToWhatsApp()">Share to WhatsApp</button>
                            </div>
                        </div>
                    </div>

                    <div id="reportResults"></div>
                </div>
            </div>
        </div>
        
        <!-- DAILY WORK REPORT -->
        <div id="workSection" style="display: none;">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">üìù Daily Work Report</h5>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label>Teacher Name</label>
                            <input type="text" class="form-control" id="workTeacherName" readonly>
                        </div>
                        <div class="col-md-4">
                            <label>Date</label>
                            <input type="date" class="form-control" id="workDate" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label>Topics Taught Today</label>
                        <textarea class="form-control" id="workTopics" rows="3" placeholder="Enter topics covered..." required></textarea>
                    </div>
                    
                    <button class="btn btn-success" onclick="submitWorkReport()">Submit Daily Work</button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">üîç View Daily Work</h5>
                    
                    <div class="row g-3 mb-3 align-items-end">
                        <div class="col-md-4">
                            <label>Teacher</label>
                            <select class="form-select" id="workViewTeacher">
                                <option value="">All Teachers</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Filter Type</label>
                            <select class="form-select" id="workViewFilterType" onchange="updateWorkViewFilterUI()">
                                <option value="date">Date</option>
                                <option value="month">Month</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label id="workViewDateLabel">Date</label>
                            <input type="date" class="form-control" id="workViewDate" required>
                        </div>
                        <div class="col-md-2">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="workViewOnlyMine" onchange="toggleWorkViewOnlyMine()">
                                <label class="form-check-label" for="workViewOnlyMine">Only My Reports</label>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary mb-3" onclick="loadWorkReports()">View Reports</button>
                    <div id="workResults"></div>
                </div>
            </div>
        </div>

        <!-- BUS ON WHEELS -->
        <div id="busSection" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
                        <h5 class="card-title mb-0">Bus On Wheels Inventory</h5>
                        <div class="d-flex gap-2" id="busInventoryActions">
                            <button class="btn btn-outline-primary" onclick="viewBusInventoryDetails()">View Inventory Details</button>
                            <button class="btn btn-outline-success" onclick="shareBusInventoryToWhatsApp()">Share to WhatsApp</button>
                            <button class="btn btn-success" onclick="saveBusInventory()">Save Inventory</button>
                        </div>
                    </div>
                    <div id="busInventoryEditor">
                        <div class="text-muted small mb-3" id="busInventoryMeta">Editable quantity table for equipment tracking.</div>
                        <div class="table-responsive">
                            <table class="table table-bordered align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 24%;">Item Name</th>
                                        <th style="width: 18%;">Category</th>
                                        <th style="width: 14%;">Quantity</th>
                                        <th style="width: 14%;">Location</th>
                                        <th style="width: 30%;">Remarks</th>
                                    </tr>
                                </thead>
                                <tbody id="busInventoryTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="mt-3" id="busInventoryDetails"></div>
                </div>
            </div>
        </div>

        <!-- PRESENTATION -->
        <div id="presentationSection" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Presentation Groups</h5>

                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label>Region</label>
                            <select class="form-select" id="presentationRegion" onchange="loadPresentationBatches()">
                                <option value="">Select Region</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Batch</label>
                            <select class="form-select" id="presentationBatch" onchange="loadPresentationStudents()">
                                <option value="">Select Batch</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Date</label>
                            <input type="date" class="form-control" id="presentationDate" required onchange="loadPresentationStudents()">
                        </div>
                        <div class="col-md-3">
                            <label>&nbsp;</label>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary w-100" onclick="loadPresentationStudents()">Load PPT</button>
                                <button class="btn btn-outline-secondary w-100" onclick="loadPresentationTopics()">Presentation Topics Load</button>
                                <button class="btn btn-outline-dark w-100" onclick="loadPresentationEvaluation()">Presentation Evaluation</button>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 align-items-start">
                        <div class="col-md-4">
                            <label>Presentation Topic</label>
                            <input type="text" class="form-control mb-3" id="presentationTopic1" placeholder="Select two students first" disabled>
                            <div id="presentationGroupCounts" class="text-muted"></div>

                        </div>
                        <div class="col-md-8">
                            <div id="presentationTable"></div>
                            <div id="presentationTopicsTable" class="mt-3"></div>
                            <div id="presentationEvaluationTable" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- EXAM (Marks) -->
        <div id="marksSection" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Enter Exam Marks</h5>

                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label>Region</label>
                            <select class="form-select" id="marksRegion" onchange="loadMarksBatches()">
                                <option value="">Select Region</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Batch</label>
                            <select class="form-select" id="marksBatch" onchange="loadMarksStudents(); loadExamPlan(true);">
                                <option value="">Select Batch</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Date</label>
                            <input type="date" class="form-control" id="marksDate" required onchange="loadMarksStudents()">
                        </div>
                    </div>

                    <div class="card border mt-3 mb-3">
                        <div class="card-body">
                            <h6 class="mb-3">Saved Exam Plan (Region + Batch)</h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label>Project Inauguration Date</label>
                                    <input type="date" class="form-control" id="examPlanInaugurationDate">
                                </div>
                                <div class="col-md-4">
                                    <label>Theory Date</label>
                                    <input type="date" class="form-control" id="examPlanTheoryDate">
                                </div>
                                <div class="col-md-4">
                                    <label>Practical Date</label>
                                    <input type="date" class="form-control" id="examPlanPracticalDate">
                                </div>
                                <div class="col-md-4">
                                    <label>Presentation Date</label>
                                    <input type="date" class="form-control" id="examPlanPresentationDate">
                                </div>
                                <div class="col-md-4">
                                    <label>Certificate Date</label>
                                    <input type="date" class="form-control" id="examPlanCertificateDate">
                                </div>
                                <div class="col-md-4">
                                    <label>&nbsp;</label>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-secondary" onclick="loadExamPlan()">Load Plan</button>
                                        <button class="btn btn-outline-primary" onclick="saveExamPlan()">Save Plan</button>
                                        <button class="btn btn-warning" onclick="viewResultByPlan()">View Result By Saved Plan</button>
                                    </div>
                                </div>
                            </div>
                            <div class="small text-muted mt-2" id="examPlanMeta"></div>
                        </div>
                    </div>
                    <div id="examPlanResults" class="mb-3"></div>

                    <div id="marksTable"></div>
                </div>
            </div>
        </div>

        <!-- RESULT -->
        <div id="resultSection" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Result</h5>

                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label>Region</label>
                            <select class="form-select" id="resultRegion" onchange="loadResultBatches()">
                                <option value="">Select Region</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Batch</label>
                            <select class="form-select" id="resultBatch">
                                <option value="">Select Batch</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Date</label>
                            <input type="date" class="form-control" id="resultDate" required>
                        </div>
                        <div class="col-md-3">
                            <label>&nbsp;</label>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary w-100" onclick="viewResult()">View</button>
                                <button class="btn btn-success w-100" onclick="viewTop3()">Top 3</button>
                                <button class="btn btn-outline-primary w-100" onclick="downloadPassedStudentsCSV()">Download Passed</button>
                                <button class="btn btn-outline-danger w-100" onclick="viewExamMissed()">Exam Missed</button>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mb-2">
                        <div class="col-md-3">
                            <label>Exam Missed Mode</label>
                            <select class="form-select" id="examMissedMode" onchange="toggleExamMissedModeFields()">
                                <option value="single">Single Date</option>
                                <option value="plan">Exam Plan (3 Dates)</option>
                                <option value="range">Date Range</option>
                                <option value="latest">Latest Per Component</option>
                            </select>
                        </div>
                        <div class="col-md-9 d-flex align-items-end">
                            <small class="text-muted" id="examMissedModeHint">
                                Single Date: checks theory, practical, and presentation on selected Date.
                            </small>
                        </div>
                    </div>

                    <div class="row g-3 mb-2" id="examMissedPlanFields" style="display:none;">
                        <div class="col-md-4">
                            <label>Theory Date</label>
                            <input type="date" class="form-control" id="examMissedTheoryDate">
                        </div>
                        <div class="col-md-4">
                            <label>Practical Date</label>
                            <input type="date" class="form-control" id="examMissedPracticalDate">
                        </div>
                        <div class="col-md-4">
                            <label>Presentation Date</label>
                            <input type="date" class="form-control" id="examMissedPresentationDate">
                        </div>
                    </div>

                    <div class="row g-3 mb-3" id="examMissedRangeFields" style="display:none;">
                        <div class="col-md-4">
                            <label>Start Date</label>
                            <input type="date" class="form-control" id="examMissedStartDate">
                        </div>
                        <div class="col-md-4">
                            <label>End Date</label>
                            <input type="date" class="form-control" id="examMissedEndDate">
                        </div>
                    </div>

                    <div id="resultResults"></div>
                </div>
            </div>
        </div>

        <!-- LOW ATTENDANCE -->
        <div id="lowSection" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Low Attendance (Absent 3+ Classes)</h5>

                    <div class="row g-3 mb-3 align-items-end">
                        <div class="col-md-3">
                            <label>Region</label>
                            <select class="form-select" id="lowRegion" onchange="loadLowBatches()">
                                <option value="">Select Region</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Batch</label>
                            <select class="form-select" id="lowBatch">
                                <option value="">Select Batch</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Last N Days</label>
                            <input type="number" class="form-control" id="lowDays" min="1" value="30">
                        </div>
                        <div class="col-md-3">
                            <label>&nbsp;</label>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary w-100" onclick="loadLowAttendance()">Low Attendance</button>
                                <button class="btn btn-outline-success w-100" onclick="loadTopAttendance()">Top Attendance</button>
                                <button class="btn btn-outline-info w-100" onclick="loadInquiredStudents()">Students Inquired</button>
                            </div>
                        </div>
                    </div>

                    <div id="lowResults"></div>
                    <div id="lowInquiredResults" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- DATA ANALYSIS -->
        <div id="analysisSection" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Data Analysis</h5>

                    <div class="row g-3 mb-4 align-items-end">
                        <div class="col-md-3">
                            <label>Region</label>
                            <select class="form-select" id="analysisRegion" onchange="loadAnalysisBatches()">
                                <option value="">Select Region</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Batch</label>
                            <select class="form-select" id="analysisBatch">
                                <option value="">Select Batch</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Start Date</label>
                            <input type="date" class="form-control" id="analysisStartDate">
                        </div>
                        <div class="col-md-3">
                            <label>End Date</label>
                            <input type="date" class="form-control" id="analysisEndDate">
                        </div>
                        <div class="col-md-3">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="runDataAnalysis()">Analyze</button>
                        </div>
                    </div>

                    <div id="analysisSummary" class="mb-3"></div>
                    <div class="row g-3">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Attendance by Batch (Percentage)</h6>
                                    <canvas id="analysisChart" height="220"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="card-title mb-0">Download All-Classes List</h6>
                                        <button class="btn btn-outline-primary btn-sm" onclick="downloadAnalysisCSV()">
                                            Download CSV
                                        </button>
                                    </div>
                                    <div class="text-muted small">
                                        Export students who attended all classes within the selected range.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="dashboard-footer">
        <span>¬© 2026 Digital Literacy for Every Child ‚Äî All Rights Reserved</span>
    </footer>

    <!-- Student Profile Modal -->
    <div class="modal" id="studentProfileModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Student Profile</h5>
                    <button type="button" class="btn-close" onclick="closeModal('studentProfileModal')"></button>
                </div>
                <div class="modal-body" id="studentProfileContent">
                    Loading...
                </div>
            </div>
        </div>
    </div>

    <!-- Inactive Students Modal -->
    <div class="modal" id="inactiveStudentsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Inactive Students Details</h5>
                    <button type="button" class="btn-close" onclick="closeModal('inactiveStudentsModal')"></button>
                </div>
                <div class="modal-body" id="inactiveStudentsContent">
                    <div class="text-muted">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
    <script>
        // DEBUG: Check authentication on page load
        console.log('üîê TEACHER DASHBOARD INITIALIZATION');
        console.log('================================');
        
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        console.log('‚úÖ Token exists:', !!token);
        console.log('‚úÖ User found:', !!user.name);
        
        if (!token) {
            console.error('‚ùå NO TOKEN FOUND - REDIRECTING TO LOGIN');
            console.error('   User must login first at http://localhost:3000');
            window.location.href = '/';
        }
        
        console.log('üë§ Logged in as:', user.name, `(${user.role})`);
        
        document.getElementById('userName').textContent = user.name;
        const workTeacherName = document.getElementById('workTeacherName');
        if (workTeacherName) workTeacherName.value = user.name || '';
        
        // Set today's date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('markDate').value = today;
        document.getElementById('viewDate').value = today;
        document.getElementById('marksDate').value = today;
        document.getElementById('resultDate').value = today;
        const examMissedTheoryDateEl = document.getElementById('examMissedTheoryDate');
        const examMissedPracticalDateEl = document.getElementById('examMissedPracticalDate');
        const examMissedPresentationDateEl = document.getElementById('examMissedPresentationDate');
        const examMissedStartDateEl = document.getElementById('examMissedStartDate');
        const examMissedEndDateEl = document.getElementById('examMissedEndDate');
        if (examMissedTheoryDateEl) examMissedTheoryDateEl.value = today;
        if (examMissedPracticalDateEl) examMissedPracticalDateEl.value = today;
        if (examMissedPresentationDateEl) examMissedPresentationDateEl.value = today;
        if (examMissedStartDateEl) examMissedStartDateEl.value = today;
        if (examMissedEndDateEl) examMissedEndDateEl.value = today;
        const presentationDateEl = document.getElementById('presentationDate');
        if (presentationDateEl) presentationDateEl.value = today;
        const workDateEl = document.getElementById('workDate');
        const workViewDateEl = document.getElementById('workViewDate');
        const viewPlannedMonthEl = document.getElementById('viewPlannedMonth');
        if (workDateEl) workDateEl.value = today;
        if (workViewDateEl) workViewDateEl.value = today;
        if (viewPlannedMonthEl) viewPlannedMonthEl.value = today.slice(0, 7);
        const analysisStartEl = document.getElementById('analysisStartDate');
        const analysisEndEl = document.getElementById('analysisEndDate');
        if (analysisStartEl && analysisEndEl) {
            const start = new Date();
            start.setDate(start.getDate() - 29);
            analysisStartEl.value = start.toISOString().split('T')[0];
            analysisEndEl.value = today;
        }
        function setMaxDates() {
            const maxDate = today;
            const ids = [
                'markDate',
                'viewDate',
                'reportStartDate',
                'reportEndDate',
                'marksDate',
                'resultDate',
                'examMissedTheoryDate',
                'examMissedPracticalDate',
                'examMissedPresentationDate',
                'examMissedStartDate',
                'examMissedEndDate',
                'examPlanInaugurationDate',
                'examPlanTheoryDate',
                'examPlanPracticalDate',
                'examPlanPresentationDate',
                'examPlanCertificateDate',
                'presentationDate',
                'workDate',
                'workViewDate',
                'analysisStartDate',
                'analysisEndDate'
            ];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.max = maxDate;
            });
        }
        function setPlannedAbsenceDates() {
            const fromEl = document.getElementById('plannedFromDate');
            const toEl = document.getElementById('plannedToDate');
            if (!fromEl || !toEl) return;
            const markDate = document.getElementById('markDate')?.value;
            const defaultDate = markDate || today;
            fromEl.value = fromEl.value || defaultDate;
            toEl.value = toEl.value || defaultDate;
            fromEl.addEventListener('change', () => {
                if (toEl.value && fromEl.value && toEl.value < fromEl.value) {
                    toEl.value = fromEl.value;
                }
            });
        }
        setMaxDates();
        setPlannedAbsenceDates();
        toggleExamMissedModeFields();
        updateWorkViewFilterUI();
        loadWorkViewTeachers();

        let currentStudents = [];
        let presentationCurrentStudents = [];
        let presentationEvaluationStudents = [];
        let lastViewAttendance = null;
        let lastViewRawStudents = [];
        let lastReportShareData = null;
        let analysisChart = null;
        let markFiltered = [];
        let markPage = 1;
        const markPageSize = 25;
        let lastMarkSubmission = null;
        let markSelections = new Map();
        let currentPlannedAbsences = [];
        let studentsData = [];
        let studentsFiltered = [];
        let studentsPage = 1;
        const studentsPageSize = 25;
        let busInventoryData = [];
        
        console.log('üìç Current page:', window.location.pathname);
        console.log('üöÄ Loading initial data...');
        console.log('================================');

        // TAB SWITCHING
        async function loadStats() {
            try {
                const res = await fetch('/api/students/stats/dashboard', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }

                const data = await res.json();
                const totalEl = document.getElementById('totalStudents');
                if (totalEl) totalEl.textContent = data.total;
                const activeEl = document.getElementById('activeStudents');
                if (activeEl) activeEl.textContent = data.active || 0;
                const inactiveEl = document.getElementById('inactiveStudents');
                if (inactiveEl) inactiveEl.textContent = data.inactive || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function autoInactivateByAbsence() {
            try {
                const res = await fetch('/api/students/auto-inactivate-absent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ threshold: 5 })
                });
                if (!res.ok) return;
                await loadStats();
                await loadInactiveNames();
            } catch (error) {
                console.error('Error auto-inactivating students:', error);
            }
        }

        async function loadInactiveNames() {
            const metaEl = document.getElementById('inactiveStudentsMeta');
            const linkEl = document.getElementById('inactiveDetailsLink');
            if (!metaEl || !linkEl) return;

            try {
                const res = await fetch('/api/students/inactive-names?limit=20', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }
                const data = await res.json();
                const total = data.total || 0;
                metaEl.textContent = total ? `Total inactive: ${total}` : 'No inactive students';
                linkEl.disabled = total === 0;
            } catch (error) {
                console.error('Error loading inactive students:', error);
                metaEl.textContent = 'Failed to load';
                linkEl.disabled = true;
            }
        }

        async function openInactiveDetails() {
            const contentEl = document.getElementById('inactiveStudentsContent');
            if (contentEl) contentEl.innerHTML = 'Loading...';
            new bootstrap.Modal(document.getElementById('inactiveStudentsModal')).show();

            try {
                const res = await fetch('/api/students/inactive-details', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }
                const data = await res.json();
                const rows = data.students || [];
                if (!rows.length) {
                    contentEl.innerHTML = '<div class="alert alert-info">No inactive students found.</div>';
                    return;
                }

                const hasAnyPhone = rows.some(s => getTelData(s.mobile));
                let html = `
                    <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Student Name</th>
                                <th>Batch</th>
                                <th class="text-center">Total Classes</th>
                                <th class="text-center">Absent</th>
                                ${hasAnyPhone ? '<th class="text-center">Call</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>
                `;
                rows.forEach((s, index) => {
                    const tel = getTelData(s.mobile);
                    const callButton = tel
                        ? buildCallButtonHtml(s.studentId, s.mobile, 'inactive-students', 'Call Parent')
                        : '';
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${escapeHtml(s.name)}</td>
                            <td>${escapeHtml(s.batchNumber || '-')}</td>
                            <td class="text-center">${s.totalClasses || 0}</td>
                            <td class="text-center">${s.absentCount || 0}</td>
                            ${hasAnyPhone ? `<td class="text-center">${callButton}</td>` : ''}
                        </tr>
                    `;
                });
                html += '</tbody></table></div>';
                contentEl.innerHTML = html;
            } catch (error) {
                if (contentEl) {
                    contentEl.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
                }
            }
        }

        let lastEngagement = null;

        function renderEngagementTable(rows, mode) {
            if (!rows || rows.length === 0) return '';
            let html = `
                <div class="table-responsive">
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Batch</th>
                            <th class="text-center">${mode === 'improvement' ? 'Improvement' : 'Attendance'}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            rows.forEach((s, index) => {
                const value = mode === 'improvement' ? `+${s.improvement}%` : `${s.recent.rate}%`;
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${escapeHtml(s.name)}</td>
                        <td>${escapeHtml(s.batchNumber || '-')}</td>
                        <td class="text-center">${value}</td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
            return html;
        }

        async function loadTopAttendance() {
            const region = document.getElementById('lowRegion')?.value;
            const batch = document.getElementById('lowBatch')?.value || 'all';
            const days = document.getElementById('lowDays')?.value || '30';
            const resultsEl = document.getElementById('lowResults');
            if (!resultsEl) return;
            if (!region) {
                alert('Please select region');
                return;
            }

            try {
                resultsEl.innerHTML = '<div class="text-muted">Loading...</div>';
                const res = await fetch(
                    `/api/attendance/engagement?region=${encodeURIComponent(region)}&batchNumber=${encodeURIComponent(batch)}&days=${encodeURIComponent(days)}`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                const data = await res.json();
                lastEngagement = data;

                const topAttendance = data.topAttendance || [];
                if (!topAttendance.length) {
                    resultsEl.innerHTML = '<div class="alert alert-info">No attendance data found for this period.</div>';
                    return;
                }

                let html = `
                    <div class="alert alert-success">
                        <strong>Top Attendance</strong> (Last ${days} days)
                    </div>
                    ${renderEngagementTable(topAttendance, 'rate')}
                    <button class="btn btn-outline-success mt-2" onclick="shareTopAttendance()">Share Top Attendance</button>
                `;
                resultsEl.innerHTML = html;
            } catch (error) {
                console.error('Error loading top attendance:', error);
                resultsEl.innerHTML = `<div class="alert alert-danger">Failed to load top attendance: ${error.message}</div>`;
            }
        }

        function shareTopAttendance() {
            if (!lastEngagement) {
                alert('Please load top attendance first.');
                return;
            }
            const top = lastEngagement.topAttendance || [];
            const lines = top.map((s, i) => `${i + 1}. ${s.name} (${s.recent.rate}%)`).slice(0, 10);
            const message = [
                'Top Attendance',
                ...(lines.length ? lines : ['No data'])
            ].join('\n');
            window.open(buildWhatsAppLink(message), '_blank');
        }

        function jumpToTabFromSelect(tab) {
            if (!tab) return;
            showTab(tab);
        }

        function showTab(tab) {
            const quickNav = document.getElementById('tabQuickNav');
            if (quickNav && quickNav.value !== tab) {
                quickNav.value = tab;
            }

            const sections = [
                'markSection',
                'viewSection',
                'studentsSection',
                'reportSection',
                'workSection',
                'busSection',
                'lowSection',
                'analysisSection',
                'marksSection',
                'resultSection',
                'presentationSection'
            ];
            const tabs = [
                'markTab',
                'viewTab',
                'studentsTab',
                'reportTab',
                'workTab',
                'busTab',
                'lowTab',
                'analysisTab',
                'marksTab',
                'resultTab',
                'presentationTab'
            ];

            sections.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            tabs.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('active');
            });

            if (tab === 'mark') {
                document.getElementById('markSection').style.display = 'block';
                document.getElementById('markTab').classList.add('active');
                loadRegions();
            } else if (tab === 'view') {
                document.getElementById('viewSection').style.display = 'block';
                document.getElementById('viewTab').classList.add('active');
                loadRegions();
            } else if (tab === 'students') {
                document.getElementById('studentsSection').style.display = 'block';
                document.getElementById('studentsTab').classList.add('active');
                loadStudentsRegions();
            } else if (tab === 'report') {
                document.getElementById('reportSection').style.display = 'block';
                document.getElementById('reportTab').classList.add('active');
                loadReportRegions();
            } else if (tab === 'work') {
                document.getElementById('workSection').style.display = 'block';
                document.getElementById('workTab').classList.add('active');
            } else if (tab === 'bus') {
                document.getElementById('busSection').style.display = 'block';
                document.getElementById('busTab').classList.add('active');
                loadBusInventory();
            } else if (tab === 'presentation') {
                document.getElementById('presentationSection').style.display = 'block';
                document.getElementById('presentationTab').classList.add('active');
                loadPresentationRegions();
            } else if (tab === 'marks') {
                document.getElementById('marksSection').style.display = 'block';
                document.getElementById('marksTab').classList.add('active');
                loadMarksRegions();
            } else if (tab === 'result') {
                document.getElementById('resultSection').style.display = 'block';
                document.getElementById('resultTab').classList.add('active');
                loadResultRegions();
            } else if (tab === 'analysis') {
                document.getElementById('analysisSection').style.display = 'block';
                document.getElementById('analysisTab').classList.add('active');
                loadAnalysisRegions();
            } else if (tab === 'low') {
                document.getElementById('lowSection').style.display = 'block';
                document.getElementById('lowTab').classList.add('active');
                loadLowRegions();
            }
        }

        // LOAD REGIONS
        async function loadRegions() {
            try {
                console.log('üìö Loading regions...');
                const res = await fetch('/api/students/regions/all', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) {
                    console.error('‚ùå API Error:', res.status, res.statusText);
                    throw new Error(`API Error: ${res.status}`);
                }
                
                const regions = await res.json();
                console.log('‚úÖ Regions loaded:', regions);
                
                const markRegion = document.getElementById('markRegion');
                const viewRegion = document.getElementById('viewRegion');
                
                if (!markRegion || !viewRegion) {
                    console.error('‚ùå Region dropdowns not found in DOM');
                    return;
                }
                
                markRegion.innerHTML = '<option value="">Select Region</option>';
                viewRegion.innerHTML = '<option value="">Select Region</option>';
                
                if (!regions || regions.length === 0) {
                    console.warn('‚ö†Ô∏è No regions found');
                    markRegion.innerHTML += '<option disabled>No regions available</option>';
                    viewRegion.innerHTML += '<option disabled>No regions available</option>';
                    return;
                }
                
                regions.forEach(region => {
                    markRegion.innerHTML += `<option value="${region}">${region}</option>`;
                    viewRegion.innerHTML += `<option value="${region}">${region}</option>`;
                });
                console.log('‚úÖ Region dropdowns populated');
            } catch (error) {
                console.error('‚ùå Error loading regions:', error);
                alert('Error loading regions: ' + error.message);
            }
        }

        async function loadSummaryRegions() {
            try {
                const res = await fetch('/api/students/regions/all', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }

                const regions = await res.json();
                const select = document.getElementById('summaryRegion');
                if (!select) return;

                select.innerHTML = '<option value="">Select Region</option>';
                regions.forEach(region => {
                    select.innerHTML += `<option value="${region}">${region}</option>`;
                });
            } catch (error) {
                console.error('‚ùå Error loading summary regions:', error);
            }
        }

        async function updateSelectedRegionCount() {
            const select = document.getElementById('summaryRegion');
            if (!select) return;
            const region = select.value;
            if (!region) {
                document.getElementById('selectedRegionCount').innerHTML = '';
                return;
            }

            try {
                const res = await fetch(`/api/students/region-summary/${encodeURIComponent(region)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }

                const summary = await res.json();
                const formatSummaryDate = (value) => {
                    if (!value) return 'Not available';
                    const dt = new Date(value);
                    if (Number.isNaN(dt.getTime())) return escapeHtml(String(value));
                    return dt.toLocaleDateString();
                };

                document.getElementById('selectedRegionCount').innerHTML = `
                    <div class="alert alert-info">
                        <h6 class="mb-3">Region Summary: <strong>${escapeHtml(region)}</strong></h6>
                        <div class="row g-2">
                            <div class="col-md-4"><strong>Total Enrolled:</strong> ${summary.totalStudents || 0}</div>
                            <div class="col-md-4"><strong>Project Inauguration Date:</strong> ${formatSummaryDate(summary.projectInaugurationDate)}</div>
                            <div class="col-md-4"><strong>Theory Date:</strong> ${formatSummaryDate(summary.theoryDate)}</div>
                            <div class="col-md-4"><strong>Practical Date:</strong> ${formatSummaryDate(summary.practicalDate)}</div>
                            <div class="col-md-4"><strong>Presentation Date:</strong> ${formatSummaryDate(summary.presentationDate)}</div>
                            <div class="col-md-4"><strong>Certificate Date:</strong> ${formatSummaryDate(summary.certificateDate)}</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading region summary:', error);
                document.getElementById('selectedRegionCount').innerHTML =
                    `<div class="alert alert-danger">Error loading region summary: ${error.message}</div>`;
            }
        }

        async function loadWorkViewTeachers() {
            try {
                const res = await fetch('/api/users/teachers', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }

                const users = await res.json();
                const select = document.getElementById('workViewTeacher');
                if (!select) return;

                select.innerHTML = '<option value="">All Teachers</option>';
                users.forEach(u => {
                    select.innerHTML += `<option value="${u._id}">${u.name}</option>`;
                });

                if (user && user._id) {
                    select.dataset.currentUserId = user._id;
                }
                toggleWorkViewOnlyMine();
            } catch (error) {
                console.error('‚ùå Error loading teachers:', error);
            }
        }

        function toggleWorkViewOnlyMine() {
            const checkbox = document.getElementById('workViewOnlyMine');
            const select = document.getElementById('workViewTeacher');
            if (!checkbox || !select) return;

            if (checkbox.checked) {
                const currentUserId = select.dataset.currentUserId || (user && user._id ? user._id : '');
                if (currentUserId) {
                    select.value = currentUserId;
                }
                select.disabled = true;
            } else {
                select.disabled = false;
            }
        }

        function updateWorkViewFilterUI() {
            const filterTypeEl = document.getElementById('workViewFilterType');
            const dateLabel = document.getElementById('workViewDateLabel');
            const dateInput = document.getElementById('workViewDate');
            if (!filterTypeEl || !dateLabel || !dateInput) return;

            if (filterTypeEl.value === 'month') {
                dateLabel.textContent = 'Month';
                dateInput.type = 'month';
                dateInput.value = new Date().toISOString().slice(0, 7);
            } else {
                dateLabel.textContent = 'Date';
                dateInput.type = 'date';
                dateInput.value = new Date().toISOString().split('T')[0];
            }
        }

                // MARKS FUNCTIONS
        let marksCurrentStudents = [];

        // PRESENTATION FUNCTIONS
        async function loadPresentationRegions() {
            try {
                const res = await fetch('/api/students/regions/all', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                const regions = await res.json();
                const select = document.getElementById('presentationRegion');
                if (!select) return;
                select.innerHTML = '<option value="">Select Region</option>';
                regions.forEach(region => {
                    select.innerHTML += `<option value="${region}">${region}</option>`;
                });
                const batchSelect = document.getElementById('presentationBatch');
                if (batchSelect) batchSelect.innerHTML = '<option value="">Select Batch</option>';
                document.getElementById('presentationTable').innerHTML = '';
                document.getElementById('presentationTopicsTable').innerHTML = '';
                document.getElementById('presentationEvaluationTable').innerHTML = '';
                document.getElementById('presentationGroupCounts').innerHTML = '';
            } catch (error) {
                console.error('Error loading presentation regions:', error);
            }
        }

        async function loadPresentationBatches() {
            const region = document.getElementById('presentationRegion').value;
            const select = document.getElementById('presentationBatch');
            if (!select) return;
            if (!region) {
                select.innerHTML = '<option value="">Select Batch</option>';
                document.getElementById('presentationTable').innerHTML = '';
                document.getElementById('presentationTopicsTable').innerHTML = '';
                document.getElementById('presentationEvaluationTable').innerHTML = '';
                return;
            }

            try {
                const res = await fetch(`/api/students/batches/${encodeURIComponent(region)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                const batches = await res.json();
                select.innerHTML = '<option value="">Select Batch</option>';
                batches.forEach(batch => {
                    select.innerHTML += `<option value="${batch}">${batch}</option>`;
                });
                document.getElementById('presentationTable').innerHTML = '';
                document.getElementById('presentationTopicsTable').innerHTML = '';
                document.getElementById('presentationEvaluationTable').innerHTML = '';
            } catch (error) {
                console.error('Error loading presentation batches:', error);
            }
        }

        function computePresentationCounts() {
            let group1 = 0;
            const selectedNames = [];
            presentationCurrentStudents.forEach(student => {
                const checkbox = document.getElementById(`presentationGroup_${student._id}`);
                if (checkbox?.checked && !checkbox.disabled) {
                    group1 += 1;
                    selectedNames.push(student.name);
                }
            });
            return { group1, selectedNames };
        }

        function updatePresentationCounts() {
            const counts = computePresentationCounts();
            const el = document.getElementById('presentationGroupCounts');
            const topicInput = document.getElementById('presentationTopic1');
            const saveBtn = document.getElementById('savePresentationBtn');
            if (el) {
                const names = counts.selectedNames.join(' & ');
                el.textContent = `Selected Students: ${counts.group1}/2${names ? ` (${names})` : ''}`;
            }
            const ready = counts.group1 >= 1 && counts.group1 <= 2;
            if (topicInput) {
                topicInput.disabled = !ready;
                if (!ready) {
                    topicInput.value = '';
                    topicInput.placeholder = 'Select one or two students first';
                } else {
                    topicInput.placeholder = 'Enter presentation topic';
                }
            }
            if (saveBtn) {
                saveBtn.disabled = !ready;
            }
        }

        function handlePresentationGroupChange(studentId) {
            const checkbox = document.getElementById(`presentationGroup_${studentId}`);
            if (!checkbox) return;
            const counts = computePresentationCounts();
            if (counts.group1 > 2) {
                checkbox.checked = false;
                alert('Only two students can be selected.');
            }
            updatePresentationCounts();
        }

        async function loadPresentationStudents() {
            const region = document.getElementById('presentationRegion').value;
            const batch = document.getElementById('presentationBatch').value;
            const date = document.getElementById('presentationDate').value;

            if (!region || !batch || !date) return;

            try {
                document.getElementById('presentationTopicsTable').innerHTML = '';
                document.getElementById('presentationEvaluationTable').innerHTML = '';
                const res = await fetch(
                    `/api/presentations/by-batch?region=${encodeURIComponent(region)}&batchNumber=${encodeURIComponent(batch)}&date=${date}`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                const data = await res.json();
                presentationCurrentStudents = data.students || [];

                const topic1 = document.getElementById('presentationTopic1');
                if (topic1) {
                    topic1.value = '';
                    topic1.disabled = true;
                    topic1.placeholder = 'Select one or two students first';
                }

                if (!presentationCurrentStudents || presentationCurrentStudents.length === 0) {
                    document.getElementById('presentationTable').innerHTML =
                        '<div class="alert alert-warning">No students found in this batch</div>';
                    document.getElementById('presentationTopicsTable').innerHTML = '';
                    document.getElementById('presentationGroupCounts').innerHTML = '';
                    return;
                }

                let html = `
                    <table class="table table-sm table-striped">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Student Name</th>
                                <th class="text-center">Group (Only 2)</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                presentationCurrentStudents.forEach((student, index) => {
                    const hasSavedTopic = !!student.presentation?.topic;
                    const labelText = hasSavedTopic ? 'Saved' : 'Select';
                    html += `
                        <tr>
                            <td class="align-middle">${index + 1}</td>
                            <td class="align-middle fw-semibold">${student.name}</td>
                            <td class="align-middle text-center">
                                <div class="form-check d-inline-flex align-items-center gap-2">
                                    <input class="form-check-input" type="checkbox" id="presentationGroup_${student._id}"
                                        ${hasSavedTopic ? 'checked disabled' : ''} onchange="handlePresentationGroupChange('${student._id}')">
                                    <label class="form-check-label" for="presentationGroup_${student._id}">${labelText}</label>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                    <button class="btn btn-success btn-lg mt-3" id="savePresentationBtn" onclick="submitPresentations()" disabled>
                        Save Presentation Group
                    </button>
                `;

                document.getElementById('presentationTable').innerHTML = html;
                updatePresentationCounts();
            } catch (error) {
                console.error('Error loading presentation students:', error);
                document.getElementById('presentationTable').innerHTML =
                    `<div class="alert alert-danger">Error loading presentations: ${error.message}</div>`;
            }
        }

        async function loadPresentationTopics() {
            const region = document.getElementById('presentationRegion').value;
            const batch = document.getElementById('presentationBatch').value;
            const date = document.getElementById('presentationDate').value;

            if (!region || !batch || !date) {
                alert('Please select region, batch, and date');
                return;
            }

            try {
                document.getElementById('presentationTable').innerHTML = '';
                document.getElementById('presentationGroupCounts').innerHTML = '';
                document.getElementById('presentationEvaluationTable').innerHTML = '';
                const res = await fetch(
                    `/api/presentations/by-batch?region=${encodeURIComponent(region)}&batchNumber=${encodeURIComponent(batch)}&date=${date}`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                const data = await res.json();
                const students = data.students || [];

                if (!students.length) {
                    document.getElementById('presentationTopicsTable').innerHTML =
                        '<div class="alert alert-warning">No students found in this batch</div>';
                    return;
                }

                const totalStudents = students.length;
                const withPresentation = students.filter(s => s.presentation && s.presentation.groupNumber).length;
                const withTopic = students.filter(s => s.presentation && s.presentation.topic).length;
                const missingTopics = totalStudents - withTopic;
                const missingAssignments = totalStudents - withPresentation;

                const groups = new Map();
                students.forEach(student => {
                    const groupNumber = student.presentation?.groupNumber;
                    if (!groupNumber) return;
                    if (!groups.has(groupNumber)) {
                        groups.set(groupNumber, { groupNumber, topic: student.presentation?.topic || '', members: [] });
                    }
                    groups.get(groupNumber).members.push(student);
                });

                const groupList = Array.from(groups.values()).sort((a, b) => a.groupNumber - b.groupNumber);

                let html = `
                    <div class="alert alert-info">
                        <div class="fw-semibold">Presentation Topics Summary</div>
                        <div>Total Students: <strong>${totalStudents}</strong></div>
                        <div>Assigned to Group: <strong>${withPresentation}</strong></div>
                        <div>Topics Filled: <strong>${withTopic}</strong></div>
                        <div class="text-danger">Missing Topics: <strong>${missingTopics}</strong></div>
                        <div class="text-danger">Missing Assignments: <strong>${missingAssignments}</strong></div>
                    </div>
                `;

                if (groupList.length === 0) {
                    html += '<div class="alert alert-warning">No presentation groups found yet.</div>';
                    document.getElementById('presentationTopicsTable').innerHTML = html;
                    return;
                }

                html += `
                    <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Group</th>
                                <th>Members</th>
                                <th>Topic</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                groupList.forEach(group => {
                    const memberList = group.members.map(m => `
                        <div class="d-flex align-items-center justify-content-between gap-2">
                            <span>${m.name}</span>
                            <button class="btn btn-sm btn-outline-danger" onclick="unassignPresentationStudent('${m._id}')">Unassign</button>
                        </div>
                    `).join('');
                    html += `
                        <tr>
                            <td class="fw-semibold">Team ${group.groupNumber}</td>
                            <td>${memberList}</td>
                            <td>
                                <input type="text" class="form-control form-control-sm"
                                    id="topic_group_${group.groupNumber}" value="${group.topic || ''}" placeholder="Enter topic">
                            </td>
                            <td class="text-center">
                                <div class="d-flex gap-2 justify-content-center">
                                    <button class="btn btn-sm btn-success" onclick="saveGroupTopic(${group.groupNumber})">Save</button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="clearGroupTopic(${group.groupNumber})">Clear</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                    </div>
                `;

                document.getElementById('presentationTopicsTable').innerHTML = html;
            } catch (error) {
                console.error('Error loading presentation topics:', error);
                document.getElementById('presentationTopicsTable').innerHTML =
                    `<div class="alert alert-danger">Error loading topics: ${error.message}</div>`;
            }
        }

        async function loadPresentationEvaluation() {
            const region = document.getElementById('presentationRegion').value;
            const batch = document.getElementById('presentationBatch').value;
            const date = document.getElementById('presentationDate').value;

            if (!region || !batch || !date) {
                alert('Please select region, batch, and date');
                return;
            }

            try {
                document.getElementById('presentationTable').innerHTML = '';
                document.getElementById('presentationTopicsTable').innerHTML = '';
                document.getElementById('presentationGroupCounts').innerHTML = '';
                const res = await fetch(
                    `/api/presentations/by-batch?region=${encodeURIComponent(region)}&batchNumber=${encodeURIComponent(batch)}&date=${date}`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                const data = await res.json();
                const students = data.students || [];

                presentationEvaluationStudents = students
                    .filter(s => s.presentation && s.presentation.topic)
                    .sort((a, b) => {
                        const ga = a.presentation?.groupNumber ?? 9999;
                        const gb = b.presentation?.groupNumber ?? 9999;
                        if (ga !== gb) return ga - gb;
                        return (a.name || '').localeCompare(b.name || '');
                    });

                if (!presentationEvaluationStudents.length) {
                    document.getElementById('presentationEvaluationTable').innerHTML =
                        '<div class="alert alert-warning">No presentation topics found to evaluate</div>';
                    return;
                }

                let html = `
                    <div class="alert alert-info">Presentation Evaluation</div>
                    <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Student Name</th>
                                <th>Topic</th>
                                <th>Group</th>
                                <th class="text-center">Content (10)</th>
                                <th class="text-center">Design (5)</th>
                                <th class="text-center">Communication (5)</th>
                                <th class="text-center">Total (20)</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                presentationEvaluationStudents.forEach((student, index) => {
                    const evalData = student.presentation?.evaluation || {};
                    const content = Number.isFinite(evalData.content) ? evalData.content : '';
                    const design = Number.isFinite(evalData.design) ? evalData.design : '';
                    const communication = Number.isFinite(evalData.communication) ? evalData.communication : '';
                    const topic = student.presentation?.topic || '-';
                    const groupNumber = student.presentation?.groupNumber || '-';
                    const locked = !!student.presentation?.evaluationLocked;
                    const total = (Number(content || 0) + Number(design || 0) + Number(communication || 0));

                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${student.name}</td>
                            <td>${topic}</td>
                            <td>${groupNumber}</td>
                            <td class="text-center">
                                <input type="number" class="form-control form-control-sm text-center"
                                    id="eval_content_${student._id}" min="0" max="10" value="${content}"
                                    ${locked ? 'disabled' : ''} oninput="updateEvaluationTotal('${student._id}')">
                            </td>
                            <td class="text-center">
                                <input type="number" class="form-control form-control-sm text-center"
                                    id="eval_design_${student._id}" min="0" max="5" value="${design}"
                                    ${locked ? 'disabled' : ''} oninput="updateEvaluationTotal('${student._id}')">
                            </td>
                            <td class="text-center">
                                <input type="number" class="form-control form-control-sm text-center"
                                    id="eval_comm_${student._id}" min="0" max="5" value="${communication}"
                                    ${locked ? 'disabled' : ''} oninput="updateEvaluationTotal('${student._id}')">
                            </td>
                            <td class="text-center">
                                <span class="badge bg-info" id="eval_total_${student._id}">${total}</span>
                                ${locked ? '<div class="mt-1"><span class="badge bg-secondary">Locked</span></div>' : ''}
                            </td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success mt-3" onclick="savePresentationEvaluation()">Save Evaluation</button>
                        <button class="btn btn-outline-secondary mt-3" onclick="lockAllPresentationEvaluations(true)">Lock All Evaluations</button>
                        <button class="btn btn-outline-warning mt-3" onclick="lockAllPresentationEvaluations(false)">Unlock All Evaluations</button>
                    </div>
                `;

                document.getElementById('presentationEvaluationTable').innerHTML = html;
                document.getElementById('presentationEvaluationTable').scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (error) {
                console.error('Error loading presentation evaluation:', error);
                document.getElementById('presentationEvaluationTable').innerHTML =
                    `<div class="alert alert-danger">Error loading evaluation: ${error.message}</div>`;
            }
        }


        async function savePresentationEvaluation() {
            const region = document.getElementById('presentationRegion').value;
            const batch = document.getElementById('presentationBatch').value;
            const date = document.getElementById('presentationDate').value;

            if (!region || !batch || !date) {
                alert('Please select region, batch, and date');
                return;
            }

            if (!presentationEvaluationStudents || presentationEvaluationStudents.length === 0) {
                alert('No students to evaluate');
                return;
            }

            const evaluations = presentationEvaluationStudents.map(student => {
                const content = Number(document.getElementById(`eval_content_${student._id}`)?.value || '');
                const design = Number(document.getElementById(`eval_design_${student._id}`)?.value || '');
                const communication = Number(document.getElementById(`eval_comm_${student._id}`)?.value || '');
                return {
                    studentId: student._id,
                    content: Number.isFinite(content) ? content : null,
                    design: Number.isFinite(design) ? design : null,
                    communication: Number.isFinite(communication) ? communication : null
                };
            });

            try {
                const res = await fetch('/api/presentations/evaluate', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        region,
                        batchNumber: batch,
                        date,
                        evaluations
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Save failed');
                alert('Evaluation saved.');
                loadPresentationEvaluation();
            } catch (error) {
                console.error('Error saving presentation evaluation:', error);
                alert(error.message);
            }
        }

        function updateEvaluationTotal(studentId) {
            const content = Number(document.getElementById(`eval_content_${studentId}`)?.value || 0);
            const design = Number(document.getElementById(`eval_design_${studentId}`)?.value || 0);
            const communication = Number(document.getElementById(`eval_comm_${studentId}`)?.value || 0);
            const total = Math.max(0, Math.min(20, content + design + communication));
            const totalEl = document.getElementById(`eval_total_${studentId}`);
            if (totalEl) totalEl.textContent = String(total);
        }

        async function lockAllPresentationEvaluations(locked) {
            const region = document.getElementById('presentationRegion').value;
            const batch = document.getElementById('presentationBatch').value;
            const date = document.getElementById('presentationDate').value;

            if (!region || !batch || !date) {
                alert('Please select region, batch, and date');
                return;
            }

            const ids = (presentationEvaluationStudents || []).map(s => s._id);
            if (!ids.length) {
                alert('No students to lock');
                return;
            }

            try {
                const res = await fetch('/api/presentations/lock-evaluation', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        region,
                        batchNumber: batch,
                        date,
                        studentIds: ids,
                        locked: !!locked
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Lock failed');
                alert(locked ? 'Evaluation locked.' : 'Evaluation unlocked.');
                loadPresentationEvaluation();
            } catch (error) {
                console.error('Error locking evaluation:', error);
                alert(error.message);
            }
        }

        async function submitPresentations() {
            const region = document.getElementById('presentationRegion').value;
            const batch = document.getElementById('presentationBatch').value;
            const date = document.getElementById('presentationDate').value;

            if (!region || !batch || !date) {
                alert('Please select region, batch, and date');
                return;
            }

            const counts = computePresentationCounts();
            if (counts.group1 < 1 || counts.group1 > 2) {
                alert('Please select one or two students for the group.');
                return;
            }

            const topicValue = document.getElementById('presentationTopic1')?.value?.trim();
            if (!topicValue) {
                alert('Please enter a presentation topic for the selected team.');
                return;
            }

            const maxGroup = presentationCurrentStudents.reduce((max, student) => {
                const groupNum = Number(student.presentation?.groupNumber || 0);
                return groupNum > max ? groupNum : max;
            }, 0);
            const nextGroupNumber = maxGroup + 1;

            const assignments = presentationCurrentStudents
                .filter(student => {
                    const groupEl = document.getElementById(`presentationGroup_${student._id}`);
                    return !!groupEl?.checked && !groupEl?.disabled;
                })
                .map(student => ({
                    studentId: student._id,
                    groupNumber: nextGroupNumber
                }));

            const groupTopics = {};
            groupTopics[nextGroupNumber] = topicValue;

            const payload = {
                region,
                batchNumber: batch,
                date,
                topic: topicValue,
                groupTopics,
                assignments
            };

            try {
                const res = await fetch('/api/presentations/save', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Save failed');
                alert('Presentation saved.');
                loadPresentationStudents();
            } catch (error) {
                console.error('Error saving presentations:', error);
                alert(error.message);
            }
        }


        async function saveGroupTopic(groupNumber) {
            const region = document.getElementById('presentationRegion').value;
            const batch = document.getElementById('presentationBatch').value;
            const date = document.getElementById('presentationDate').value;
            const input = document.getElementById(`topic_group_${groupNumber}`);
            const topic = input?.value?.trim() || '';

            if (!region || !batch || !date) {
                alert('Please select region, batch, and date');
                return;
            }

            try {
                const res = await fetch('/api/presentations/update-topic', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        region,
                        batchNumber: batch,
                        date,
                        groupNumber,
                        topic
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Update failed');
                alert('Topic updated.');
                loadPresentationTopics();
            } catch (error) {
                console.error('Error updating topic:', error);
                alert(error.message);
            }
        }

        async function clearGroupTopic(groupNumber) {
            if (!confirm('Clear topic for this group?')) return;
            const input = document.getElementById(`topic_group_${groupNumber}`);
            if (input) input.value = '';
            await saveGroupTopic(groupNumber);
        }

        async function unassignPresentationStudent(studentId) {
            if (!confirm('Unassign this student from presentation?')) return;

            const region = document.getElementById('presentationRegion').value;
            const batch = document.getElementById('presentationBatch').value;
            const date = document.getElementById('presentationDate').value;

            if (!region || !batch || !date) {
                alert('Please select region, batch, and date');
                return;
            }

            try {
                const res = await fetch('/api/presentations/unassign', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        region,
                        batchNumber: batch,
                        date,
                        studentIds: [studentId]
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Unassign failed');
                alert('Student unassigned.');
                loadPresentationTopics();
            } catch (error) {
                console.error('Error unassigning student:', error);
                alert(error.message);
            }
        }

        // MARKS FUNCTIONS
        async function loadMarksRegions() {
            try {
                const res = await fetch('/api/students/regions/all', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                const regions = await res.json();
                const select = document.getElementById('marksRegion');
                if (!select) return;
                select.innerHTML = '<option value="">Select Region</option>';
                regions.forEach(region => {
                    select.innerHTML += `<option value="${region}">${region}</option>`;
                });
                document.getElementById('marksBatch').innerHTML = '<option value="">Select Batch</option>';
                document.getElementById('marksTable').innerHTML = '';
            } catch (error) {
                console.error('Error loading marks regions:', error);
            }
        }

        async function loadMarksBatches() {
            const region = document.getElementById('marksRegion').value;
            const select = document.getElementById('marksBatch');
            if (!select) return;
            if (!region) {
                select.innerHTML = '<option value="">Select Batch</option>';
                document.getElementById('marksTable').innerHTML = '';
                const planResultsEl = document.getElementById('examPlanResults');
                if (planResultsEl) planResultsEl.innerHTML = '';
                setExamPlanInputs(null);
                return;
            }

            try {
                const res = await fetch(`/api/students/batches/${encodeURIComponent(region)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                const batches = await res.json();
                select.innerHTML = '<option value="all">All Batches</option>';
                batches.forEach(batch => {
                    select.innerHTML += `<option value="${batch}">${batch}</option>`;
                });
                select.value = 'all';
                document.getElementById('marksTable').innerHTML = '';
                const planResultsEl = document.getElementById('examPlanResults');
                if (planResultsEl) planResultsEl.innerHTML = '';
                setExamPlanInputs(null);
            } catch (error) {
                console.error('Error loading marks batches:', error);
            }
        }

        async function loadMarksStudents() {
            const region = document.getElementById('marksRegion').value;
            const batch = document.getElementById('marksBatch').value;
            const date = document.getElementById('marksDate').value;
            const planResultsEl = document.getElementById('examPlanResults');
            if (planResultsEl) planResultsEl.innerHTML = '';

            if (!region || !batch || !date) return;

                try {
                    const res = await fetch(
                        `/api/marks/by-batch?region=${encodeURIComponent(region)}&batchNumber=${encodeURIComponent(batch)}&date=${date}`,
                        { headers: { 'Authorization': `Bearer ${token}` } }
                    );
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                marksCurrentStudents = await res.json();

                let attendanceMap = new Map();
                try {
                    const attRes = await fetch(
                        `/api/marks/exam-attendance/by-batch?region=${encodeURIComponent(region)}&batchNumber=${encodeURIComponent(batch)}&date=${date}`,
                        { headers: { 'Authorization': `Bearer ${token}` } }
                    );
                    if (attRes.ok) {
                        const attendanceRows = await attRes.json();
                        attendanceRows.forEach(row => {
                            if (row && row.studentId) {
                                attendanceMap.set(String(row.studentId), row.appeared);
                            }
                        });
                    }
                } catch (attError) {
                    console.warn('Exam attendance lookup failed, continuing without it.', attError);
                }

                if (!marksCurrentStudents || marksCurrentStudents.length === 0) {
                    document.getElementById('marksTable').innerHTML =
                        '<div class="alert alert-warning">No students found in this batch</div>';
                    return;
                }

                marksAttendanceMap = attendanceMap;
                renderMarksTable();
            } catch (error) {
                console.error('? Error loading marks:', error);
                document.getElementById('marksTable').innerHTML =
                    `<div class="alert alert-danger">Error loading marks: ${error.message}</div>`;
            }
        }

        let marksAttendanceMap = new Map();

        function renderMarksTable() {
            const showAbsentOnly = document.getElementById('marksAbsentOnly')?.checked;
            const students = Array.isArray(marksCurrentStudents) ? marksCurrentStudents : [];
            const rows = showAbsentOnly
                ? students.filter(s => marksAttendanceMap.get(String(s._id)) === false)
                : students;

            if (rows.length === 0) {
                document.getElementById('marksTable').innerHTML =
                    '<div class="alert alert-warning">No students match the current filter</div>';
                return;
            }

            let html = `
                <div class="alert alert-info py-2">
                    Tip: Leave a component blank to mark it as missed.
                </div>
                <div class="d-flex align-items-center gap-3 mb-2 flex-wrap">
                    <div class="d-flex align-items-center gap-2">
                        <input class="form-check-input" type="checkbox" id="marksAbsentOnly" onchange="renderMarksTable()">
                        <label class="form-check-label" for="marksAbsentOnly">Show only absent students</label>
                    </div>
                    <button class="btn btn-outline-primary btn-sm" onclick="saveExamAttendance()">Save Exam Attendance</button>
                </div>
                <table class="table table-sm table-striped">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Student Name</th>
                            <th class="text-center">Appeared</th>
                            <th class="text-center">Theory (40)</th>
                            <th class="text-center">Practical (40)</th>
                            <th class="text-center">Presentation (20)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            rows.forEach((student, index) => {
                const m = student.marks || {};
                const presentationValue = m.presentation ?? student.presentationPrefill ?? '';
                const appeared = marksAttendanceMap.get(String(student._id));
                const isAbsent = appeared === false;
                const isUnknown = appeared === null || appeared === undefined;
                const absentAttr = (isAbsent || isUnknown) ? 'data-absent="1" disabled placeholder="ABSENT"' : '';
                const checkboxChecked = appeared === true ? 'checked' : '';
                html += `
                    <tr>
                        <td class="align-middle">${index + 1}</td>
                        <td class="align-middle fw-semibold">${student.name}</td>
                        <td class="align-middle text-center">
                            <input type="checkbox" class="form-check-input"
                                data-exam-attendance="1"
                                data-student-id="${student._id}"
                                ${checkboxChecked}
                                onchange="handleExamAttendanceToggle('${student._id}', this.checked)">
                        </td>
                        <td class="align-middle text-center">
                            <input type="number" class="form-control form-control-sm" min="0" max="40"
                                id="theory_${student._id}" value="${m.theory ?? ''}" ${absentAttr}>
                        </td>
                        <td class="align-middle text-center">
                            <input type="number" class="form-control form-control-sm" min="0" max="40"
                                id="practical_${student._id}" value="${m.practical ?? ''}" ${absentAttr}>
                        </td>
                        <td class="align-middle text-center">
                            <input type="number" class="form-control form-control-sm" min="0" max="20"
                                id="presentation_${student._id}" value="${presentationValue}" ${absentAttr}>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-success btn-lg" onclick="submitMarks()">Submit Exam Marks</button>
                    <button class="btn btn-outline-secondary btn-lg" onclick="enableAbsentMarksInputs()">Enable Absent Entries</button>
                </div>
            `;

            document.getElementById('marksTable').innerHTML = html;
        }

        function enableAbsentMarksInputs() {
            const inputs = document.querySelectorAll('#marksTable input[data-absent="1"]');
            if (!inputs || inputs.length === 0) {
                alert('No absent inputs to enable.');
                return;
            }
            inputs.forEach(input => {
                input.disabled = false;
                input.removeAttribute('placeholder');
            });
        }

        async function handleExamAttendanceToggle(studentId, appeared) {
            marksAttendanceMap.set(String(studentId), appeared);
            renderMarksTable();
        }

        async function saveExamAttendance() {
            const region = document.getElementById('marksRegion').value;
            const batch = document.getElementById('marksBatch').value;
            const date = document.getElementById('marksDate').value;

            if (!region || !batch || !date) {
                alert('Please select region, batch, and date');
                return;
            }

            const records = [];
            marksCurrentStudents.forEach(student => {
                const appeared = marksAttendanceMap.get(String(student._id));
                records.push({ studentId: student._id, appeared: !!appeared });
            });

            if (records.length === 0) {
                alert('No exam attendance changes to save');
                return;
            }

            try {
                const res = await fetch('/api/marks/exam-attendance/mark', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ date, records })
                });
                const data = await res.json();
                if (res.ok) {
                    alert(`Exam attendance saved. Successful: ${data.results?.successful || 0}`);
                } else {
                    alert('Error: ' + (data.message || 'Failed to save exam attendance'));
                }
            } catch (error) {
                console.error('Error saving exam attendance:', error);
                alert('Failed to save exam attendance');
            }
        }

        async function submitMarks() {
            const region = document.getElementById('marksRegion').value;
            const batch = document.getElementById('marksBatch').value;
            const date = document.getElementById('marksDate').value;

            if (!region || !batch || !date) {
                alert('Please select region, batch, and date');
                return;
            }

            const marksRecords = [];
            marksCurrentStudents.forEach(student => {
                const theoryEl = document.getElementById(`theory_${student._id}`);
                const practicalEl = document.getElementById(`practical_${student._id}`);
                const presentationEl = document.getElementById(`presentation_${student._id}`);

                const hasValue = (theoryEl?.value ?? '') !== '' ||
                                 (practicalEl?.value ?? '') !== '' ||
                                 (presentationEl?.value ?? '') !== '';

                if (!hasValue) return;

                const theory = theoryEl.value === '' ? null : Number(theoryEl.value || 0);
                const practical = practicalEl.value === '' ? null : Number(practicalEl.value || 0);
                const presentation = presentationEl.value === '' ? null : Number(presentationEl.value || 0);

                marksRecords.push({
                    studentId: student._id,
                    theory,
                    practical,
                    presentation
                });
            });

            if (marksRecords.length === 0) {
                alert('Please enter marks for at least one student');
                return;
            }

            try {
                const res = await fetch('/api/marks/mark', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ date, marksRecords })
                });
                const data = await res.json();
                if (res.ok) {
                    alert(`Exam marks saved. Successful: ${data.results?.successful || 0}`);
                    loadMarksStudents();
                } else {
                    alert('Error: ' + (data.message || 'Failed to submit marks'));
                }
            } catch (error) {
                console.error('? Error submitting marks:', error);
                alert('Failed to submit marks');
            }
        }

        // RESULT FUNCTIONS
        async function loadResultRegions() {
            try {
                const res = await fetch('/api/students/regions/all', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                const regions = await res.json();
                const select = document.getElementById('resultRegion');
                if (!select) return;
                select.innerHTML = '<option value="">Select Region</option>';
                regions.forEach(region => {
                    select.innerHTML += `<option value="${region}">${region}</option>`;
                });
                document.getElementById('resultBatch').innerHTML = '<option value="">Select Batch</option>';
                document.getElementById('resultResults').innerHTML = '';
            } catch (error) {
                console.error('? Error loading result regions:', error);
            }
        }

        async function loadResultBatches() {
            const region = document.getElementById('resultRegion').value;
            const select = document.getElementById('resultBatch');
            if (!select) return;
            if (!region) {
                select.innerHTML = '<option value="">Select Batch</option>';
                document.getElementById('resultResults').innerHTML = '';
                return;
            }

            try {
                const res = await fetch(`/api/students/batches/${encodeURIComponent(region)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                const batches = await res.json();
                select.innerHTML = '<option value="all">All Batches</option>';
                batches.forEach(batch => {
                    select.innerHTML += `<option value="${batch}">${batch}</option>`;
                });
                select.value = 'all';
            } catch (error) {
                console.error('? Error loading result batches:', error);
            }
        }

        function setExamPlanInputs(plan) {
            const mappings = [
                ['examPlanInaugurationDate', plan?.projectInaugurationDate || ''],
                ['examPlanTheoryDate', plan?.theoryDate || ''],
                ['examPlanPracticalDate', plan?.practicalDate || ''],
                ['examPlanPresentationDate', plan?.presentationDate || ''],
                ['examPlanCertificateDate', plan?.certificateDate || '']
            ];
            mappings.forEach(([id, value]) => {
                const el = document.getElementById(id);
                if (el) el.value = value;
            });

            const metaEl = document.getElementById('examPlanMeta');
            if (metaEl) {
                if (plan?.updatedAt) {
                    metaEl.textContent = `Plan updated by ${plan.updatedByName || 'Unknown'} on ${new Date(plan.updatedAt).toLocaleString()}`;
                } else {
                    metaEl.textContent = 'No saved plan yet for this region and batch.';
                }
            }
        }

        async function loadExamPlan(silent = false) {
            const region = document.getElementById('marksRegion')?.value || '';
            const batch = document.getElementById('marksBatch')?.value || '';
            if (!region || !batch || String(batch).toLowerCase() === 'all') {
                if (!silent) {
                    alert('Please select region and a specific batch to load plan');
                }
                setExamPlanInputs(null);
                return;
            }

            try {
                const res = await fetch(`/api/exam-plan?region=${encodeURIComponent(region)}&batchNumber=${encodeURIComponent(batch)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || `API Error: ${res.status}`);
                setExamPlanInputs(data);
            } catch (error) {
                console.error('Error loading exam plan:', error);
                if (!silent) {
                    alert(`Failed to load exam plan: ${error.message}`);
                }
            }
        }

        async function saveExamPlan() {
            const region = document.getElementById('marksRegion')?.value || '';
            const batch = document.getElementById('marksBatch')?.value || '';
            if (!region || !batch || String(batch).toLowerCase() === 'all') {
                alert('Please select region and a specific batch to save plan');
                return;
            }

            const payload = {
                region,
                batchNumber: batch,
                projectInaugurationDate: document.getElementById('examPlanInaugurationDate')?.value || null,
                theoryDate: document.getElementById('examPlanTheoryDate')?.value || null,
                practicalDate: document.getElementById('examPlanPracticalDate')?.value || null,
                presentationDate: document.getElementById('examPlanPresentationDate')?.value || null,
                certificateDate: document.getElementById('examPlanCertificateDate')?.value || null
            };

            try {
                const res = await fetch('/api/exam-plan', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || `API Error: ${res.status}`);
                setExamPlanInputs(data);
                alert('Exam plan saved successfully.');
            } catch (error) {
                console.error('Error saving exam plan:', error);
                alert(`Failed to save exam plan: ${error.message}`);
            }
        }

        async function viewResultByPlan() {
            const region = document.getElementById('marksRegion')?.value || '';
            const batch = document.getElementById('marksBatch')?.value || '';
            const planResultsEl = document.getElementById('examPlanResults');
            if (!region || !batch || String(batch).toLowerCase() === 'all') {
                alert('Please select region and a specific batch');
                return;
            }

            const params = new URLSearchParams({ region, batchNumber: batch });
            const theoryDate = document.getElementById('examPlanTheoryDate')?.value || '';
            const practicalDate = document.getElementById('examPlanPracticalDate')?.value || '';
            const presentationDate = document.getElementById('examPlanPresentationDate')?.value || '';
            if (theoryDate) params.set('theoryDate', theoryDate);
            if (practicalDate) params.set('practicalDate', practicalDate);
            if (presentationDate) params.set('presentationDate', presentationDate);

            try {
                const res = await fetch(`/api/marks/by-plan?${params.toString()}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || `API Error: ${res.status}`);

                const students = Array.isArray(data.students) ? data.students : [];
                const usedDates = data.usedDates || {};
                if (!students.length) {
                    if (planResultsEl) planResultsEl.innerHTML =
                        '<div class="alert alert-warning">No students found for selected filters</div>';
                    return;
                }

                let html = `
                    <div class="alert alert-info">
                        <strong>Region:</strong> ${escapeHtml(region)} &nbsp; | &nbsp;
                        <strong>Batch:</strong> ${escapeHtml(batch)}<br>
                        <strong>Plan Dates:</strong>
                        Theory: ${escapeHtml(usedDates.theoryDate || '-')},
                        Practical: ${escapeHtml(usedDates.practicalDate || '-')},
                        Presentation: ${escapeHtml(usedDates.presentationDate || '-')}
                    </div>
                    <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Student Name</th>
                                <th class="text-center">Theory</th>
                                <th class="text-center">Practical</th>
                                <th class="text-center">Presentation</th>
                                <th class="text-center">Total Obtained</th>
                                <th class="text-center">Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                students.forEach((student, index) => {
                    const m = student.marks || {};
                    const theory = (m.theory === null || m.theory === undefined) ? '<span class="badge bg-secondary">MISSED</span>' : m.theory;
                    const practical = (m.practical === null || m.practical === undefined) ? '<span class="badge bg-secondary">MISSED</span>' : m.practical;
                    const presentation = (m.presentation === null || m.presentation === undefined) ? '<span class="badge bg-secondary">MISSED</span>' : m.presentation;
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${escapeHtml(student.name || '-')}</td>
                            <td class="text-center">${theory}</td>
                            <td class="text-center">${practical}</td>
                            <td class="text-center">${presentation}</td>
                            <td class="text-center">${Number(m.totalObtained || 0)}</td>
                            <td class="text-center"><span class="badge bg-primary">${Number(m.percentage || 0).toFixed(2)}%</span></td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                    </div>
                `;

                if (planResultsEl) planResultsEl.innerHTML = html;
            } catch (error) {
                console.error('Error loading plan-based result:', error);
                if (planResultsEl) planResultsEl.innerHTML =
                    `<div class="alert alert-danger">Error loading plan-based result: ${error.message}</div>`;
            }
        }

        async function viewResult() {
            const region = document.getElementById('resultRegion').value;
            const batch = document.getElementById('resultBatch').value;
            const date = document.getElementById('resultDate').value;

            if (!region || !date || !batch) {
                alert('Please select region, batch, and date');
                return;
            }

            try {
                const res = await fetch(
                    `/api/marks/by-batch?region=${encodeURIComponent(region)}&batchNumber=${encodeURIComponent(batch)}&date=${date}`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                const students = await res.json();

                if (!students || students.length === 0) {
                    document.getElementById('resultResults').innerHTML =
                        '<div class="alert alert-warning">No students found for selected filters</div>';
                    return;
                }

                // If no marks/presentation exist for any student, exam was not taken/scheduled for this date.
                const hasAnyExamData = students.some(student =>
                    !!student.marks || Number.isFinite(student.presentationPrefill)
                );
                if (!hasAnyExamData) {
                    document.getElementById('resultResults').innerHTML =
                        '<div class="alert alert-warning">No data found. Exam is not taken or not scheduled for the selected date.</div>';
                    return;
                }

                const batchLabel = (batch === 'all') ? 'All Batches' : batch;
                const studentsSorted = [...students].sort((a, b) => {
                    if (batch === 'all') {
                        const batchCmp = String(a.batchNumber || '').localeCompare(String(b.batchNumber || ''));
                        if (batchCmp !== 0) return batchCmp;
                    }
                    return String(a.name || '').localeCompare(String(b.name || ''));
                });

                let html = `
                    <div class="alert alert-info">
                        <strong>Region:</strong> ${region} &nbsp; | &nbsp;
                        <strong>Batch:</strong> ${batchLabel} &nbsp; | &nbsp;
                        <strong>Date:</strong> ${date}
                    </div>
                    <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Student Name</th>
                                <th class="text-center">Total Marks</th>
                                <th class="text-center">Total Obtained</th>
                                <th class="text-center">Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                studentsSorted.forEach((student, index) => {
                    const m = student.marks;
                    const presentationPrefill = Number.isFinite(student.presentationPrefill)
                        ? Number(student.presentationPrefill)
                        : null;
                    if (!m && presentationPrefill === null) {
                        html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${student.name}</td>
                                <td class="text-center">-</td>
                                <td class="text-center">-</td>
                                <td class="text-center"><span class="badge bg-secondary">NOT MARKED</span></td>
                            </tr>
                        `;
                        return;
                    }
                    if (!m && presentationPrefill !== null) {
                        const totalMarks = 20;
                        const totalObtained = presentationPrefill;
                        const percentage = totalObtained > 0 ? ((totalObtained / totalMarks) * 100).toFixed(2) : '0.00';
                        html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${student.name}</td>
                                <td class="text-center">${totalMarks}</td>
                                <td class="text-center">${totalObtained}</td>
                                <td class="text-center"><span class="badge bg-info">PRESENTATION ${percentage}%</span></td>
                            </tr>
                        `;
                        return;
                    }
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${student.name}</td>
                            <td class="text-center">${m.totalMarks}</td>
                            <td class="text-center">${m.totalObtained}</td>
                            <td class="text-center"><span class="badge bg-primary">${m.percentage}%</span></td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                    </div>
                `;

                document.getElementById('resultResults').innerHTML = html;
            } catch (error) {
                console.error('? Error loading results:', error);
                document.getElementById('resultResults').innerHTML =
                    `<div class="alert alert-danger">Error loading results: ${error.message}</div>`;
            }
        }

        async function viewTop3() {
            const region = document.getElementById('resultRegion').value;
            const batch = document.getElementById('resultBatch').value;
            const date = document.getElementById('resultDate').value;

            if (!date) {
                alert('Please select date');
                return;
            }

            const params = new URLSearchParams();
            params.append('date', date);
            if (region) params.append('region', region);
            if (batch) params.append('batchNumber', batch);

            try {
                const res = await fetch(`/api/marks/top?${params.toString()}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                const rows = await res.json();

                if (!rows || rows.length === 0) {
                    document.getElementById('resultResults').innerHTML =
                        '<div class="alert alert-warning">No marks found for this date</div>';
                    return;
                }

                const batchLabel = !batch || batch === 'all' ? 'All Batches' : batch;

                let html = `
                    <div class="alert alert-info">
                        <strong>Top 3 Students</strong> (Date: ${date})<br>
                        <strong>Batch Filter:</strong> ${batchLabel}
                    </div>
                    <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Student Name</th>
                                <th>Batch</th>
                                <th>Total Marks</th>
                                <th>Total Obtained</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                rows.forEach((r, index) => {
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${r.studentName}</td>
                            <td>${r.batchNumber}</td>
                            <td class="text-center">${r.totalMarks}</td>
                            <td class="text-center">${r.totalObtained}</td>
                            <td class="text-center"><span class="badge bg-primary">${r.percentage}%</span></td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                    </div>
                `;

                document.getElementById('resultResults').innerHTML = html;
            } catch (error) {
                console.error('‚ùå Error loading top 3:', error);
                document.getElementById('resultResults').innerHTML =
                    `<div class="alert alert-danger">Error loading top 3: ${error.message}</div>`;
            }
        }

        async function downloadPassedStudentsCSV() {
            const region = document.getElementById('resultRegion').value;
            const batch = document.getElementById('resultBatch').value;
            const date = document.getElementById('resultDate').value;

            if (!region || !batch || !date) {
                alert('Please select region, batch, and date');
                return;
            }

            try {
                const res = await fetch(
                    `/api/marks/by-batch?region=${encodeURIComponent(region)}&batchNumber=${encodeURIComponent(batch)}&date=${date}`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                const students = await res.json();

                const passed = students
                    .filter(s => s.marks && Number(s.marks.totalObtained || 0) > 40)
                    .map(s => ({
                        name: s.name,
                        className: s.standard || '',
                        schoolName: s.schoolName || '',
                        batchNumber: s.batchNumber || '',
                        totalObtained: s.marks.totalObtained,
                        percentage: s.marks.percentage
                    }));

                if (passed.length === 0) {
                    alert('No passed students found for this date');
                    return;
                }

                const header = ['Student Name', 'School Name', 'Class', 'Region', 'Batch', 'Total Marks', 'Total Obtained', 'Percentage'];
                const lines = [header.join(',')];
                passed.forEach(p => {
                    const row = [
                        `"${String(p.name).replace(/\"/g, '""')}"`,
                        `"${String(p.schoolName).replace(/\"/g, '""')}"`,
                        `"${String(p.className).replace(/\"/g, '""')}"`,
                        `"${String(region).replace(/\"/g, '""')}"`,
                        `"${String(p.batchNumber).replace(/\"/g, '""')}"`,
                        `"${String(100).replace(/\"/g, '""')}"`,
                        `"${String(p.totalObtained).replace(/\"/g, '""')}"`,
                        `"${String(p.percentage).replace(/\"/g, '""')}"`
                    ];
                    lines.push(row.join(','));
                });

                const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `passed_students_${date}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('‚ùå Error downloading passed students:', error);
                alert('Failed to download CSV');
            }
        }
        function toggleExamMissedModeFields() {
            const mode = document.getElementById('examMissedMode')?.value || 'single';
            const planEl = document.getElementById('examMissedPlanFields');
            const rangeEl = document.getElementById('examMissedRangeFields');
            const hintEl = document.getElementById('examMissedModeHint');

            if (planEl) planEl.style.display = mode === 'plan' ? '' : 'none';
            if (rangeEl) rangeEl.style.display = mode === 'range' ? '' : 'none';

            if (hintEl) {
                if (mode === 'single') {
                    hintEl.textContent = 'Single Date: checks theory, practical, and presentation on selected Date.';
                } else if (mode === 'plan') {
                    hintEl.textContent = 'Exam Plan: use separate dates for theory, practical, and presentation.';
                } else if (mode === 'range') {
                    hintEl.textContent = 'Date Range: checks if each student completed each component anytime in the range.';
                } else {
                    hintEl.textContent = 'Latest Per Component: uses latest available date of theory, practical, and presentation.';
                }
            }
        }

        async function viewExamMissed() {
            const region = document.getElementById('resultRegion').value;
            const batch = document.getElementById('resultBatch').value;
            const mode = document.getElementById('examMissedMode')?.value || 'single';
            const date = document.getElementById('resultDate').value;
            const theoryDate = document.getElementById('examMissedTheoryDate')?.value;
            const practicalDate = document.getElementById('examMissedPracticalDate')?.value;
            const presentationDate = document.getElementById('examMissedPresentationDate')?.value;
            const startDate = document.getElementById('examMissedStartDate')?.value;
            const endDate = document.getElementById('examMissedEndDate')?.value;

            if (!region || !batch) {
                alert('Please select region and batch');
                return;
            }

            if (mode === 'single' && !date) {
                alert('Please select Date for Single Date mode');
                return;
            }
            if (mode === 'plan' && (!theoryDate || !practicalDate || !presentationDate)) {
                alert('Please select Theory Date, Practical Date, and Presentation Date');
                return;
            }
            if (mode === 'range' && (!startDate || !endDate)) {
                alert('Please select Start Date and End Date');
                return;
            }
            if (mode === 'range' && startDate > endDate) {
                alert('Start Date cannot be after End Date');
                return;
            }

            try {
                const params = new URLSearchParams({
                    region,
                    batchNumber: batch,
                    mode
                });
                if (mode === 'single') params.set('date', date);
                if (mode === 'plan') {
                    params.set('theoryDate', theoryDate);
                    params.set('practicalDate', practicalDate);
                    params.set('presentationDate', presentationDate);
                }
                if (mode === 'range') {
                    params.set('startDate', startDate);
                    params.set('endDate', endDate);
                }

                const res = await fetch(
                    `/api/marks/missed?${params.toString()}`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                const payload = await res.json();
                const students = Array.isArray(payload) ? payload : (payload.students || []);
                const usedDates = Array.isArray(payload) ? {} : (payload.usedDates || {});

                const basisText = mode === 'single'
                    ? `Date: ${usedDates.singleDate || date}`
                    : mode === 'plan'
                        ? `Theory: ${usedDates.theoryDate || theoryDate} | Practical: ${usedDates.practicalDate || practicalDate} | Presentation: ${usedDates.presentationDate || presentationDate}`
                        : mode === 'range'
                            ? `Range: ${usedDates.startDate || startDate} to ${usedDates.endDate || endDate}`
                            : `Latest dates - Theory: ${usedDates.theoryDate || '-'} | Practical: ${usedDates.practicalDate || '-'} | Presentation: ${usedDates.presentationDate || '-'}`;

                if (!students || students.length === 0) {
                    document.getElementById('resultResults').innerHTML =
                        `<div class="alert alert-success">No missed exams found. (${basisText})</div>`;
                    return;
                }

                const missedCount = {
                    theory: students.filter(s => s.missed?.theory).length,
                    practical: students.filter(s => s.missed?.practical).length,
                    presentation: students.filter(s => s.missed?.presentation).length
                };

                const renderMissedTable = (filterType = 'all') => {
                    const rows = students.filter(s => {
                        if (filterType === 'all') return true;
                        if (filterType === 'theory') return !!s.missed?.theory;
                        if (filterType === 'practical') return !!s.missed?.practical;
                        if (filterType === 'presentation') return !!s.missed?.presentation;
                        return true;
                    });

                    let html = `
                        <div class="alert alert-warning">
                            <strong>Exam Missed Report</strong><br>
                            <span class="small">${basisText}</span><br>
                            Theory Missed: <strong>${missedCount.theory}</strong> |
                            Practical Missed: <strong>${missedCount.practical}</strong> |
                            Presentation Missed: <strong>${missedCount.presentation}</strong>
                        </div>
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <label class="form-label mb-0" for="examMissedFilter">Filter:</label>
                            <select class="form-select form-select-sm w-auto" id="examMissedFilter">
                                <option value="all">All Missed Students</option>
                                <option value="theory">Theory Missed</option>
                                <option value="practical">Practical Missed</option>
                                <option value="presentation">Presentation Missed</option>
                            </select>
                        </div>
                    `;

                    if (!rows.length) {
                        html += '<div class="alert alert-info">No students match the selected filter.</div>';
                        document.getElementById('resultResults').innerHTML = html;
                        const filterEl = document.getElementById('examMissedFilter');
                        if (filterEl) {
                            filterEl.value = filterType;
                            filterEl.onchange = () => renderMissedTable(filterEl.value);
                        }
                        return;
                    }

                    html += `
                        <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Student Name</th>
                                    <th>Batch</th>
                                    <th class="text-center">Theory</th>
                                    <th class="text-center">Practical</th>
                                    <th class="text-center">Presentation</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    rows.forEach((s, index) => {
                        const theoryBadge = s.missed?.theory
                            ? '<span class="badge bg-danger">MISSED</span>'
                            : '<span class="badge bg-success">DONE</span>';
                        const practicalBadge = s.missed?.practical
                            ? '<span class="badge bg-danger">MISSED</span>'
                            : '<span class="badge bg-success">DONE</span>';
                        const presentationBadge = s.missed?.presentation
                            ? '<span class="badge bg-danger">MISSED</span>'
                            : '<span class="badge bg-success">DONE</span>';

                        html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${s.name}</td>
                                <td>${s.batchNumber || '-'}</td>
                                <td class="text-center">${theoryBadge}</td>
                                <td class="text-center">${practicalBadge}</td>
                                <td class="text-center">${presentationBadge}</td>
                            </tr>
                        `;
                    });

                    html += `
                            </tbody>
                        </table>
                        </div>
                    `;

                    document.getElementById('resultResults').innerHTML = html;
                    const filterEl = document.getElementById('examMissedFilter');
                    if (filterEl) {
                        filterEl.value = filterType;
                        filterEl.onchange = () => renderMissedTable(filterEl.value);
                    }
                };

                renderMissedTable('all');
            } catch (error) {
                console.error('Error loading exam missed:', error);
                document.getElementById('resultResults').innerHTML =
                    `<div class="alert alert-danger">Error loading exam missed: ${error.message}</div>`;
            }
        }
// LOW ATTENDANCE FUNCTIONS
        async function loadLowRegions() {
            try {
                const res = await fetch('/api/students/regions/all', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }
                const regions = await res.json();
                const select = document.getElementById('lowRegion');
                if (!select) return;
                select.innerHTML = '<option value="">Select Region</option>';
                regions.forEach(region => {
                    select.innerHTML += `<option value="${region}">${region}</option>`;
                });
                document.getElementById('lowBatch').innerHTML = '<option value="">Select Batch</option>';
            } catch (error) {
                console.error('‚ùå Error loading low attendance regions:', error);
            }
        }

        async function loadLowBatches() {
            const region = document.getElementById('lowRegion').value;
            const select = document.getElementById('lowBatch');
            if (!select) return;
            if (!region) {
                select.innerHTML = '<option value="">Select Batch</option>';
                return;
            }

            try {
                const res = await fetch(`/api/students/batches/${encodeURIComponent(region)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }
                const batches = await res.json();
                select.innerHTML = '<option value="all">All Batches</option>';
                batches.forEach(batch => {
                    select.innerHTML += `<option value="${batch}">${batch}</option>`;
                });
                select.value = 'all';
            } catch (error) {
                console.error('‚ùå Error loading low attendance batches:', error);
            }
        }

        async function loadLowAttendance() {
            const region = document.getElementById('lowRegion').value;
            const batch = document.getElementById('lowBatch').value;
            const days = document.getElementById('lowDays')?.value;
            const inquiredEl = document.getElementById('lowInquiredResults');

            if (inquiredEl) {
                inquiredEl.innerHTML = '';
            }
            if (!region) {
                alert('Please select region');
                return;
            }

            const params = new URLSearchParams();
            params.append('region', region);
            if (batch) {
                params.append('batchNumber', batch);
            }
            if (days) {
                params.append('days', days);
            }

            try {
                const res = await fetch(`/api/attendance/low-attendance?${params.toString()}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }

                const data = await res.json();
                const results = data.results || [];
                const threshold = data.threshold || 3;
                const days = data.days || 30;
                const dateRange = data.dateRange || {};

                if (results.length === 0) {
                    document.getElementById('lowResults').innerHTML =
                        `<div class="alert alert-warning">No students found absent for ${threshold}+ classes in the last ${days} days</div>`;
                    return;
                }

                let html = `
                    <div class="alert alert-info">
                        Showing students absent for <strong>${threshold}+ classes</strong> in the last <strong>${days} days</strong>
                        ${dateRange.start && dateRange.end ? ` (from ${dateRange.start} to ${dateRange.end})` : ''}
                    </div>
                    <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                            <th>Batch</th>
                            <th>Mobile</th>
                            <th class="text-center">Call</th>
                            <th>Standard</th>
                            <th>Absent Dates</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            results.forEach((student, index) => {
                const absentDates = (student.absentDates || []).sort().join(', ');
                const callButton = buildCallButtonHtml(student.studentId, student.mobile, 'low-attendance');
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${student.name}</td>
                        <td>${student.batchNumber || '-'}</td>
                        <td>${student.mobile || '-'}</td>
                        <td class="text-center">${callButton}</td>
                        <td>${student.standard || '-'}</td>
                        <td>${absentDates || '-'}</td>
                    </tr>
                `;
            });

                html += `
                        </tbody>
                    </table>
                    </div>
                `;

                document.getElementById('lowResults').innerHTML = html;
            } catch (error) {
                console.error('‚ùå Error loading low attendance:', error);
                document.getElementById('lowResults').innerHTML =
                    `<div class="alert alert-danger">Error loading results: ${error.message}</div>`;
            }
        }

        async function loadInquiredStudents() {
            const region = document.getElementById('lowRegion').value;
            const batch = document.getElementById('lowBatch').value;
            const days = document.getElementById('lowDays')?.value;
            const target = document.getElementById('lowInquiredResults');

            if (!target) return;
            if (!region) {
                alert('Please select region');
                return;
            }

            const params = new URLSearchParams();
            params.append('region', region);
            if (batch) {
                params.append('batchNumber', batch);
            }
            if (days) {
                params.append('days', days);
            }

            try {
                target.innerHTML = '<div class="text-muted">Loading inquired students...</div>';
                const res = await fetch(`/api/attendance/contact-log?${params.toString()}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }

                const data = await res.json();
                const results = data.results || [];
                const dateRange = data.dateRange || {};

                if (results.length === 0) {
                    target.innerHTML = '<div class="alert alert-info">No contacted students found for this period.</div>';
                    return;
                }

                let html = `
                    <div class="alert alert-info">
                        Students contacted in the last ${data.days || 30} days
                        ${dateRange.start && dateRange.end ? ` (from ${dateRange.start} to ${dateRange.end})` : ''}
                    </div>
                    <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Date/Time</th>
                                <th>Student</th>
                                <th>Batch</th>
                                <th>Region</th>
                                <th>Teacher</th>
                                <th>Phone</th>
                                <th>Source</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                results.forEach((row, index) => {
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${row.createdAt ? formatDateTime(row.createdAt) : '-'}</td>
                            <td>${escapeHtml(row.studentName)}</td>
                            <td>${escapeHtml(row.batchNumber || '-')}</td>
                            <td>${escapeHtml(row.region || '-')}</td>
                            <td>${escapeHtml(row.teacherName)}</td>
                            <td>${escapeHtml(row.phoneDialed || row.studentMobile || '-')}</td>
                            <td>${escapeHtml(row.source || '-')}</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                    </div>
                `;

                target.innerHTML = html;
            } catch (error) {
                console.error('‚ùå Error loading contact log:', error);
                target.innerHTML = `<div class="alert alert-danger">Error loading contact log: ${error.message}</div>`;
            }
        }

        // DATA ANALYSIS FUNCTIONS
        async function loadAnalysisRegions() {
            try {
                const res = await fetch('/api/students/regions/all', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }
                const regions = await res.json();
                const select = document.getElementById('analysisRegion');
                if (!select) return;
                select.innerHTML = '<option value="">Select Region</option>';
                regions.forEach(region => {
                    select.innerHTML += `<option value="${region}">${region}</option>`;
                });
                const batchSelect = document.getElementById('analysisBatch');
                if (batchSelect) {
                    batchSelect.innerHTML = '<option value="">Select Batch</option>';
                }
            } catch (error) {
                console.error('‚ùå Error loading analysis regions:', error);
            }
        }

        async function loadAnalysisBatches() {
            const region = document.getElementById('analysisRegion').value;
            const select = document.getElementById('analysisBatch');
            if (!select) return;
            if (!region) {
                select.innerHTML = '<option value="">Select Batch</option>';
                return;
            }

            try {
                const res = await fetch(`/api/students/batches/${encodeURIComponent(region)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }
                const batches = await res.json();
                select.innerHTML = '<option value="all">All Batches</option>';
                batches.forEach(batch => {
                    select.innerHTML += `<option value="${batch}">${batch}</option>`;
                });
                select.value = 'all';
            } catch (error) {
                console.error('‚ùå Error loading analysis batches:', error);
            }
        }

        async function runDataAnalysis() {
            const region = document.getElementById('analysisRegion').value;
            const batch = document.getElementById('analysisBatch').value;
            const startDate = document.getElementById('analysisStartDate').value;
            const endDate = document.getElementById('analysisEndDate').value;

            if (!region || !batch || !startDate || !endDate) {
                alert('Please select region, batch, and date range');
                return;
            }

            if (startDate > endDate) {
                alert('Start date must be before end date');
                return;
            }

            try {
                let batches = [];
                if (batch === 'all') {
                    const res = await fetch(`/api/students/batches/${encodeURIComponent(region)}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!res.ok) {
                        throw new Error(`API Error: ${res.status}`);
                    }
                    batches = await res.json();
                } else {
                    batches = [batch];
                }

                if (!batches || batches.length === 0) {
                    alert('No batches found for this region');
                    return;
                }

                const batchResults = [];
                const allAttended = [];

                for (const b of batches) {
                    const res = await fetch(
                        `/api/attendance/summary?region=${encodeURIComponent(region)}&batchNumber=${encodeURIComponent(b)}&startDate=${startDate}&endDate=${endDate}&filterType=date-range`,
                        { headers: { 'Authorization': `Bearer ${token}` } }
                    );
                    if (!res.ok) {
                        throw new Error(`API Error: ${res.status}`);
                    }
                    const data = await res.json();
                    const summary = data.summary || [];
                    const stats = data.stats || {};
                    const totalClasses = stats.totalClasses || 0;
                    const present = stats.totalPresent || 0;
                    const absent = stats.totalAbsent || 0;
                    const rate = (present + absent) > 0 ? ((present / (present + absent)) * 100) : 0;

                    batchResults.push({
                        batch: b,
                        present,
                        absent,
                        totalClasses,
                        rate: Number(rate.toFixed(2))
                    });

                    if (totalClasses > 0) {
                        summary
                            .filter(s => s.present === totalClasses)
                            .forEach(s => {
                                allAttended.push({
                                    batch: b,
                                    name: s.name,
                                    totalClasses
                                });
                            });
                    }
                }

                if (batchResults.length === 0) {
                    document.getElementById('analysisSummary').innerHTML =
                        '<div class="alert alert-warning">No attendance data found for this range</div>';
                    document.getElementById('analysisStudents').innerHTML = '';
                    if (analysisChart) {
                        analysisChart.destroy();
                        analysisChart = null;
                    }
                    return;
                }

                const maxBatch = batchResults.reduce((a, b) => (b.rate > a.rate ? b : a), batchResults[0]);
                const minBatch = batchResults.reduce((a, b) => (b.rate < a.rate ? b : a), batchResults[0]);

                document.getElementById('analysisSummary').innerHTML = `
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="alert alert-success mb-0">
                                <strong>Top Attendance:</strong> Batch ${maxBatch.batch}<br>
                                Rate: ${maxBatch.rate}% | Present: ${maxBatch.present} | Absent: ${maxBatch.absent}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-warning mb-0">
                                <strong>Lowest Attendance:</strong> Batch ${minBatch.batch}<br>
                                Rate: ${minBatch.rate}% | Present: ${minBatch.present} | Absent: ${minBatch.absent}
                            </div>
                        </div>
                    </div>
                `;

                const labels = batchResults.map(b => `Batch ${b.batch}`);
                const values = batchResults.map(b => b.rate);
                const colors = [
                    '#0ea5a4', '#f59e0b', '#ef4444', '#3b82f6', '#22c55e',
                    '#a855f7', '#14b8a6', '#f97316', '#64748b', '#06b6d4'
                ];

                const ctx = document.getElementById('analysisChart').getContext('2d');
                if (analysisChart) analysisChart.destroy();
                analysisChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels,
                        datasets: [{
                            data: values,
                            backgroundColor: labels.map((_, i) => colors[i % colors.length])
                        }]
                    },
                    options: {
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `${ctx.label}: ${ctx.formattedValue}%`
                                }
                            }
                        }
                    },
                    plugins: [{
                        id: 'percentageLabels',
                        afterDraw(chart) {
                            const { ctx } = chart;
                            const meta = chart.getDatasetMeta(0);
                            const data = chart.data.datasets[0].data || [];
                            ctx.save();
                            ctx.font = '600 12px Arial';
                            ctx.fillStyle = '#0f172a';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            meta.data.forEach((arc, index) => {
                                const value = Number(data[index] || 0);
                                if (value < 5) return;
                                const pos = arc.tooltipPosition();
                                ctx.fillText(`${value}%`, pos.x, pos.y);
                            });
                            ctx.restore();
                        }
                    }]
                });

                window.analysisAllAttended = allAttended;

                // Student details are intentionally not shown in the UI.
            } catch (error) {
                console.error('‚ùå Error running data analysis:', error);
                document.getElementById('analysisSummary').innerHTML =
                    `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        function downloadAnalysisCSV() {
            const rows = window.analysisAllAttended || [];
            if (!rows || rows.length === 0) {
                alert('No students to download.');
                return;
            }

            const header = ['Batch', 'Student Name', 'Total Classes'];
            const lines = [header.join(',')];
            rows.forEach(r => {
                const line = [
                    `"${String(r.batch).replace(/\"/g, '""')}"`,
                    `"${String(r.name).replace(/\"/g, '""')}"`,
                    `"${String(r.totalClasses).replace(/\"/g, '""')}"`
                ];
                lines.push(line.join(','));
            });

            const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_all_classes_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // DAILY WORK REPORT FUNCTIONS
        async function submitWorkReport() {
            const date = document.getElementById('workDate').value;
            const topicsCovered = document.getElementById('workTopics').value.trim();

            if (!date || !topicsCovered) {
                alert('Please select date and enter topics.');
                return;
            }

            try {
                const res = await fetch('/api/workReport', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        date,
                        topicsCovered,
                        subject: 'Daily Work'
                    })
                });

                const data = await res.json();
                if (res.ok) {
                    alert(data.message || 'Report submitted successfully');
                    document.getElementById('workTopics').value = '';
                    loadWorkReports();
                } else {
                    alert('Error: ' + (data.error || data.message || 'Failed to submit report'));
                }
            } catch (error) {
                console.error('‚ùå Error submitting work report:', error);
                alert('Failed to submit report');
            }
        }

        async function loadWorkReports() {
            const filterType = document.getElementById('workViewFilterType').value;
            const dateInput = document.getElementById('workViewDate').value;
            const teacherId = document.getElementById('workViewTeacher').value;

            if (!dateInput) {
                alert('Please select date/month');
                return;
            }

            const params = new URLSearchParams();
            if (teacherId) {
                params.append('teacherId', teacherId);
            }
            if (filterType === 'month') {
                const [year, month] = dateInput.split('-');
                const startDate = `${year}-${month}-01`;
                const lastDay = new Date(year, month, 0).getDate();
                const endDate = `${year}-${month}-${lastDay}`;
                params.append('startDate', startDate);
                params.append('endDate', endDate);
            } else {
                params.append('date', dateInput);
            }

            try {
                const res = await fetch(`/api/workReport?${params.toString()}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }

                const reports = await res.json();
                if (!reports || reports.length === 0) {
                    document.getElementById('workResults').innerHTML =
                        '<div class="alert alert-warning">No reports found for the selected filters</div>';
                    return;
                }

                let html = `
                    <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Date</th>
                                <th>Teacher</th>
                                <th>Topics Taught</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                reports.forEach((report, index) => {
                    const reportDate = new Date(report.date).toISOString().split('T')[0];
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${reportDate}</td>
                            <td>${report.teacherName || '-'}</td>
                            <td>${report.topicsCovered}</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                    </div>
                `;

                document.getElementById('workResults').innerHTML = html;
            } catch (error) {
                console.error('‚ùå Error loading work reports:', error);
                document.getElementById('workResults').innerHTML =
                    `<div class="alert alert-danger">Error loading reports: ${error.message}</div>`;
            }
        }

        // LOAD MARK BATCHES
        async function loadMarkBatches() {
            const region = document.getElementById('markRegion').value;
            if (!region) {
                console.warn('‚ö†Ô∏è No region selected');
                document.getElementById('studentsTable').innerHTML = '';
                return;
            }

            try {
                console.log('üìö Loading batches for region:', region);
                const res = await fetch(`/api/students/batches/${encodeURIComponent(region)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }
                
                const batches = await res.json();
                console.log('‚úÖ Batches loaded:', batches);
                
                const select = document.getElementById('markBatch');
                select.innerHTML = '<option value="">Select Batch</option>';
                
                if (!batches || batches.length === 0) {
                    console.warn('‚ö†Ô∏è No batches found for region:', region);
                    select.innerHTML += '<option disabled>No batches available</option>';
                    return;
                }
                
                batches.forEach(batch => {
                    select.innerHTML += `<option value="${batch}">${batch}</option>`;
                });
            } catch (error) {
                console.error('‚ùå Error loading batches:', error);
                alert('Error loading batches: ' + error.message);
            }
        }

        // LOAD VIEW BATCHES
        async function loadViewBatches() {
            const region = document.getElementById('viewRegion').value;
            if (!region) {
                console.warn('‚ö†Ô∏è No region selected');
                return;
            }

            try {
                console.log('üìö Loading view batches for region:', region);
                const res = await fetch(`/api/students/batches/${encodeURIComponent(region)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }
                
                const batches = await res.json();
                console.log('‚úÖ View batches loaded:', batches);
                
                const select = document.getElementById('viewBatch');
                select.innerHTML = '<option value="">Select Batch</option>';
                select.innerHTML += '<option value="all">All Batches</option>';
                
                if (!batches || batches.length === 0) {
                    console.warn('‚ö†Ô∏è No batches found for region:', region);
                    select.innerHTML += '<option disabled>No batches available</option>';
                    return;
                }
                
                batches.forEach(batch => {
                    select.innerHTML += `<option value="${batch}">${batch}</option>`;
                });
                select.value = 'all';
            } catch (error) {
                console.error('‚ùå Error loading view batches:', error);
                alert('Error loading batches: ' + error.message);
            }
        }

        // LOAD STUDENTS FOR MARKING
        async function loadMarkStudents() {
            const region = document.getElementById('markRegion').value;
            const batch = document.getElementById('markBatch').value;
            const date = document.getElementById('markDate').value;
            
            if (!region || !batch) {
                console.warn('‚ö†Ô∏è Region or batch not selected');
                return;
            }
            if (!date) {
                console.warn('‚ö†Ô∏è Date not selected');
                return;
            }
            if (isFutureDate(date)) {
                alert('Please select a valid date (not in the future).');
                return;
            }

            try {
                console.log('üë• Loading students for marking:', region, batch, date);
                const res = await fetch(`/api/attendance/by-batch?region=${encodeURIComponent(region)}&batchNumber=${encodeURIComponent(batch)}&date=${date}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }
                
                currentStudents = await res.json();
                console.log('‚úÖ Students loaded:', currentStudents.length);
                
                if (!currentStudents || currentStudents.length === 0) {
                    document.getElementById('studentsTable').innerHTML = 
                        '<div class="alert alert-warning">No students found in this batch</div>';
                    return;
                }

                const markSearch = document.getElementById('markSearch');
                const markStatusFilter = document.getElementById('markStatusFilter');
                if (markSearch) markSearch.value = '';
                if (markStatusFilter) markStatusFilter.value = 'all';

                markSelections = new Map();
                currentStudents.forEach(student => {
                    if (!student.attendance && student.plannedAbsence && student.plannedAbsence.reason) {
                        markSelections.set(String(student._id), {
                            status: 'absent',
                            note: student.plannedAbsence.reason,
                            isPlannedDefault: true
                        });
                    }
                });
                markFiltered = currentStudents.slice();
                markPage = 1;
                renderMarkTable();
                await loadPlannedAbsenceList();
                await loadPlannedAbsenceStudentOptions();
                console.log('‚úÖ Students table rendered');
            } catch (error) {
                console.error('‚ùå Error loading students:', error);
                alert('Error loading students: ' + error.message);
            }
        }

        function renderBusInventoryTable() {
            const tableBody = document.getElementById('busInventoryTableBody');
            if (!tableBody) return;
            tableBody.innerHTML = busInventoryData.map((item, index) => `
                <tr>
                    <td>${escapeHtml(item.name)}</td>
                    <td>
                        <input
                            type="text"
                            class="form-control"
                            maxlength="120"
                            placeholder="Enter category"
                            value="${escapeHtml(item.category || '')}"
                            onchange="updateBusInventoryCategory(${index}, this.value)"
                        >
                    </td>
                    <td>
                        <input
                            type="number"
                            class="form-control"
                            min="0"
                            step="1"
                            value="${Number(item.quantity) || 0}"
                            onchange="updateBusInventoryQuantity(${index}, this.value)"
                        >
                    </td>
                    <td>
                        <input
                            type="text"
                            class="form-control"
                            value="${escapeHtml(item.location || 'Bus')}"
                            readonly
                        >
                    </td>
                    <td>
                        <input
                            type="text"
                            class="form-control"
                            maxlength="300"
                            placeholder="Enter remarks (e.g. malfunction, replacement needed)"
                            value="${escapeHtml(item.remarks || '')}"
                            onchange="updateBusInventoryRemarks(${index}, this.value)"
                        >
                    </td>
                </tr>
            `).join('');
        }

        function updateBusInventoryCategory(index, value) {
            if (!busInventoryData[index]) return;
            busInventoryData[index].category = String(value || '').trim();
        }

        function updateBusInventoryQuantity(index, value) {
            if (!busInventoryData[index]) return;
            busInventoryData[index].quantity = Math.max(0, Number(value) || 0);
            busInventoryData[index].location = 'Bus';
        }

        function updateBusInventoryRemarks(index, value) {
            if (!busInventoryData[index]) return;
            busInventoryData[index].remarks = String(value || '').trim();
            busInventoryData[index].location = 'Bus';
        }

        function setBusInventoryView(mode) {
            const editorEl = document.getElementById('busInventoryEditor');
            const actionsEl = document.getElementById('busInventoryActions');
            const detailsEl = document.getElementById('busInventoryDetails');
            if (mode === 'details') {
                if (editorEl) editorEl.style.display = 'none';
                if (actionsEl) actionsEl.style.display = 'none';
                if (detailsEl) detailsEl.style.display = 'block';
                return;
            }
            if (editorEl) editorEl.style.display = 'block';
            if (actionsEl) actionsEl.style.display = 'flex';
            if (detailsEl) {
                detailsEl.style.display = 'block';
                detailsEl.innerHTML = '';
            }
        }

        function backToBusInventoryEditor() {
            setBusInventoryView('edit');
        }

        async function loadBusInventory() {
            const tableBody = document.getElementById('busInventoryTableBody');
            const metaEl = document.getElementById('busInventoryMeta');
            setBusInventoryView('edit');
            if (tableBody) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>';
            }
            try {
                const res = await fetch('/api/bus-inventory', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                const data = await res.json();
                busInventoryData = Array.isArray(data.items) ? data.items : [];
                busInventoryData = busInventoryData.map((item) => ({
                    ...item,
                    category: String(item.category || ''),
                    location: 'Bus'
                }));
                renderBusInventoryTable();
                if (metaEl) {
                    const updatedText = data.updatedAt
                        ? `Last saved by ${data.updatedByName || 'Unknown'} on ${new Date(data.updatedAt).toLocaleString()}`
                        : 'Editable quantity table for equipment tracking.';
                    metaEl.textContent = updatedText;
                }
            } catch (error) {
                console.error('Error loading bus inventory:', error);
                if (tableBody) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Failed to load inventory: ${escapeHtml(error.message)}</td></tr>`;
                }
            }
        }

        async function saveBusInventory() {
            try {
                const res = await fetch('/api/bus-inventory', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ items: busInventoryData })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || `API Error: ${res.status}`);
                busInventoryData = Array.isArray(data.items) ? data.items : busInventoryData;
                busInventoryData = busInventoryData.map((item) => ({
                    ...item,
                    category: String(item.category || ''),
                    location: 'Bus'
                }));
                renderBusInventoryTable();
                const metaEl = document.getElementById('busInventoryMeta');
                if (metaEl && data.updatedAt) {
                    metaEl.textContent = `Last saved by ${data.updatedByName || 'Unknown'} on ${new Date(data.updatedAt).toLocaleString()}`;
                }
                alert('Bus inventory saved successfully.');
            } catch (error) {
                console.error('Error saving bus inventory:', error);
                alert(`Failed to save inventory: ${error.message}`);
            }
        }

        async function viewBusInventoryDetails() {
            const detailsEl = document.getElementById('busInventoryDetails');
            if (!detailsEl) return;
            setBusInventoryView('details');
            detailsEl.innerHTML = '<div class="text-muted">Loading inventory details...</div>';

            try {
                const res = await fetch('/api/bus-inventory/details', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || `API Error: ${res.status}`);

                const history = Array.isArray(data.history) ? data.history : [];
                const currentItems = Array.isArray(data.current?.items) ? data.current.items : [];
                const currentRows = currentItems.map((item, idx) => `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${escapeHtml(item.name)}</td>
                        <td>${escapeHtml(item.category || '-')}</td>
                        <td>${Number(item.quantity) || 0}</td>
                        <td>${escapeHtml(item.location || 'Bus')}</td>
                        <td>${escapeHtml(item.remarks || '-')}</td>
                    </tr>
                `).join('');
                const historyDetailCards = history.map((entry, idx) => {
                    const entryItems = Array.isArray(entry.items) ? entry.items : [];
                    const entryRows = entryItems.map((item, itemIdx) => `
                        <tr>
                            <td>${itemIdx + 1}</td>
                            <td>${escapeHtml(item.name || '-')}</td>
                            <td>${escapeHtml(item.category || '-')}</td>
                            <td>${Number(item.quantity) || 0}</td>
                            <td>${escapeHtml(item.location || 'Bus')}</td>
                            <td>${escapeHtml(item.remarks || '-')}</td>
                        </tr>
                    `).join('');

                    return `
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <div><strong>Snapshot ${idx + 1}</strong></div>
                                <div class="small text-muted">
                                    Saved by ${escapeHtml(entry.updatedByName || 'Unknown')} on
                                    ${entry.updatedAt ? new Date(entry.updatedAt).toLocaleString() : '-'}
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>#</th>
                                                <th>Item Name</th>
                                                <th>Category</th>
                                                <th>Quantity</th>
                                                <th>Location</th>
                                                <th>Remarks</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${entryRows || '<tr><td colspan="6" class="text-center text-muted">No items found.</td></tr>'}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                detailsEl.innerHTML = `
                    <div class="card border-0 bg-light">
                        <div class="card-body">
                            <button class="btn btn-sm btn-outline-secondary mb-3" onclick="backToBusInventoryEditor()">Back To Inventory Input</button>
                            <h6 class="mb-2">Inventory Details</h6>
                            <div class="small text-muted mb-3">
                                Current: ${escapeHtml(data.current?.updatedByName || 'Unknown')} | 
                                ${data.current?.updatedAt ? new Date(data.current.updatedAt).toLocaleString() : 'Not saved yet'}
                            </div>
                            <div class="table-responsive mb-3">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>#</th>
                                            <th>Item Name</th>
                                            <th>Category</th>
                                            <th>Quantity</th>
                                            <th>Location</th>
                                            <th>Remarks</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${currentRows || '<tr><td colspan="6" class="text-center text-muted">No current items found.</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                            <h6 class="mt-2">Previous Snapshots</h6>
                            ${historyDetailCards || '<div class="text-muted">No previous details found.</div>'}
                        </div>
                    </div>
                `;
            } catch (error) {
                detailsEl.innerHTML = `<div class="alert alert-danger">Failed to load inventory details: ${escapeHtml(error.message)}</div>`;
            }
        }

        async function shareBusInventoryToWhatsApp() {
            const jsPdfLib = window.jspdf;
            if (!jsPdfLib || !jsPdfLib.jsPDF) {
                alert('PDF library not loaded. Please refresh and try again.');
                return;
            }

            try {
                if (!Array.isArray(busInventoryData) || busInventoryData.length === 0) {
                    await loadBusInventory();
                }

                if (!Array.isArray(busInventoryData) || busInventoryData.length === 0) {
                    alert('No bus inventory found to share.');
                    return;
                }

                const rows = busInventoryData.map((item, idx) => ([
                    String(idx + 1),
                    String(item.name || '-'),
                    String(item.category || '-'),
                    String(Number(item.quantity) || 0),
                    String(item.location || 'Bus'),
                    String(item.remarks || '-')
                ]));

                const metaText = (document.getElementById('busInventoryMeta')?.textContent || '').trim();
                const generatedAt = new Date().toLocaleString();
                const doc = new jsPdfLib.jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

                doc.setFontSize(16);
                doc.text('Bus On Wheels Inventory Report', 40, 44);
                doc.setFontSize(11);
                doc.text(`Generated At: ${generatedAt}`, 40, 68);
                doc.text(`Generated By: ${user.name || 'Class Teacher'}`, 40, 84);
                doc.text(`Location: Bus`, 40, 100);
                if (metaText) {
                    doc.text(metaText, 40, 116);
                }

                doc.autoTable({
                    startY: metaText ? 136 : 120,
                    head: [['S.No', 'Item Name', 'Category', 'Quantity', 'Location', 'Remarks']],
                    body: rows,
                    styles: { fontSize: 10, cellPadding: 6 },
                    headStyles: { fillColor: [14, 165, 164], textColor: [255, 255, 255] },
                    alternateRowStyles: { fillColor: [245, 250, 250] },
                    theme: 'grid'
                });

                const safeDate = new Date().toISOString().slice(0, 10);
                const fileName = `Bus_On_Wheels_Inventory_${safeDate}.pdf`;
                const pdfBlob = doc.output('blob');

                let file = null;
                try {
                    file = new File([pdfBlob], fileName, { type: 'application/pdf' });
                } catch (e) {
                    file = null;
                }

                const shareText = `Bus On Wheels inventory report (${safeDate})`;
                if (file && navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        title: 'Bus On Wheels Inventory',
                        text: shareText,
                        files: [file]
                    });
                } else {
                    doc.save(fileName);
                    const waUrl = `https://wa.me/?text=${encodeURIComponent(shareText + '. PDF downloaded. Please attach and send on WhatsApp.')}`;
                    window.open(waUrl, '_blank');
                }
            } catch (error) {
                console.error('Error sharing bus inventory to WhatsApp:', error);
                alert('Failed to share bus inventory: ' + error.message);
            }
        }

        async function loadPlannedAbsenceStudentOptions() {
            const region = document.getElementById('markRegion').value;
            const batch = document.getElementById('markBatch').value;
            const select = document.getElementById('plannedStudent');
            if (!select) return;

            select.innerHTML = '<option value="">Select Student</option>';
            if (!region || !batch) return;

            try {
                const res = await fetch(`/api/students?region=${encodeURIComponent(region)}&batchNumber=${encodeURIComponent(batch)}&status=active`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }
                const students = await res.json();
                students
                    .sort((a, b) => String(a.name || '').localeCompare(String(b.name || '')))
                    .forEach(student => {
                        select.innerHTML += `<option value="${student._id}">${escapeHtml(student.name)} (${escapeHtml(student.mobile || 'No mobile')})</option>`;
                    });
            } catch (error) {
                console.error('‚ùå Error loading planned absence students:', error);
            }
        }

        async function loadPlannedAbsenceList() {
            const region = document.getElementById('markRegion').value;
            const batch = document.getElementById('markBatch').value;
            const date = document.getElementById('markDate').value;
            const listEl = document.getElementById('plannedAbsenceList');
            if (!listEl) return;

            if (!region || !batch || !date) {
                listEl.innerHTML = '<span class="text-muted small">Select region, batch and date to view planned absences.</span>';
                currentPlannedAbsences = [];
                return;
            }

            try {
                const res = await fetch(`/api/attendance/planned-absences?region=${encodeURIComponent(region)}&batchNumber=${encodeURIComponent(batch)}&date=${encodeURIComponent(date)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }
                currentPlannedAbsences = await res.json();
                if (!currentPlannedAbsences.length) {
                    listEl.innerHTML = '<span class="text-muted small">No planned absences for selected date.</span>';
                    return;
                }
                listEl.innerHTML = `
                    <div class="small fw-semibold mb-2">Planned absences on ${escapeHtml(date)}</div>
                    <div class="d-flex flex-wrap gap-2">
                        ${currentPlannedAbsences.map(item => `
                            <span class="badge bg-primary">
                                ${escapeHtml(item.studentName)}: ${escapeHtml(item.reason)}
                                <button class="btn btn-sm btn-link text-white p-0 ms-2" title="Cancel planned absence" onclick="cancelPlannedAbsence('${item._id}')">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </span>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('‚ùå Error loading planned absences:', error);
                listEl.innerHTML = '<span class="text-danger small">Failed to load planned absences.</span>';
            }
        }

        async function createPlannedAbsence() {
            const studentId = document.getElementById('plannedStudent')?.value;
            const fromDate = document.getElementById('plannedFromDate')?.value;
            const toDate = document.getElementById('plannedToDate')?.value;
            const reason = (document.getElementById('plannedReason')?.value || '').trim();

            if (!studentId || !fromDate || !toDate || !reason) {
                alert('Please select student, date range and reason.');
                return;
            }
            if (fromDate > toDate) {
                alert('From Date cannot be after To Date.');
                return;
            }

            try {
                const res = await fetch('/api/attendance/planned-absences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        studentId,
                        fromDate,
                        toDate,
                        reason
                    })
                });
                const data = await res.json();
                if (!res.ok) {
                    throw new Error(data.message || 'Failed to create planned absence');
                }
                alert('Planned absence saved successfully.');
                document.getElementById('plannedReason').value = '';
                const selectedDate = document.getElementById('markDate')?.value;
                if (selectedDate && selectedDate >= fromDate && selectedDate <= toDate) {
                    await loadMarkStudents();
                } else {
                    await loadPlannedAbsenceList();
                }
            } catch (error) {
                alert('Failed to save planned absence: ' + error.message);
            }
        }

        async function cancelPlannedAbsence(id) {
            const ok = window.confirm('Cancel this planned absence?');
            if (!ok) return;
            try {
                const res = await fetch(`/api/attendance/planned-absences/${id}/cancel`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await res.json();
                if (!res.ok) {
                    throw new Error(data.message || 'Cancel failed');
                }
                await loadPlannedAbsenceList();
                await loadMarkStudents();
            } catch (error) {
                alert('Failed to cancel planned absence: ' + error.message);
            }
        }

        function getEffectiveMarkState(student) {
            const selection = markSelections.get(String(student._id)) || {};
            const hasSelectionStatus = Object.prototype.hasOwnProperty.call(selection, 'status');
            if (hasSelectionStatus) {
                const status = selection.status || '';
                let note = String(selection.note || '').trim();
                if (status === 'absent' && !note && !student.attendance && student.plannedAbsence?.reason) {
                    note = String(student.plannedAbsence.reason || '').trim();
                }
                return { status, note, isPlannedDefault: !!selection.isPlannedDefault };
            }
            if (student.attendance) {
                return {
                    status: student.attendance.status || '',
                    note: String(student.attendance.note || '').trim(),
                    isPlannedDefault: false
                };
            }
            if (student.plannedAbsence) {
                return {
                    status: 'absent',
                    note: String(student.plannedAbsence.reason || '').trim(),
                    isPlannedDefault: true
                };
            }
            return { status: '', note: '', isPlannedDefault: false };
        }

        function updateMarkStatus(studentId, value, options = {}) {
            const existing = markSelections.get(studentId) || {};
            const next = { ...existing, status: value };
            if (Object.prototype.hasOwnProperty.call(options, 'note')) {
                next.note = String(options.note || '').trim();
            } else if (value !== 'absent') {
                next.note = '';
                next.isPlannedDefault = false;
            }
            if (Object.prototype.hasOwnProperty.call(options, 'isPlannedDefault')) {
                next.isPlannedDefault = !!options.isPlannedDefault;
            }
            markSelections.set(studentId, next);
        }

        function applyMarkFilters() {
            const qRaw = (document.getElementById('markSearch')?.value || '').toLowerCase().trim();
            const qPhone = normalizePhone(qRaw);
            const statusFilter = document.getElementById('markStatusFilter')?.value || 'all';
            markFiltered = currentStudents.filter(student => {
                const name = (student.name || '').toLowerCase();
                if (qRaw && !name.includes(qRaw) && !phoneMatchesQuery(student.mobile, qRaw, qPhone)) {
                    return false;
                }
                if (statusFilter === 'not_marked') {
                    return !getEffectiveMarkState(student).status;
                }
                if (statusFilter !== 'all') {
                    const status = getEffectiveMarkState(student).status;
                    return status === statusFilter;
                }
                return true;
            });
            markPage = 1;
            renderMarkTable();
        }

        function bulkSetStatus(status) {
            markFiltered.forEach(student => {
                const studentId = String(student._id);
                updateMarkStatus(studentId, status);
            });
            renderMarkTable();
        }

        function bulkClearStatus() {
            markFiltered.forEach(student => {
                const studentId = String(student._id);
                markSelections.set(studentId, { ...markSelections.get(studentId), status: '', note: '', isPlannedDefault: false });
            });
            renderMarkTable();
        }

        function setMarkPage(page) {
            markPage = page;
            renderMarkTable();
        }

        function renderMarkPagination(total) {
            const container = document.getElementById('markPagination');
            if (!container) return;
            container.innerHTML = '';
        }

        function renderMarkTable() {
            const tableEl = document.getElementById('studentsTable');
            if (!tableEl) return;

            const total = currentStudents.length;
            const marked = currentStudents.filter(s => !!getEffectiveMarkState(s).status).length;
            const notMarked = total - marked;
            const alreadyMarked = marked;
            const markedByOthers = currentStudents.filter(s => s.attendance && s.attendance.markedBy && s.attendance.markedBy !== user.name).length;
            const summaryEl = document.getElementById('markSummary');
            if (summaryEl) {
                summaryEl.classList.remove('d-none');
                summaryEl.innerHTML = `
                    <strong>Batch Summary:</strong>
                    Total: <span class="badge bg-dark">${total}</span>
                    Marked: <span class="badge bg-success">${marked}</span>
                    Not Marked: <span class="badge bg-secondary">${notMarked}</span>
                    Already Marked: <span class="badge bg-info text-dark">${alreadyMarked}</span>
                    Marked by Other Teacher: <span class="badge bg-warning text-dark">${markedByOthers}</span>
                `;
            }

            if (!markFiltered || markFiltered.length === 0) {
                tableEl.innerHTML = '<div class="alert alert-warning">No students match the current filter</div>';
                renderMarkPagination(0);
                return;
            }

            const pageItems = markFiltered;

            let html = `
                <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Student</th>
                            <th class="text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            pageItems.forEach((student, index) => {
                const state = getEffectiveMarkState(student);
                const currentStatus = state.status;
                const isPresent = currentStatus === 'present';
                const isAbsent = currentStatus === 'absent';
                const prevAbsent = student.previousDay && student.previousDay.status === 'absent';
                const prevTwoAbsent = student.previousTwoDays && student.previousTwoDays.status === 'absent';
                const consecutiveAbsent = prevAbsent && prevTwoAbsent;
                const prevDayIcon = (!consecutiveAbsent && prevAbsent)
                    ? '<span class="ms-2 text-warning" title="Absent yesterday"><i class="bi bi-moon-stars-fill"></i></span>'
                    : '';
                const consecutiveIcon = consecutiveAbsent
                    ? '<span class="ms-2 text-danger" title="Absent last 2 days"><i class="bi bi-moon-stars-fill"></i></span>'
                    : '';
                const recentAbsentCount = (student.recent || []).filter(r => r.status === 'absent').length;
                const frequentAbsentBadge = recentAbsentCount >= 3
                    ? '<span class="badge bg-danger ms-2" title="3+ absences in last 7 days">Frequent Absence</span>'
                    : '';
                const plannedBadge = student.plannedAbsence
                    ? `<span class="badge bg-primary ms-2" title="Planned: ${escapeHtml(student.plannedAbsence.fromDate)} to ${escapeHtml(student.plannedAbsence.toDate)}">Planned: ${escapeHtml(student.plannedAbsence.reason || 'No reason')}</span>`
                    : '';
                const plannedNote = state.isPlannedDefault && state.note
                    ? `<div class="small text-primary mt-1"><i class="bi bi-info-circle"></i> ${escapeHtml(state.note)}</div>`
                    : '';

                html += `
                    <tr>
                        <td class="align-middle">${index + 1}</td>
                        <td class="align-middle fw-semibold">${student.name}${prevDayIcon}${consecutiveIcon}${frequentAbsentBadge}${plannedBadge}${plannedNote}</td>
                        <td class="align-middle">
                            <div class="d-flex justify-content-center gap-2 flex-wrap">
                                <label class="d-flex align-items-center gap-2 px-2 py-1 rounded-pill border shadow-sm bg-light" style="cursor:pointer;">
                                    <input type="radio" class="form-check-input m-0" name="status_${student._id}" value="present" ${isPresent ? 'checked' : ''} onchange="updateMarkStatus('${student._id}', this.value)">
                                    <span class="fw-semibold text-success">present</span>
                                </label>
                                <label class="d-flex align-items-center gap-2 px-2 py-1 rounded-pill border shadow-sm bg-light" style="cursor:pointer;">
                                    <input type="radio" class="form-check-input m-0" name="status_${student._id}" value="absent" ${isAbsent ? 'checked' : ''} onchange="updateMarkStatus('${student._id}', this.value)">
                                    <span class="fw-semibold text-danger">absent</span>
                                </label>
                            </div>
                        </td>
                    </tr>
                `;
            });

            const undoButton = lastMarkSubmission
                ? `<button class="btn btn-outline-danger btn-sm ms-2" onclick="undoLastSubmission()">Undo Last Submit</button>`
                : '';

            html += `
                    </tbody>
                </table>
                </div>
                <button class="btn btn-success btn-lg mt-3" id="submitAttendanceBtn" onclick="submitAttendance()">
                    <span class="spinner-border spinner-border-sm me-2 d-none" id="submitAttendanceSpinner" role="status" aria-hidden="true"></span>
                    <span id="submitAttendanceText">Submit Attendance</span>
                </button>
                ${undoButton}
            `;

            tableEl.innerHTML = html;
            renderMarkPagination(markFiltered.length);
        }

        // SUBMIT ATTENDANCE
        async function submitAttendance() {
            const region = document.getElementById('markRegion').value;
            const batch = document.getElementById('markBatch').value;
            const date = document.getElementById('markDate').value;

            if (!region || !date) {
                alert('Please select region and date');
                return;
            }
            if (isFutureDate(date)) {
                alert('Please select a valid date (not in the future).');
                return;
            }

            console.log('üì§ Submitting attendance for:', { region, batch, date });

            const submitBtn = document.getElementById('submitAttendanceBtn');
            const submitSpinner = document.getElementById('submitAttendanceSpinner');
            const submitText = document.getElementById('submitAttendanceText');
            const savingBanner = document.getElementById('savingBanner');

            const attendanceRecords = [];
            
            currentStudents.forEach(student => {
                const state = getEffectiveMarkState(student);
                const status = state.status;
                if (status) {
                    attendanceRecords.push({
                        studentId: student._id,
                        status: status,
                        note: state.note || ''
                    });
                }
            });

            console.log('‚úÖ Records to submit:', attendanceRecords.length);

            if (attendanceRecords.length === 0) {
                alert('Please mark at least one student');
                return;
            }

            if (attendanceRecords.length < currentStudents.length) {
                const confirmSubmit = window.confirm(
                    `You have marked ${attendanceRecords.length} out of ${currentStudents.length} students. Submit anyway?`
                );
                if (!confirmSubmit) return;
            }
            const markedByOthers = currentStudents.filter(s => s.attendance && s.attendance.markedBy && s.attendance.markedBy !== user.name).length;
            if (markedByOthers > 0) {
                const confirmOverwrite = window.confirm(
                    `Warning: ${markedByOthers} student(s) were already marked by another teacher. Submitting may cause conflicts. Continue?`
                );
                if (!confirmOverwrite) return;
            }

            try {
                if (submitBtn && submitSpinner && submitText) {
                    submitBtn.disabled = true;
                    submitSpinner.classList.remove('d-none');
                    submitText.textContent = 'Submitting...';
                }
                if (savingBanner) {
                    savingBanner.classList.remove('d-none');
                }

                const res = await fetch('/api/attendance/mark', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        date: date,
                        attendanceRecords: attendanceRecords
                    })
                });

                const data = await res.json();

                if (res.ok) {
                    // Check for conflicts
                    if (data.conflicts && data.conflicts.length > 0) {
                        let conflictMsg = `‚ö†Ô∏è CONFLICT DETECTED!\n\nThe following students were already marked by another teacher:\n\n`;
                        data.conflicts.forEach(c => {
                            conflictMsg += `‚Ä¢ ${c.studentName} - Marked ${c.status} by ${c.markedBy}\n`;
                        });
                        conflictMsg += `\n‚ùå These students were NOT updated to prevent data loss.`;
                        alert(conflictMsg);
                    }

                    // Show summary
                    let summary = `‚úÖ Attendance Processing Complete\n\n`;
                    summary += `Marked: ${data.results.successful} students\n`;
                    if (data.results.errors > 0) {
                        summary += `Errors/Conflicts: ${data.results.errors} students\n`;
                    }
                    if (data.conflicts && data.conflicts.length === 0) {
                        summary += `\nAll students marked successfully!`;
                    }
                    alert(summary);
                    lastMarkSubmission = {
                        region,
                        batchNumber: batch || 'all',
                        date,
                        studentIds: attendanceRecords.map(r => String(r.studentId))
                    };
                    loadMarkStudents(); // Reload
                } else {
                    alert('‚ùå Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error submitting attendance:', error);
                alert('Failed to submit attendance');
            } finally {
                if (submitBtn && submitSpinner && submitText) {
                    submitBtn.disabled = false;
                    submitSpinner.classList.add('d-none');
                    submitText.textContent = 'Submit Attendance';
                }
                if (savingBanner) {
                    savingBanner.classList.add('d-none');
                }
            }
        }

        async function undoLastSubmission() {
            if (!lastMarkSubmission) {
                alert('No submission to undo.');
                return;
            }
            const confirmUndo = window.confirm('Undo the last attendance submission? This will remove your marked records for this date/batch.');
            if (!confirmUndo) return;
            try {
                const res = await fetch('/api/attendance/undo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(lastMarkSubmission)
                });
                const data = await res.json();
                if (!res.ok) {
                    throw new Error(data.message || 'Undo failed');
                }
                alert(`Undo complete. Deleted: ${data.deleted || 0}`);
                lastMarkSubmission = null;
                loadMarkStudents();
            } catch (error) {
                alert('Undo failed: ' + error.message);
            }
        }
        // VIEW ATTENDANCE
        async function viewAttendance() {
            const region = document.getElementById('viewRegion').value;
            const batch = document.getElementById('viewBatch').value;
            const date = document.getElementById('viewDate').value;

            if (!region || !batch || !date) {
                alert('Please select region, batch, and date');
                return;
            }
            if (isFutureDate(date)) {
                alert('Please select a valid date (not in the future).');
                return;
            }

            console.log('Viewing attendance for:', { region, batch, date });

            try {
                const res = await fetch(
                    `/api/attendance/by-batch?region=${encodeURIComponent(region)}&batchNumber=${encodeURIComponent(batch)}&date=${date}`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );

                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }

                const students = await res.json();
                console.log('Attendance records loaded:', students.length);

                if (!students || students.length === 0) {
                    document.getElementById('viewResults').innerHTML =
                        '<div class="alert alert-warning">No students found in this batch</div>';
                    lastViewRawStudents = [];
                    lastViewAttendance = null;
                    return;
                }

                lastViewRawStudents = students;
                renderViewAttendanceResults(region, batch, date);

            } catch (error) {
                console.error('Error viewing attendance:', error);
                alert('Failed to load attendance');
            }
        }

        function applyViewDailyFilter() {
            if (!lastViewAttendance || !lastViewRawStudents || lastViewRawStudents.length === 0) {
                return;
            }
            renderViewAttendanceResults(lastViewAttendance.region, lastViewAttendance.batch, lastViewAttendance.date);
        }

        function renderViewAttendanceResults(region, batch, date) {
            if (!Array.isArray(lastViewRawStudents) || lastViewRawStudents.length === 0) {
                document.getElementById('viewResults').innerHTML =
                    '<div class="alert alert-warning">No students found in this batch</div>';
                lastViewAttendance = null;
                return;
            }

            const statusFilter = document.getElementById('viewStatusFilter')?.value || 'all';

            const normalized = lastViewRawStudents.map(student => {
                let statusKey = 'not_marked';
                let markedBy = '-';
                let statusBadge = getStatusBadge('');
                if (student.attendance) {
                    const status = student.attendance.status;
                    statusBadge = getStatusBadge(status);
                    markedBy = student.attendance.markedBy || '-';
                    if (status === 'present' || status === 'late' || status === 'leave') {
                        statusKey = 'present';
                    } else if (status === 'absent') {
                        statusKey = 'absent';
                    }
                }
                return { student, statusKey, markedBy, statusBadge };
            });

            const present = normalized.filter(x => x.statusKey === 'present').length;
            const absent = normalized.filter(x => x.statusKey === 'absent').length;
            const notMarked = normalized.filter(x => x.statusKey === 'not_marked').length;
            const absentNames = normalized.filter(x => x.statusKey === 'absent').map(x => String(x.student.name || ''));
            const isSuspendedClass = normalized.length > 0 && present === 0 && absent === normalized.length && notMarked === 0;
            const absentLabel = isSuspendedClass ? 'Suspend Class' : 'Absent';

            const filtered = statusFilter === 'all'
                ? normalized
                : normalized.filter(x => x.statusKey === statusFilter);

            let html = `
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Marked By</th>
                            <th>Parent Mobile</th>
                            <th class="text-center">Call</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const attendanceRows = [];
            filtered.forEach((item, index) => {
                const student = item.student;
                const isAbsent = item.statusKey === 'absent';
                const callButton = isAbsent
                    ? buildCallButtonHtml(student._id, student.mobile, 'view-attendance')
                    : '<span class="text-muted">-</span>';
                const parentMobile = student.mobile ? escapeHtml(student.mobile) : '-';

                attendanceRows.push({
                    index,
                    studentId: student._id,
                    name: String(student.name || ''),
                    batchNumber: String(student.batchNumber || ''),
                    mobile: String(student.mobile || ''),
                    statusKey: item.statusKey,
                    markedBy: item.markedBy
                });

                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${escapeHtml(student.name)}</td>
                        <td>${item.statusBadge}</td>
                        <td>${escapeHtml(item.markedBy)}</td>
                        <td>${parentMobile}</td>
                        <td class="text-center">${callButton}</td>
                    </tr>
                `;
            });

            if (filtered.length === 0) {
                html += `
                    <tr>
                        <td colspan="6" class="text-center text-muted">No students in selected filter</td>
                    </tr>
                `;
            }

            html += '</tbody></table>';

            const summary = `
                <div class="alert alert-info">
                    <strong>Summary:</strong>
                    Present: <span class="badge bg-success">${present}</span> |
                    ${absentLabel}: <span class="badge bg-danger">${absent}</span> |
                    Not Marked: <span class="badge bg-secondary">${notMarked}</span> |
                    Showing: <span class="badge bg-dark">${filtered.length}</span>
                </div>
                <div class="d-flex flex-wrap gap-2 mb-3">
                    <button class="btn btn-success" onclick="shareAttendanceWhatsApp()">Download Attendance PDF</button>
                </div>
            `;

            document.getElementById('viewResults').innerHTML = summary + html;
            lastViewAttendance = { region, batch, date, present, absent, notMarked, absentNames, suspendedClass: isSuspendedClass, records: attendanceRows };
        }

        function shareAttendanceWhatsApp() {
            if (!lastViewAttendance) {
                alert('Please load attendance first.');
                return;
            }

            const { region, batch, date, records, suspendedClass } = lastViewAttendance;
            if (!Array.isArray(records) || records.length === 0) {
                alert('No attendance records found to export.');
                return;
            }

            const jsPdfLib = window.jspdf;
            if (!jsPdfLib || !jsPdfLib.jsPDF) {
                alert('PDF library not loaded. Please refresh and try again.');
                return;
            }

            const presentCount = records.filter(r => r.statusKey === 'present').length;
            const absentRecords = records.filter(r => r.statusKey === 'absent');
            const notMarkedCount = records.filter(r => r.statusKey === 'not_marked').length;
            const isSuspendedClass = Boolean(suspendedClass) || (records.length > 0 && presentCount === 0 && absentRecords.length === records.length && notMarkedCount === 0);
            const absentLabel = isSuspendedClass ? 'Suspend Class' : 'Absent';

            const statusLabel = (statusKey) => {
                if (statusKey === 'present') return 'Present';
                if (statusKey === 'absent') return absentLabel;
                return 'Not Marked';
            };

            const rows = records.map((r, index) => ([
                String(index + 1),
                String(r.name || '-'),
                String(r.batchNumber || batch || '-'),
                statusLabel(r.statusKey)
            ]));

            const doc = new jsPdfLib.jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
            doc.setFontSize(16);
            doc.text('Daily Attendance Report', 40, 44);

            doc.setFontSize(11);
            doc.text(`Date: ${date}`, 40, 68);
            doc.text(`Region: ${region}`, 40, 84);
            doc.text(`Batch: ${batch}`, 40, 100);
            doc.text(`Total Students: ${records.length}`, 40, 116);
            doc.text(`Present: ${presentCount}   ${absentLabel}: ${absentRecords.length}   Not Marked: ${notMarkedCount}`, 40, 132);
            doc.text(`Generated By: ${user.name || 'Class Teacher'}`, 40, 148);

            doc.autoTable({
                startY: 168,
                head: [['S.No', 'Student Name', 'Batch Number', 'Status']],
                body: rows,
                styles: { fontSize: 10, cellPadding: 6 },
                headStyles: { fillColor: [14, 165, 164], textColor: [255, 255, 255] },
                alternateRowStyles: { fillColor: [245, 250, 250] },
                theme: 'grid'
            });

            const safeRegion = String(region || 'region').replace(/[^\w-]/g, '_');
            const safeBatch = String(batch || 'batch').replace(/[^\w-]/g, '_');
            const safeDate = String(date || new Date().toISOString().split('T')[0]);
            doc.save(`Daily_Attendance_${safeRegion}_${safeBatch}_${safeDate}.pdf`);
        }

        async function viewPlannedStudentsAttendance() {
            const region = document.getElementById('viewRegion').value;
            const batch = document.getElementById('viewBatch').value;
            const date = document.getElementById('viewDate').value;
            const selectedMonth = document.getElementById('viewPlannedMonth')?.value || (date ? date.slice(0, 7) : today.slice(0, 7));

            if (!region || !batch) {
                alert('Please select region and batch (or all batches).');
                return;
            }

            try {
                const monthMatch = /^(\d{4})-(\d{2})$/.exec(String(selectedMonth || ''));
                if (!monthMatch) {
                    alert('Please select a valid month for planned attendance.');
                    return;
                }

                const year = Number(monthMatch[1]);
                const month = Number(monthMatch[2]);
                const thisMonthStart = `${year}-${String(month).padStart(2, '0')}-01`;
                const thisMonthLastDay = new Date(year, month, 0).getDate();
                const thisMonthEnd = `${year}-${String(month).padStart(2, '0')}-${String(thisMonthLastDay).padStart(2, '0')}`;

                const prevMonth = month === 1 ? 12 : month - 1;
                const prevYear = month === 1 ? year - 1 : year;
                const prevMonthStart = `${prevYear}-${String(prevMonth).padStart(2, '0')}-01`;

                const params = new URLSearchParams();
                params.append('region', region);
                params.append('batchNumber', batch);
                params.append('startDate', prevMonthStart);
                params.append('endDate', thisMonthEnd);

                const res = await fetch(`/api/attendance/planned-absences?${params.toString()}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }

                const rows = await res.json();
                if (!rows || rows.length === 0) {
                    document.getElementById('viewResults').innerHTML = `
                        <div class="alert alert-warning">No planned students attendance found for selected region/batch in ${prevMonthStart} to ${thisMonthEnd}.</div>
                    `;
                    return;
                }

                const sortedRows = rows.slice().sort((a, b) => {
                    if (a.fromDate === b.fromDate) return String(a.studentName || '').localeCompare(String(b.studentName || ''));
                    return String(a.fromDate || '').localeCompare(String(b.fromDate || ''));
                });

                let html = `
                    <div class="alert alert-info">
                        <strong>Planned Students Attendance:</strong>
                        Region <span class="badge bg-primary">${escapeHtml(region)}</span>
                        | Batch <span class="badge bg-dark">${escapeHtml(batch)}</span>
                        ${date ? `| Selected Date <span class="badge bg-secondary">${escapeHtml(date)}</span>` : ''}
                        | Month <span class="badge bg-info text-dark">${escapeHtml(selectedMonth)}</span>
                        | Range <span class="badge bg-secondary">${escapeHtml(prevMonthStart)} to ${escapeHtml(thisMonthEnd)}</span>
                        | Total <span class="badge bg-success">${sortedRows.length}</span>
                    </div>
                    <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Student Name</th>
                                <th>Batch Number</th>
                                <th>Month</th>
                                <th>Planned From</th>
                                <th>Planned To</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                sortedRows.forEach((item, index) => {
                    const fromMonth = String(item.fromDate || '').slice(0, 7);
                    const toMonth = String(item.toDate || '').slice(0, 7);
                    const monthLabel = fromMonth && toMonth
                        ? (fromMonth === toMonth ? fromMonth : `${fromMonth} to ${toMonth}`)
                        : '-';
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${escapeHtml(item.studentName || '-')}</td>
                            <td>${escapeHtml(item.batchNumber || '-')}</td>
                            <td>${escapeHtml(monthLabel)}</td>
                            <td>${escapeHtml(item.fromDate || '-')}</td>
                            <td>${escapeHtml(item.toDate || '-')}</td>
                            <td>${escapeHtml(item.reason || '-')}</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                    </div>
                `;

                document.getElementById('viewResults').innerHTML = html;
            } catch (error) {
                console.error('Error loading planned students attendance:', error);
                document.getElementById('viewResults').innerHTML =
                    `<div class="alert alert-danger">Failed to load planned students attendance: ${escapeHtml(error.message)}</div>`;
            }
        }

        async function shareDailySummaryAllBatches() {
            const region = document.getElementById('viewRegion').value;
            const batch = document.getElementById('viewBatch').value;
            const date = document.getElementById('viewDate').value;

            if (!region || !batch || !date) {
                alert('Please select region, batch, and date');
                return;
            }
            if (isFutureDate(date)) {
                alert('Please select a valid date (not in the future).');
                return;
            }

            try {
                const jsPdfLib = window.jspdf;
                if (!jsPdfLib || !jsPdfLib.jsPDF) {
                    alert('PDF library not loaded. Please refresh and try again.');
                    return;
                }

                let batchesToFetch = [];
                if (batch === 'all') {
                    const batchesRes = await fetch(`/api/students/batches/${encodeURIComponent(region)}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!batchesRes.ok) {
                        throw new Error(`API Error: ${batchesRes.status}`);
                    }
                    const batches = await batchesRes.json();
                    if (!batches || batches.length === 0) {
                        alert('No batches found for this region');
                        return;
                    }
                    batchesToFetch = batches;
                } else {
                    batchesToFetch = [batch];
                }

                const batchRows = [];
                const summaries = await Promise.all(
                    batchesToFetch.map(async (b) => {
                        const res = await fetch(
                            `/api/attendance/by-batch?region=${encodeURIComponent(region)}&batchNumber=${encodeURIComponent(b)}&date=${date}`,
                            { headers: { 'Authorization': `Bearer ${token}` } }
                        );
                        if (!res.ok) {
                            throw new Error(`API Error: ${res.status}`);
                        }
                        const students = await res.json();
                        if (!students || students.length === 0) {
                            return null;
                        }

                        let present = 0, absent = 0, notMarked = 0;
                        const batchRawRows = [];
                        students.forEach((student) => {
                            let statusKey = 'not_marked';
                            if (student.attendance) {
                                if (['present', 'late', 'leave'].includes(student.attendance.status)) {
                                    present++;
                                    statusKey = 'present';
                                } else {
                                    absent++;
                                    statusKey = 'absent';
                                }
                            } else {
                                notMarked++;
                            }

                            batchRawRows.push({
                                name: String(student.name || '-'),
                                batchNumber: String(student.batchNumber || b || '-'),
                                statusKey
                            });
                        });

                        const isBatchSuspended = students.length > 0 && present === 0 && absent === students.length && notMarked === 0;
                        const absentLabel = isBatchSuspended ? 'Suspend Class' : 'Absent';

                        batchRawRows.forEach((row) => {
                            let status = 'Not Marked';
                            if (row.statusKey === 'present') status = 'Present';
                            if (row.statusKey === 'absent') status = absentLabel;
                            batchRows.push([
                                String(batchRows.length + 1),
                                row.name,
                                row.batchNumber,
                                status,
                                String(date)
                            ]);
                        });

                        return { batch: b, present, absent, notMarked, total: students.length, suspendedClass: isBatchSuspended };
                    })
                );

                const cleaned = summaries.filter(Boolean);
                if (cleaned.length === 0) {
                    alert('No students found in batches for this date');
                    return;
                }

                const totalStudents = cleaned.reduce((sum, s) => sum + s.total, 0);
                const totalPresent = cleaned.reduce((sum, s) => sum + s.present, 0);
                const totalAbsent = cleaned.reduce((sum, s) => sum + s.absent, 0);
                const totalNotMarked = cleaned.reduce((sum, s) => sum + s.notMarked, 0);
                const suspendedBatchCount = cleaned.filter(s => !!s.suspendedClass).length;
                const allBatchesSuspended = cleaned.length > 0 && suspendedBatchCount === cleaned.length;
                const absentLabel = allBatchesSuspended ? 'Suspend Class' : 'Absent';

                const doc = new jsPdfLib.jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
                doc.setFontSize(16);
                doc.text('Daily Attendance Summary', 40, 44);
                doc.setFontSize(11);
                doc.text(`Date: ${date}`, 40, 68);
                doc.text(`Region: ${region}`, 40, 84);
                doc.text(`Batch: ${batch === 'all' ? 'All Batches' : batch}`, 40, 100);
                doc.text(`Total Students: ${totalStudents}`, 40, 116);
                doc.text(`Present: ${totalPresent}   ${absentLabel}: ${totalAbsent}   Not Marked: ${totalNotMarked}`, 40, 132);
                let generatedByY = 148;
                if (!allBatchesSuspended && suspendedBatchCount > 0) {
                    doc.text(`Suspended Batches: ${suspendedBatchCount}`, 40, 148);
                    generatedByY = 164;
                }
                doc.text(`Generated By: ${user.name || 'Class Teacher'}`, 40, generatedByY);

                doc.autoTable({
                    startY: 168,
                    head: [['S.No', 'Student Name', 'Batch Number', 'Status', 'Date']],
                    body: batchRows,
                    styles: { fontSize: 10, cellPadding: 6 },
                    headStyles: { fillColor: [14, 165, 164], textColor: [255, 255, 255] },
                    alternateRowStyles: { fillColor: [245, 250, 250] },
                    theme: 'grid'
                });

                const safeRegion = String(region || 'region').replace(/[^\w-]/g, '_');
                const safeBatch = String(batch || 'batch').replace(/[^\w-]/g, '_');
                const safeDate = String(date || new Date().toISOString().split('T')[0]);
                const fileName = `Daily_Summary_${safeRegion}_${safeBatch}_${safeDate}.pdf`;
                const pdfBlob = doc.output('blob');

                const shareText = `Daily attendance summary (${date}) - ${region}, ${batch === 'all' ? 'All Batches' : `Batch ${batch}`}`;
                let file = null;
                try {
                    file = new File([pdfBlob], fileName, { type: 'application/pdf' });
                } catch (e) {
                    file = null;
                }

                if (file && navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        title: 'Daily Attendance Summary',
                        text: shareText,
                        files: [file]
                    });
                } else {
                    doc.save(fileName);
                    const waUrl = `https://wa.me/?text=${encodeURIComponent(shareText + '. PDF downloaded. Please attach and send on WhatsApp.')}`;
                    window.open(waUrl, '_blank');
                }
            } catch (error) {
                console.error('Error sharing daily summary:', error);
                alert('Failed to create summary: ' + error.message);
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        // ===== VIEW STUDENTS FUNCTIONS =====
        // ===== VIEW STUDENTS FUNCTIONS =====
        async function loadStudentsRegions() {
            try {
                console.log('Loading regions for students view...');
                const res = await fetch('/api/students/regions/all', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }

                const regions = await res.json();
                console.log('Regions loaded:', regions);

                const select = document.getElementById('studentsRegion');
                const batchSelect = document.getElementById('studentsBatch');
                if (select) select.innerHTML = '<option value="">Select Region</option>';
                if (batchSelect) batchSelect.innerHTML = '<option value="">Select Batch</option>';
                document.getElementById('studentsResults').innerHTML = '';

                if (!regions || regions.length === 0) {
                    if (select) select.innerHTML += '<option disabled>No regions available</option>';
                    return;
                }

                regions.forEach(region => {
                    if (select) select.innerHTML += `<option value="${region}">${region}</option>`;
                });
            } catch (error) {
                console.error('Error loading regions:', error);
            }
        }

        async function loadStudentsBatches() {
            const region = document.getElementById('studentsRegion').value;
            if (!region) {
                document.getElementById('studentsBatch').innerHTML = '<option value="">Select Batch</option>';
                document.getElementById('studentsResults').innerHTML = '';
                return;
            }

            try {
                const res = await fetch(`/api/students/batches/${encodeURIComponent(region)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }

                const batches = await res.json();
                const select = document.getElementById('studentsBatch');
                select.innerHTML = '<option value="">Select Batch</option>';
                select.innerHTML += '<option value="__all__">All Batches</option>';

                if (!batches || batches.length === 0) {
                    select.value = '__all__';
                    loadStudentsData();
                    return;
                }

                batches.forEach(batch => {
                    select.innerHTML += `<option value="${batch}">${batch}</option>`;
                });
            } catch (error) {
                console.error('Error loading batches:', error);
            }
        }

        async function loadStudentsData() {
            const region = document.getElementById('studentsRegion').value;
            const batch = document.getElementById('studentsBatch').value;

            if (!region || !batch) {
                return;
            }

            try {
                const query = new URLSearchParams({
                    region,
                    status: 'all'
                });
                if (batch && batch !== '__all__') {
                    query.set('batchNumber', batch);
                }

                const res = await fetch(`/api/students?${query.toString()}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }

                const students = await res.json();

                if (!students || students.length === 0) {
                    document.getElementById('studentsResults').innerHTML =
                        '<div class="alert alert-warning">No students found for this selection</div>';
                    return;
                }

                const studentsSearch = document.getElementById('studentsSearch');
                const studentsStatusFilter = document.getElementById('studentsStatusFilter');
                const studentsAgeFilter = document.getElementById('studentsAgeFilter');
                const studentsAgeValue = document.getElementById('studentsAgeValue');
                if (studentsSearch) studentsSearch.value = '';
                if (studentsStatusFilter) studentsStatusFilter.value = 'all';
                if (studentsAgeFilter) studentsAgeFilter.value = 'all';
                if (studentsAgeValue) studentsAgeValue.value = '';

                studentsData = students.slice();
                studentsFiltered = students.slice();
                studentsPage = 1;
                renderStudentsTable();
            } catch (error) {
                console.error('Error loading students:', error);
                document.getElementById('studentsResults').innerHTML =
                    `<div class="alert alert-danger">Error loading students: ${error.message}</div>`;
            }
        }

        async function exportStudentsDetails() {
            const region = document.getElementById('studentsRegion').value;
            const batch = document.getElementById('studentsBatch').value;
            if (!region) {
                alert('Please select a region first');
                return;
            }
            if (!batch) {
                alert('Please select a batch or choose All Batches');
                return;
            }

            try {
                const query = new URLSearchParams({
                    region,
                    status: 'all'
                });
                if (batch && batch !== '__all__') {
                    query.set('batchNumber', batch);
                }

                const res = await fetch(`/api/students?${query.toString()}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }

                const students = await res.json();
                if (!students || students.length === 0) {
                    alert('No students found for export');
                    return;
                }

                const rows = students.map((student, index) => ({
                    'S.No': index + 1,
                    'Student ID': student._id || '',
                    'Student Name': student.name || '',
                    'Region': student.region || '',
                    'Batch': student.batchNumber || '',
                    'School Name': student.schoolName || '',
                    'Standard': student.standard || '',
                    'Mobile': student.mobile || '',
                    'Age': student.age ?? '',
                    'Status': student.isActive ? 'Active' : 'Inactive'
                }));

                const ws = XLSX.utils.json_to_sheet(rows);
                ws['!cols'] = [
                    { wch: 8 },
                    { wch: 28 },
                    { wch: 28 },
                    { wch: 18 },
                    { wch: 14 },
                    { wch: 34 },
                    { wch: 14 },
                    { wch: 18 },
                    { wch: 10 },
                    { wch: 12 }
                ];

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Students');
                const fileName = batch === '__all__'
                    ? `Students_${region}_AllBatches.xlsx`
                    : `Students_${region}_${batch}.xlsx`;
                XLSX.writeFile(wb, fileName);
            } catch (error) {
                console.error('Error exporting students details:', error);
                alert('Failed to export students details');
            }
        }

        function applyStudentsFilters() {
            const qRaw = (document.getElementById('studentsSearch')?.value || '').trim().toLowerCase();
            const qPhone = normalizePhone(qRaw);
            const statusFilter = document.getElementById('studentsStatusFilter')?.value || 'all';
            const ageFilter = document.getElementById('studentsAgeFilter')?.value || 'all';
            const ageValueRaw = (document.getElementById('studentsAgeValue')?.value || '').trim();
            const ageValue = Number(ageValueRaw);
            const hasAgeValue = ageValueRaw !== '' && Number.isFinite(ageValue);

            studentsFiltered = (studentsData || []).filter(student => {
                const name = String(student.name || '').toLowerCase();
                const matchesText = !qRaw || name.includes(qRaw) || phoneMatchesQuery(student.mobile, qRaw, qPhone);
                if (!matchesText) return false;

                if (statusFilter === 'active' && !student.isActive) return false;
                if (statusFilter === 'inactive' && !!student.isActive) return false;

                const studentAge = Number(student.age);
                if (ageFilter === 'all') return true;
                if (!hasAgeValue || !Number.isFinite(studentAge)) return false;
                if (ageFilter === 'above') return studentAge > ageValue;
                if (ageFilter === 'below') return studentAge < ageValue;
                if (ageFilter === 'equal') return studentAge === ageValue;
                if (ageFilter === 'above_or_equal') return studentAge >= ageValue;
                if (ageFilter === 'below_or_equal') return studentAge <= ageValue;
                return true;
            });

            studentsPage = 1;
            renderStudentsTable();
        }

        function fetchStudentByMobile() {
            const mobileInput = document.getElementById('studentsMobileLookup');
            const raw = (mobileInput?.value || '').trim();
            const qPhone = normalizePhone(raw);

            if (!qPhone) {
                alert('Please enter mobile number');
                return;
            }

            const statusFilter = document.getElementById('studentsStatusFilter')?.value || 'all';
            const ageFilter = document.getElementById('studentsAgeFilter')?.value || 'all';
            const ageValueRaw = (document.getElementById('studentsAgeValue')?.value || '').trim();
            const ageValue = Number(ageValueRaw);
            const hasAgeValue = ageValueRaw !== '' && Number.isFinite(ageValue);
            const matched = (studentsData || []).filter(student => {
                if (!phoneMatchesQuery(student.mobile, raw.toLowerCase(), qPhone)) return false;
                if (statusFilter === 'active' && !student.isActive) return false;
                if (statusFilter === 'inactive' && !!student.isActive) return false;

                const studentAge = Number(student.age);
                if (ageFilter === 'all') return true;
                if (!hasAgeValue || !Number.isFinite(studentAge)) return false;
                if (ageFilter === 'above') return studentAge > ageValue;
                if (ageFilter === 'below') return studentAge < ageValue;
                if (ageFilter === 'equal') return studentAge === ageValue;
                if (ageFilter === 'above_or_equal') return studentAge >= ageValue;
                if (ageFilter === 'below_or_equal') return studentAge <= ageValue;
                return true;
            });

            studentsFiltered = matched;
            studentsPage = 1;
            renderStudentsTable();
        }

        function handleStudentsMobileEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                fetchStudentByMobile();
            }
        }

        function setStudentsPage(page) {
            studentsPage = page;
            renderStudentsTable();
        }

        function renderStudentsPagination(total) {
            const container = document.getElementById('studentsPagination');
            if (!container) return;
            container.innerHTML = '';
        }

        function getAgeSummary(students, threshold) {
            const safeThreshold = Number.isFinite(threshold) ? threshold : 15;
            const summary = { below: 0, equal: 0, above: 0, noAge: 0, threshold: safeThreshold };
            (students || []).forEach(student => {
                const studentAge = Number(student.age);
                if (!Number.isFinite(studentAge)) {
                    summary.noAge += 1;
                    return;
                }
                if (studentAge < safeThreshold) summary.below += 1;
                else if (studentAge > safeThreshold) summary.above += 1;
                else summary.equal += 1;
            });
            return summary;
        }

        function renderStudentsTable() {
            const resultsEl = document.getElementById('studentsResults');
            if (!resultsEl) return;
            if (!studentsFiltered || studentsFiltered.length === 0) {
                resultsEl.innerHTML = '<div class="alert alert-warning">No students match the current filter</div>';
                renderStudentsPagination(0);
                return;
            }

            const pageItems = studentsFiltered;
            const ageValueRaw = (document.getElementById('studentsAgeValue')?.value || '').trim();
            const ageValue = Number(ageValueRaw);
            const ageSummary = getAgeSummary(studentsData, Number.isFinite(ageValue) ? ageValue : 15);

            let html = `
                <div class="alert alert-info">
                    <h6>Showing: <strong>${studentsFiltered.length}</strong> | Total Loaded: <strong>${(studentsData || []).length}</strong></h6>
                    <div>Age Summary (threshold ${ageSummary.threshold}):</div>
                    <div>
                        Below: <strong>${ageSummary.below}</strong> |
                        Equal: <strong>${ageSummary.equal}</strong> |
                        Above: <strong>${ageSummary.above}</strong> |
                        No Age: <strong>${ageSummary.noAge}</strong>
                    </div>
                </div>
                <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Student Name</th>
                            <th>School</th>
                            <th>Standard</th>
                            <th>Mobile</th>
                            <th>Age</th>
                            <th>Status</th>
                            <th>Contact</th>
                            <th>Profile</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            pageItems.forEach((student, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${student.name}</td>
                        <td>${student.schoolName || '-'}</td>
                        <td>${student.standard || '-'}</td>
                        <td>${student.mobile || '-'}</td>
                        <td>${student.age || '-'}</td>
                        <td>${student.isActive ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>'}</td>
                        <td>${buildCallButtonHtml(student._id, student.mobile, 'students-details', 'Call Parent')}</td>
                        <td><button class="btn btn-sm btn-info" onclick="viewStudentProfile('${student._id}')">View</button></td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
                </div>
            `;

            resultsEl.innerHTML = html;
            renderStudentsPagination(studentsFiltered.length);
        }

        // REPORT SECTION FUNCTIONS
        async function loadReportRegions() {
            try {
                console.log('üìö Loading report regions...');
                const res = await fetch('/api/students/regions/all', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) {
                    throw new Error(`API Error: ${res.status}`);
                }
                
                const regions = await res.json();
                console.log('‚úÖ Report regions loaded:', regions);
                
                const select = document.getElementById('reportRegion');
                if (!select) {
                    console.error('‚ùå reportRegion element not found');
                    return;
                }
                
                select.innerHTML = '<option value="">Select Region</option>';
                
                if (!regions || regions.length === 0) {
                    console.warn('‚ö†Ô∏è No regions found');
                    select.innerHTML += '<option disabled>No regions available</option>';
                    return;
                }
                
                regions.forEach(region => {
                    select.innerHTML += `<option value="${region}">${region}</option>`;
                });
            } catch (error) {
                console.error('‚ùå Error loading report regions:', error);
            }
        }

        async function loadReportBatches() {
            const region = document.getElementById('reportRegion').value;
            if (!region) return;

            try {
                const res = await fetch(`/api/students/batches/${encodeURIComponent(region)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const batches = await res.json();
                
                const select = document.getElementById('reportBatch');
                select.innerHTML = '<option value="">Select Batch</option>';
                select.innerHTML += '<option value="all">All Batches</option>';
                batches.forEach(batch => {
                    select.innerHTML += `<option value="${batch}">${batch}</option>`;
                });
                select.value = 'all';
            } catch (error) {
                console.error('Error loading batches:', error);
            }
        }

        async function fetchReportSummaryByBatch(region, batch, startDate, endDate, filterType) {
            const res = await fetch(
                `/api/attendance/summary?region=${encodeURIComponent(region)}&batchNumber=${encodeURIComponent(batch)}&startDate=${startDate}&endDate=${endDate}&filterType=${filterType}`,
                { headers: { 'Authorization': `Bearer ${token}` } }
            );
            if (!res.ok) {
                throw new Error(`API Error: ${res.status}`);
            }
            return res.json();
        }

        function updateFilterUI() {
            const filterType = document.getElementById('filterType').value;
            const dateLabel = document.getElementById('dateLabel');
            const endLabel = document.getElementById('endLabel');
            const startInput = document.getElementById('reportStartDate');
            const endInput = document.getElementById('reportEndDate');

            if (filterType === 'month') {
                dateLabel.textContent = 'Year-Month';
                endLabel.textContent = '';
                startInput.type = 'month';
                startInput.value = new Date().toISOString().slice(0, 7);
                endInput.style.display = 'none';
            } else {
                dateLabel.textContent = 'Start Date';
                endLabel.textContent = 'End Date';
                startInput.type = 'date';
                startInput.value = new Date().toISOString().split('T')[0];
                endInput.style.display = 'block';
                endInput.type = 'date';
                endInput.value = new Date().toISOString().split('T')[0];
            }
        }
        async function viewReport() {
            const region = document.getElementById('reportRegion').value;
            const batch = document.getElementById('reportBatch').value;
            const filterType = document.getElementById('filterType').value;
            let startDate = document.getElementById('reportStartDate').value;
            let endDate = document.getElementById('reportEndDate').value;

            if (!region || !batch || !startDate) {
                alert('Please select region, batch, and date(s)');
                return;
            }

            if (filterType === 'month') {
                const [year, month] = startDate.split('-');
                startDate = `${year}-${month}-01`;
                const lastDay = new Date(year, month, 0).getDate();
                endDate = `${year}-${month}-${lastDay}`;
            } else if (!endDate) {
                alert('Please select end date');
                return;
            }

            try {
                let mergedSummary = [];
                let stats = null;

                if (batch === 'all') {
                    const batchRes = await fetch(`/api/students/batches/${encodeURIComponent(region)}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!batchRes.ok) {
                        throw new Error(`API Error: ${batchRes.status}`);
                    }
                    const batches = await batchRes.json();
                    if (!Array.isArray(batches) || batches.length === 0) {
                        document.getElementById('reportResults').innerHTML =
                            '<div class="alert alert-warning">No batches found for this region</div>';
                        lastReportShareData = null;
                        return;
                    }

                    const allResponses = await Promise.all(
                        batches.map(b => fetchReportSummaryByBatch(region, b, startDate, endDate, filterType))
                    );

                    allResponses.forEach((data, idx) => {
                        const b = batches[idx];
                        (data.summary || []).forEach(student => {
                            mergedSummary.push({ ...student, reportBatch: student.batchNumber || b });
                        });
                    });

                    const totalPresent = mergedSummary.reduce((sum, s) => sum + ((s.present || 0) + (s.late || 0) + (s.leave || 0)), 0);
                    const totalAbsent = mergedSummary.reduce((sum, s) => sum + (s.absent || 0), 0);
                    const totalClasses = mergedSummary.reduce((sum, s) => sum + (s.totalClasses || 0), 0);
                    stats = {
                        totalClasses,
                        totalStudents: mergedSummary.length,
                        totalPresent,
                        totalAbsent,
                        dateRange: { start: startDate, end: endDate, filterType }
                    };
                } else {
                    const data = await fetchReportSummaryByBatch(region, batch, startDate, endDate, filterType);
                    mergedSummary = (data.summary || []).map(student => ({ ...student, reportBatch: student.batchNumber || batch }));
                    stats = data.stats || null;
                }

                if (!mergedSummary || mergedSummary.length === 0) {
                    document.getElementById('reportResults').innerHTML =
                        '<div class="alert alert-warning">No attendance records found for the selected period</div>';
                    lastReportShareData = null;
                    return;
                }

                let html = `
                    <div class="alert alert-info">
                        <h6>Summary Statistics</h6>
                        <div class="row">
                            <div class="col-md-3"><strong>Total Classes:</strong> ${stats.totalClasses}</div>
                            <div class="col-md-3"><strong>Total Students:</strong> ${stats.totalStudents}</div>
                            <div class="col-md-3"><strong>Total Present:</strong> <span class="badge bg-success">${stats.totalPresent}</span></div>
                            <div class="col-md-3"><strong>Total Absent:</strong> <span class="badge bg-danger">${stats.totalAbsent}</span></div>
                        </div>
                        <p class="mt-2 mb-0"><strong>Period:</strong> ${stats.dateRange.start} to ${stats.dateRange.end}</p>
                    </div>

                    <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th class="text-center">S.No</th>
                                <th>Student Name</th>
                                <th>Date of Joining</th>
                                <th>Batch</th>
                                <th class="text-center">Total Classes</th>
                                <th class="text-center">Marked</th>
                                <th class="text-center">Present</th>
                                <th class="text-center">Absent</th>
                                <th class="text-center">Attendance %</th>
                                <th>Marked By</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                const formatJoinDate = (value) => {
                    if (!value) return '-';
                    const d = new Date(value);
                    if (Number.isNaN(d.getTime())) return '-';
                    return d.toISOString().split('T')[0];
                };

                mergedSummary.forEach((student, index) => {
                    const percentage = parseFloat(student.percentage);
                    let percentBadge = 'bg-danger';
                    if (percentage >= 75) {
                        percentBadge = 'bg-success';
                    } else if (percentage >= 50) {
                        percentBadge = 'bg-warning';
                    }

                    const markedBy = student.markedBy || '-';
                    const presentTotal = (student.present || 0) + (student.late || 0) + (student.leave || 0);

                    html += `
                        <tr>
                            <td class="text-center">${index + 1}</td>
                            <td>${student.name}</td>
                            <td>${formatJoinDate(student.enrollmentDate)}</td>
                            <td>${student.reportBatch || '-'}</td>
                            <td class="text-center"><strong>${student.totalClasses}</strong></td>
                            <td class="text-center">${student.totalMarked}/${student.totalClasses}</td>
                            <td class="text-center"><span class="badge bg-success">${presentTotal}</span></td>
                            <td class="text-center"><span class="badge bg-danger">${student.absent}</span></td>
                            <td class="text-center"><span class="badge ${percentBadge}">${student.percentage}%</span></td>
                            <td>${markedBy}</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                    </div>
                    <button class="btn btn-secondary mt-3" onclick="printReport()">Print Report</button>
                `;

                document.getElementById('reportResults').innerHTML = html;
                lastReportShareData = {
                    region,
                    batch,
                    filterType,
                    startDate,
                    endDate,
                    stats,
                    summary: mergedSummary
                };

            } catch (error) {
                console.error('Error viewing report:', error);
                document.getElementById('reportResults').innerHTML =
                    `<div class="alert alert-danger">Failed to generate the report: ${error.message}</div>`;
                lastReportShareData = null;
            }
        }

        async function shareReportToWhatsApp() {
            if (!lastReportShareData || !Array.isArray(lastReportShareData.summary) || lastReportShareData.summary.length === 0) {
                alert('Please generate report first.');
                return;
            }

            const jsPdfLib = window.jspdf;
            if (!jsPdfLib || !jsPdfLib.jsPDF) {
                alert('PDF library not loaded. Please refresh and try again.');
                return;
            }

            try {
                const { region, batch, filterType, startDate, endDate, summary } = lastReportShareData;
                const totalPresent = summary.reduce((sum, s) => sum + ((s.present || 0) + (s.late || 0) + (s.leave || 0)), 0);
                const totalAbsent = summary.reduce((sum, s) => sum + (s.absent || 0), 0);
                const formatJoinDate = (value) => {
                    if (!value) return '-';
                    const d = new Date(value);
                    if (Number.isNaN(d.getTime())) return '-';
                    return d.toISOString().split('T')[0];
                };

                const rows = summary.map((s) => ([
                    String(s.name || '-'),
                    String(s.reportBatch || s.batchNumber || '-'),
                    String(formatJoinDate(s.enrollmentDate)),
                    String(s.totalClasses || 0),
                    String((s.present || 0) + (s.late || 0) + (s.leave || 0)),
                    String(s.absent || 0),
                    `${Number(s.percentage || 0).toFixed(2)}%`
                ]));

                const doc = new jsPdfLib.jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
                doc.setFontSize(16);
                doc.text('Attendance Report Summary', 40, 44);
                doc.setFontSize(11);
                doc.text(`Region: ${region}`, 40, 68);
                doc.text(`Batch: ${batch === 'all' ? 'All Batches' : batch}`, 40, 84);
                doc.text(`Filter: ${filterType === 'month' ? 'Month' : 'Date Range'}`, 40, 100);
                doc.text(`Period: ${startDate} to ${endDate}`, 40, 116);
                doc.text(`Total Students: ${summary.length}   Present: ${totalPresent}   Absent: ${totalAbsent}`, 40, 132);
                doc.text(`Generated By: ${user.name || 'Class Teacher'}`, 40, 148);

                doc.autoTable({
                    startY: 168,
                    head: [['Student Name', 'Batch Number', 'Date of Joining', 'Total Class', 'Attended Class', 'Absent', 'Percentage']],
                    body: rows,
                    styles: { fontSize: 10, cellPadding: 6 },
                    headStyles: { fillColor: [14, 165, 164], textColor: [255, 255, 255] },
                    alternateRowStyles: { fillColor: [245, 250, 250] },
                    theme: 'grid'
                });

                const safeRegion = String(region || 'region').replace(/[^\w-]/g, '_');
                const safeBatch = String(batch || 'batch').replace(/[^\w-]/g, '_');
                const fileName = `Report_Summary_${safeRegion}_${safeBatch}_${startDate}_to_${endDate}.pdf`;
                const pdfBlob = doc.output('blob');

                let file = null;
                try {
                    file = new File([pdfBlob], fileName, { type: 'application/pdf' });
                } catch (e) {
                    file = null;
                }

                const shareText = `Attendance report (${startDate} to ${endDate}) - ${region}, ${batch === 'all' ? 'All Batches' : `Batch ${batch}`}`;
                if (file && navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        title: 'Attendance Report',
                        text: shareText,
                        files: [file]
                    });
                } else {
                    doc.save(fileName);
                    const waUrl = `https://wa.me/?text=${encodeURIComponent(shareText + '. PDF downloaded. Please attach and send on WhatsApp.')}`;
                    window.open(waUrl, '_blank');
                }
            } catch (error) {
                console.error('Error sharing report to WhatsApp:', error);
                alert('Failed to share report: ' + error.message);
            }
        }
        function printReport() {
            window.print();
        }

        function formatDateTime(value) {
            const dt = new Date(value);
            if (Number.isNaN(dt.getTime())) return '-';
            return dt.toISOString().replace('T', ' ').slice(0, 16);
        }

        function isFutureDate(value) {
            if (!value) return false;
            const todayStr = new Date().toISOString().split('T')[0];
            return value > todayStr;
        }

        function getStatusBadge(status) {
            if (status === 'present') return '<span class="badge bg-success">PRESENT</span>';
            if (status === 'late' || status === 'leave') return '<span class="badge bg-success">PRESENT</span>';
            if (status === 'absent') return '<span class="badge bg-danger">ABSENT</span>';
            return '<span class="badge bg-secondary">NOT MARKED</span>';
        }

        function normalizeStatusDisplay(status) {
            if (status === 'late' || status === 'leave') return 'present';
            return status || 'not marked';
        }

        function getTelData(mobile) {
            if (!mobile) return null;
            const raw = String(mobile).trim();
            const phone = raw.replace(/[^\d+]/g, '');
            if (!phone) return null;
            return { raw, phone };
        }

        function buildCallButtonHtml(studentId, mobile, source, label) {
            const tel = getTelData(mobile);
            if (!tel) return '<span class="text-muted">-</span>';
            const buttonLabel = escapeHtml(label || 'Call');
            return `
                <button
                    type="button"
                    class="btn btn-sm btn-outline-primary"
                    data-student-id="${escapeHtml(studentId)}"
                    data-phone="${escapeHtml(tel.phone)}"
                    data-source="${escapeHtml(source || 'unknown')}"
                    onclick="callAndLogStudent(this)"
                    title="Call ${escapeHtml(tel.raw)}"
                >
                    <i class="bi bi-telephone"></i> ${buttonLabel}
                </button>
            `;
        }

        async function callAndLogStudent(buttonEl) {
            if (!buttonEl) return;
            const studentId = buttonEl.dataset.studentId;
            const phone = buttonEl.dataset.phone;
            const source = buttonEl.dataset.source || 'unknown';

            if (!phone) return;

            buttonEl.disabled = true;
            try {
                await fetch('/api/attendance/contact-log', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ studentId, phone, source })
                });
            } catch (error) {
                console.error('‚ùå Error logging contact:', error);
            } finally {
                buttonEl.disabled = false;
                window.location.href = `tel:${phone}`;
            }
        }

        function buildWhatsAppLink(message) {
            return `https://wa.me/?text=${encodeURIComponent(message)}`;
        }

        function buildWhatsAppDirectLink(phone, message) {
            return `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
        }

        function escapeHtml(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function normalizePhone(value) {
            return String(value || '').replace(/[^\d]/g, '');
        }

        function phoneMatchesQuery(mobileValue, qRaw, qPhone) {
            if (!qRaw) return true;
            const mobileRaw = String(mobileValue || '').toLowerCase();
            if (mobileRaw.includes(qRaw)) return true;
            if (!qPhone) return false;
            const mobileDigits = normalizePhone(mobileRaw);
            if (!mobileDigits) return false;
            const qNoZero = qPhone.replace(/^0+/, '');
            const mobileNoZero = mobileDigits.replace(/^0+/, '');
            if (mobileDigits.includes(qPhone) || mobileDigits.includes(qNoZero)) return true;
            if (qPhone.includes(mobileDigits) || qNoZero.includes(mobileNoZero)) return true;
            if (qNoZero.length >= 10 && mobileNoZero.endsWith(qNoZero.slice(-10))) return true;
            if (mobileNoZero.length >= 10 && qNoZero.endsWith(mobileNoZero.slice(-10))) return true;
            return false;
        }

        function closeModal(id) {
            const modal = bootstrap.Modal.getInstance(document.getElementById(id));
            if (modal) modal.hide();
        }

        async function viewStudentProfile(studentId) {
            const contentEl = document.getElementById('studentProfileContent');
            if (contentEl) contentEl.innerHTML = 'Loading...';
            new bootstrap.Modal(document.getElementById('studentProfileModal')).show();

            try {
                const res = await fetch(`/api/students/profile/${studentId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) {
                    const data = await res.json().catch(() => ({}));
                    throw new Error(data.message || 'Failed to load profile');
                }
                const data = await res.json();
                const s = data.student;
                const attendance = data.attendance || {};
                const marks = data.marks || [];

                    const attendanceRows = (attendance.records || []).map(r => {
                        const historyCount = Array.isArray(r.history) ? r.history.length : 0;
                        const lastEdit = historyCount > 0 ? r.history[historyCount - 1] : null;
                        const editText = historyCount > 0
                            ? `Edited ${historyCount}x${lastEdit?.markedAt ? ' (last ' + formatDateTime(lastEdit.markedAt) + ')' : ''}${lastEdit?.markedByName ? ' by ' + lastEdit.markedByName : ''}`
                            : '‚Äî';
                        const statusLabel = normalizeStatusDisplay(r.status);
                    return `
                        <tr>
                            <td>${r.date}</td>
                            <td>${statusLabel}</td>
                            <td>${r.markedByName || '-'}</td>
                            <td>${r.markedAt ? formatDateTime(r.markedAt) : '-'}</td>
                            <td>${editText}</td>
                        </tr>
                    `;
                }).join('');

                const marksRows = marks.map(m => `
                    <tr>
                        <td>${m.date}</td>
                        <td>${m.totalObtained || 0}/${m.totalMarks || 0}</td>
                        <td>${m.percentage || 0}%</td>
                        <td>${m.markedByName || '-'}</td>
                    </tr>
                `).join('');

                const html = `
                    <div class="mb-3">
                        <h6>${s.name}</h6>
                        <div class="text-muted">${s.schoolName || '-'} | ${s.region || '-'} | Batch: ${s.batchNumber || '-'}</div>
                        <div>Standard: ${s.standard || '-'} | Mobile: ${s.mobile || '-'} | Age: ${s.age || '-'}</div>
                        <div>Status: ${s.isActive ? 'Active' : 'Inactive'}</div>
                    </div>
                    <div class="mb-3">
                        <strong>Attendance Summary:</strong>
                        Present: ${attendance.presentCount || 0} |
                        Absent: ${attendance.absentCount || 0} |
                        Total Marked: ${attendance.totalMarked || 0}
                    </div>
                    <div class="mb-3">
                        <h6>Recent Attendance</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Marked By</th>
                                        <th>Last Updated</th>
                                        <th>Edit History</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${attendanceRows || '<tr><td colspan="4">No records</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h6>Recent Exams</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Score</th>
                                        <th>%</th>
                                        <th>Marked By</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${marksRows || '<tr><td colspan="4">No records</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                if (contentEl) contentEl.innerHTML = html;
            } catch (error) {
                if (contentEl) contentEl.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        }

        // Initialize
        loadStats();
        loadInactiveNames();
        loadRegions();
        loadSummaryRegions();
        updateFilterUI();
    </script>
</body>
</html>









